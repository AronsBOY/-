<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡å¸‚æ¯”çˆ¾å¼· v4.6 AIæ——è‰¦ç‰ˆ</title>
    
    <!-- App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#facc15">
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. è¼‰å…¥ Markdown è§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 6. Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { overscroll-behavior-y: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        
        /* è‚¡å¸‚èƒŒæ™¯æ·ºå½± (Body) */
        .bg-kline-pattern {
            background-color: #facc15;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 50v-10h2v10h-2zm0 20v-10h2v10h-2zm10-30v-15h2v15h-2zm0 25v-15h2v15h-2zm10 10v-20h2v20h-2zm0-30v-10h2v10h-2zm10 20v-25h2v25h-2zm0 15v-5h2v5h-2zm10-40v-10h2v10h-2zm0 45v-25h2v25h-2zm10-15v-10h2v10h-2zm0 20v-5h2v5h-2zm10-40v-5h2v5h-2zm0 35v-20h2v20h-2z' fill='%23ffffff' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* é ‚éƒ¨è¶£å‘³èƒŒæ™¯ */
        .header-fun-pattern {
            background-color: #fbbf24;
            background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(255,255,255,0.2) 0%, transparent 20%),
                              url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
    </style>
</head>
<body class="bg-kline-pattern select-none text-slate-800">
    <div id="root"></div>

    <!-- ç”¨æ–¼ Gemini AI -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==================================================================================
        // ğŸ”´ æˆ°æƒ…å®¤æŒ‡ä»¤ï¼šæ‚¨çš„ Firebase è¨­å®šå·²æ¤å…¥ï¼
        // ==================================================================================
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBHZCCTR2pcISXTcFlKAQw-qCuss3tuVn4",
            authDomain: "billjohnloveu.firebaseapp.com",
            projectId: "billjohnloveu",
            storageBucket: "billjohnloveu.firebasestorage.app",
            messagingSenderId: "785959737628",
            appId: "1:785959737628:web:9cf63b00db322dd6ce82d9",
            measurementId: "G-QQ1HVNYMRS"
        };

        // --- Firebase åˆå§‹åŒ– ---
        const rawConfig = window.__firebase_config;
        let activeConfig = MANUAL_FIREBASE_CONFIG;
        
        // å¦‚æœç¶²é ç’°å¢ƒæœ‰æä¾› config (ä¾‹å¦‚åœ¨ Canvas é è¦½)ï¼Œä¸”æ²’æœ‰æ‰‹å‹•è¨­å®šï¼Œæ‰ä½¿ç”¨é è¨­
        if (!activeConfig && rawConfig) {
             try { activeConfig = JSON.parse(rawConfig); } catch(e){}
        }

        let app, auth, db, appId;
        let isFirebaseAvailable = false;

        if (activeConfig) {
            try {
                app = initializeApp(activeConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
                // å¦‚æœæ˜¯æ‰‹å‹•è¨­å®šï¼ŒprojectId å°±æ˜¯ appId çš„ä¸€éƒ¨åˆ†æˆ–ç›´æ¥ä½¿ç”¨
                if (!window.__app_id && activeConfig.projectId) appId = activeConfig.projectId;
                
                isFirebaseAvailable = true;
                console.log("âœ… Firebase é€£ç·šæˆåŠŸï¼ŒApp ID:", appId);
            } catch (e) {
                console.warn("âš ï¸ Firebase åˆå§‹åŒ–å¤±æ•—ï¼Œå°‡ä½¿ç”¨å–®æ©Ÿæ¨¡å¼ã€‚", e);
            }
        } else {
            console.log("â„¹ï¸ æœªæª¢æ¸¬åˆ° Firebase Configï¼Œå•Ÿå‹•å–®æ©Ÿæ¨¡å¼ (è³‡æ–™åƒ…å­˜æ–¼æœ¬æ©Ÿ LocalStorage)");
        }

        const { useState, useMemo, useEffect, useRef } = React;

        // --- Helper: Icon ---
        const Icon = ({ name, size = 24, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const k = name.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
                    setIconNode(window.lucide.icons[k] || window.lucide.icons[Object.keys(window.lucide.icons).find(key => key.toLowerCase() === k.toLowerCase())] || window.lucide.icons.Circle);
                }
            }, [name]);
            if (!iconNode) return <span className={className} style={{width:size, height:size}} />;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // --- Helper: Image Tools ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300; 
                        const maxHeight = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const fileToGenerativePart = async (file) => {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        };

        // --- å¼·åŠ› JSON è§£æå™¨ ---
        const cleanAndParseJSON = (text) => {
            try { return JSON.parse(text); } 
            catch (e) {
                try {
                    let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleaned);
                } catch (e2) {
                    try {
                        const match = cleaned.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
                        if (match) return JSON.parse(match[0]);
                    } catch (e3) { return null; }
                }
            }
        };

        // --- æœ¬åœ°æ–‡å­—è§£æå¼•æ“ ---
        const parseTextLocally = (text, mode) => {
            const lines = text.split('\n');
            if (mode === 'prices') {
                const result = {};
                let currentCode = null;
                lines.forEach(line => {
                    const codeMatch = line.match(/[\(ï¼ˆ](\d{4})[\)ï¼‰]/);
                    if (codeMatch) currentCode = codeMatch[1];
                    const priceMatch = line.match(/è‚¡åƒ¹[:ï¼š]\s*([\d.]+)/);
                    if (currentCode && priceMatch) {
                        result[currentCode] = parseFloat(priceMatch[1]);
                        currentCode = null;
                    }
                });
                // Fallback for simple format
                if (Object.keys(result).length === 0) {
                    lines.forEach(line => {
                        const parts = line.trim().split(/\s+/);
                        if (parts.length >= 2) {
                            const code = parts.find(p => /^\d{4}$/.test(p));
                            const price = parts.find(p => !isNaN(parseFloat(p)) && p !== code);
                            if (code && price) result[code] = parseFloat(price);
                        }
                    });
                }
                return Object.keys(result).length > 0 ? result : null;
            } else if (mode === 'transactions') {
                const result = [];
                const todayStr = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                lines.forEach(line => {
                    const codeMatch = line.match(/(.*?)[(ï¼ˆ](\d{4})[)ï¼‰](.*)/);
                    if (codeMatch) {
                        const rawName = codeMatch[1].trim().replace(/^[^a-zA-Z\u4e00-\u9fa5]+/, '');
                        const code = codeMatch[2];
                        const content = codeMatch[3];
                        let type = 'Buy', qty = 1000;
                        if (content.includes('è³£') || content.includes('å‡º') || content.includes('çµ')) type = 'Sell';
                        if (content.includes('å‰µæ–°é«˜') || content.includes('çºŒæŠ±') || content.includes('å…±è¥„ç››èˆ‰') || content.includes('æŒæœ‰')) qty = 0;
                        let price = 0;
                        const priceMatch = content.match(/(\d+(?:\.\d+)?)(?:[-~](\d+(?:\.\d+)?))?/);
                        if (priceMatch) {
                            price = priceMatch[2] ? (parseFloat(priceMatch[1]) + parseFloat(priceMatch[2])) / 2 : parseFloat(priceMatch[1]);
                        }
                        result.push({ date: todayStr, code: code, name: rawName, type: type, price: price, qty: qty, note: line.trim() });
                    }
                });
                return result.length > 0 ? result : null;
            }
            return null;
        };

        // --- å¡ç‰‡ä¸»é¡ŒåŠ©æ‰‹ ---
        const getMarketStyle = (market) => {
            switch (market) {
                case 'ä¸Šå¸‚': return { badge: 'bg-blue-600 text-white', border: 'border-blue-600', text: 'text-blue-700', bg: 'bg-blue-50' };
                case 'ä¸Šæ«ƒ': return { badge: 'bg-emerald-600 text-white', border: 'border-emerald-600', text: 'text-emerald-700', bg: 'bg-emerald-50' };
                case 'èˆˆæ«ƒ': return { badge: 'bg-rose-500 text-white', border: 'border-rose-500', text: 'text-rose-700', bg: 'bg-rose-50' };
                default: return { badge: 'bg-slate-600 text-white', border: 'border-slate-600', text: 'text-slate-700', bg: 'bg-slate-50' };
            }
        };

        const INITIAL_CAPITAL = 5000000;
        const INITIAL_META_DATA = {
            '8358': { market: 'ä¸Šæ«ƒ', industry: 'é›»å­é›¶çµ„ä»¶', highlight: 'éŠ…ç®”åŸºæ¿éœ€æ±‚å¼·å‹ï¼Œä¼ºæœå™¨å‡ç´šå—æƒ ã€‚', thoughts: 'éŠ…ç®”åŸºæ¿éœ€æ±‚å¼·å‹ï¼ŒAIä¼ºæœå™¨å¸¶å‹•é«˜éšç”¢å“å‡ºè²¨ã€‚' },
            '3081': { market: 'ä¸Šæ«ƒ', industry: 'é€šä¿¡ç¶²è·¯', highlight: 'å…‰é€šè¨Šç£Šæ™¶ç‰‡é ˜å…ˆè€…ï¼ŒçŸ½å…‰å­é¡Œæã€‚', thoughts: 'çŸ½å…‰å­ç‚ºæœªä¾†è¶¨å‹¢ï¼ŒæŒçºŒçœ‹å¥½é•·ç·šç™¼å±•ã€‚' },
            '5284': { market: 'ä¸Šå¸‚', industry: 'èˆªå¤ªå·¥æ¥­', highlight: 'ä¼ºæœå™¨æ©Ÿæ®¼èˆ‡èˆªå¤ªé›¶çµ„ä»¶ï¼Œæ¥­ç¸¾å‰µé«˜ã€‚', thoughts: 'èˆªå¤ªå¾©ç”¦èˆ‡ä¼ºæœå™¨é›™å¼•æ“ï¼Œç‡Ÿæ”¶å¯æœŸã€‚' },
            '2360': { market: 'ä¸Šå¸‚', industry: 'å…¶ä»–é›»å­', highlight: 'ç²¾å¯†é‡æ¸¬å„€å™¨é¾é ­ï¼ŒåŠå°é«”æ¸¬è©¦éœ€æ±‚å¢ã€‚', thoughts: 'å…ˆé€²å°è£æª¢æ¸¬éœ€æ±‚å¤§å¢ï¼Œé¾é ­åœ°ä½ç©©å›ºã€‚' },
            '4722': { market: 'ä¸Šæ«ƒ', industry: 'åŒ–å­¸å·¥æ¥­', highlight: 'å…‰å›ºåŒ–ææ–™é¾é ­ï¼ŒCoWoS é—œéµåŒ–å­¸å“ä¾›æ‡‰å•†ã€‚', thoughts: 'åˆ‡å…¥CoWoSä¾›æ‡‰éˆï¼Œè©•åƒ¹æœ‰é‡ä¼°ç©ºé–“ã€‚' },
            '8996': { market: 'ä¸Šå¸‚', industry: 'é›»æ©Ÿæ©Ÿæ¢°', highlight: 'ç†±ç®¡ç†å°ˆå®¶ï¼Œæ¶²å†·æ•£ç†±åˆ‡å…¥è³‡æ–™ä¸­å¿ƒã€‚', thoughts: 'æ¶²å†·æ•£ç†±æ˜¯AIä¼ºæœå™¨æ¨™é…ï¼Œç‡Ÿæ”¶çˆ†ç™¼ã€‚' },
            '4931': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'é‹°é›»æ± æ¨¡çµ„ï¼ŒBBU å‚™æ´é›»æ± éœ€æ±‚çˆ†ç™¼ã€‚', thoughts: 'BBUéœ€æ±‚å› AIä¼ºæœå™¨è€Œèµ·ï¼ŒçŸ­ç·šå‹•èƒ½å¼·ã€‚' },
            '7853': { market: 'èˆˆæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'åŠå°é«” AOI æª¢æ¸¬è¨­å‚™ï¼Œå…ˆé€²å°è£éœ€æ±‚ã€‚', thoughts: 'èˆˆæ«ƒæ½›åŠ›è‚¡ï¼Œå—æƒ å…ˆé€²å°è£æ“´ç”¢ã€‚' },
            '7828': { market: 'èˆˆæ«ƒ', industry: 'è»Ÿé«”æœå‹™', highlight: 'æ•¸ä½è½‰å‹é›²ç«¯æœå‹™å•†ï¼Œè³‡å®‰éœ€æ±‚å¼·å‹ã€‚', thoughts: 'æ•¸ä½è½‰å‹è¶¨å‹¢ä¸è®Šï¼Œè³‡å®‰ç‚ºå‰›æ€§éœ€æ±‚ã€‚' },
            '3017': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'æ•£ç†±æ¨¡çµ„å¤§å» ï¼ŒAI ä¼ºæœå™¨æ•£ç†±è§£æ±ºæ–¹æ¡ˆã€‚', thoughts: '3D VCèˆ‡æ°´å†·æ¿å‡ºè²¨é †æš¢ï¼Œç²åˆ©å„ªæ–¼é æœŸã€‚' },
            '3324': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'æ•£ç†±è§£æ±ºæ–¹æ¡ˆï¼Œæ°´å†·æ¿å‡ºè²¨æ”¾é‡ã€‚', thoughts: 'æ°´å†·æ¿å¸‚ä½”ç‡é«˜ï¼Œç‚ºä¸»è¦å—æƒ è€…ã€‚' },
            '4971': { market: 'ä¸Šæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'MBE ç ·åŒ–éµç£Šæ™¶å…¨çƒé¾é ­ï¼Œåœ‹é˜²èˆ‡èˆªå¤ªéœ€æ±‚ã€‚', thoughts: 'åœ‹é˜²è¨‚å–®ç©©å®šï¼ŒåŠ ä¸Šè¡›æ˜Ÿé€šè¨Šéœ€æ±‚ã€‚' },
            '6788': { market: 'ä¸Šæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'æ™¶åœ“ä»£å·¥ AMC è¨­å‚™ä¾›æ‡‰å•†ï¼Œå…ˆé€²è£½ç¨‹æ“´ç”¢ã€‚', thoughts: 'éš¨è‘—æ™¶åœ“å» æ“´å» ï¼Œå¾®æ±¡æŸ“é˜²æ²»éœ€æ±‚å¢ã€‚' },
            '7751': { market: 'èˆˆæ«ƒ', industry: 'åŠå°é«”è¨­å‚™', highlight: 'å…ˆé€²å°è£æª¢æ¸¬ï¼ŒCoWoS è¨‚å–®èƒ½è¦‹åº¦é«˜ã€‚', thoughts: 'CoWoSæ“´ç”¢è¨­å‚™äº¤æœŸé•·ï¼Œè¨‚å–®æ»¿æ‰‹ã€‚' },
            '3189': { market: 'ä¸Šå¸‚', industry: 'åŠå°é«”æ¥­', highlight: 'ABF è¼‰æ¿å¾©ç”¦ï¼ŒHPC èˆ‡ AI æ™¶ç‰‡éœ€æ±‚å¼·ã€‚', thoughts: 'ABFè¼‰æ¿ç”¢æ¥­è½åº•å›å‡ï¼ŒAIæ™¶ç‰‡éœ€æ±‚å¸¶å‹•ã€‚' },
        };
        
        const INITIAL_PRICES = { 
            '8358': 260.0, '3081': 618.0, '5284': 270.5, '2360': 856.0, 
            '4722': 168.0, '8996': 577.0, '4931': 173.0, '7853': 113.5, 
            '7828': 530.0, '3017': 1380.0, '3324': 0.0, '4971': 292.5, 
            '6788': 338.5, '7751': 838.0, '3189': 175.5 
        };

        const INITIAL_TRANSACTIONS = [
            { id: 101, date: '2025/10/28', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 224, qty: 1000, note: '' },
            { id: 102, date: '2025/10/29', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 228, qty: 1000, note: '' },
            { id: 103, date: '2025/11/04', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 231.5, qty: 1000, note: '' },
            { id: 104, date: '2025/11/13', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 229, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘åƒ¹æ ¼æš«ä¼°' }, 
            { id: 105, date: '2025/11/18', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 227, qty: 1000, note: '' },
            { id: 106, date: '2025/12/02', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 230, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 107, date: '2025/12/03', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 232, qty: 1000, note: '' },
            { id: 108, date: '2025/12/10', code: '8358', name: 'é‡‘å±…', type: 'Sell', price: 246.5, qty: 3500, note: 'è³£å‡ºä¸€åŠ' },
            { id: 109, date: '2025/12/22', code: '8358', name: 'é‡‘å±…', type: 'Sell', price: 260, qty: 3500, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 201, date: '2025/10/30', code: '3081', name: 'è¯äº', type: 'Buy', price: 433.5, qty: 1000, note: '' },
            { id: 202, date: '2025/10/31', code: '3081', name: 'è¯äº', type: 'Buy', price: 433.5, qty: 1000, note: '' },
            { id: 203, date: '2025/11/18', code: '3081', name: 'è¯äº', type: 'Buy', price: 447, qty: 1000, note: '' },
            { id: 204, date: '2025/12/17', code: '3081', name: 'è¯äº', type: 'Sell', price: 602, qty: 1500, note: 'è³£å‡ºä¸€åŠ (ä¿®æ­£åƒ¹)' },
            { id: 205, date: '2026/01/05', code: '3081', name: 'è¯äº', type: 'Sell', price: 618, qty: 1500, note: 'è³£å‡ºå…¨æ•¸ (ä¿®æ­£åƒ¹)' },
            { id: 301, date: '2025/11/07', code: '5284', name: 'JPP-KY', type: 'Buy', price: 296.5, qty: 1000, note: '' },
            { id: 302, date: '2025/11/13', code: '5284', name: 'JPP-KY', type: 'Buy', price: 0, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘éœ€è£œåƒ¹' },
            { id: 303, date: '2025/11/18', code: '5284', name: 'JPP-KY', type: 'Buy', price: 282, qty: 1000, note: '' },
            { id: 304, date: '2025/11/26', code: '5284', name: 'JPP-KY', type: 'Buy', price: 290, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 305, date: '2025/11/28', code: '5284', name: 'JPP-KY', type: 'Buy', price: 285, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 306, date: '2025/12/02', code: '5284', name: 'JPP-KY', type: 'Buy', price: 310, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 307, date: '2025/12/03', code: '5284', name: 'JPP-KY', type: 'Buy', price: 306, qty: 1000, note: '' },
            { id: 308, date: '2025/12/15', code: '5284', name: 'JPP-KY', type: 'Buy', price: 298, qty: 1000, note: '' },
            { id: 309, date: '2025/12/17', code: '5284', name: 'JPP-KY', type: 'Buy', price: 300, qty: 1000, note: '' },
            { id: 310, date: '2025/12/22', code: '5284', name: 'JPP-KY', type: 'Buy', price: 290, qty: 1000, note: '' },
            { id: 311, date: '2025/12/24', code: '5284', name: 'JPP-KY', type: 'Buy', price: 285, qty: 1000, note: '' },
            { id: 312, date: '2026/01/12', code: '5284', name: 'JPP-KY', type: 'Sell', price: 270.5, qty: 11000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 401, date: '2025/11/02', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 776.5, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 402, date: '2025/11/17', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 785, qty: 1000, note: '' },
            { id: 403, date: '2025/11/28', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 814, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 404, date: '2025/12/15', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 765, qty: 1000, note: '' },
            { id: 405, date: '2026/01/05', code: '2360', name: 'è‡´èŒ‚', type: 'Sell', price: 856, qty: 4000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 501, date: '2025/12/15', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 188.5, qty: 1000, note: '' },
            { id: 502, date: '2025/12/16', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 185, qty: 1000, note: '' },
            { id: 503, date: '2025/12/17', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 182, qty: 1000, note: '' },
            { id: 504, date: '2025/12/19', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 164, qty: 1000, note: '' },
            { id: 505, date: '2025/12/24', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 175, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 506, date: '2025/12/26', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 168, qty: 1000, note: '' },
            { id: 507, date: '2026/01/13', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 168, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 601, date: '2025/12/23', code: '8996', name: 'é«˜åŠ›', type: 'Buy', price: 545, qty: 1000, note: '' },
            { id: 602, date: '2026/01/07', code: '8996', name: 'é«˜åŠ›', type: 'Sell', price: 577, qty: 1000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 701, date: '2025/12/29', code: '4931', name: 'æ–°ç››åŠ›', type: 'Buy', price: 178, qty: 1000, note: '' },
            { id: 702, date: '2026/01/06', code: '4931', name: 'æ–°ç››åŠ›', type: 'Buy', price: 175, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 703, date: '2026/01/08', code: '4931', name: 'æ–°ç››åŠ›', type: 'Sell', price: 173, qty: 2000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 801, date: '2026/01/02', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 802, date: '2026/01/05', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 803, date: '2026/01/06', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 804, date: '2026/01/12', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Sell', price: 113.5, qty: 3000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 901, date: '2026/01/05', code: '7828', name: 'å‰µæ–°æœå‹™', type: 'Buy', price: 540, qty: 1000, note: '' },
            { id: 902, date: '2026/01/08', code: '7828', name: 'å‰µæ–°æœå‹™', type: 'Sell', price: 530, qty: 1000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 1001, date: '2026/01/07', code: '3017', name: 'å¥‡é‹', type: 'Buy', price: 1350, qty: 1000, note: '' },
            { id: 1002, date: '2026/01/08', code: '3017', name: 'å¥‡é‹', type: 'Buy', price: 1350, qty: 1000, note: '' },
            { id: 1003, date: '2026/01/14', code: '3017', name: 'å¥‡é‹', type: 'Buy', price: 1360, qty: 1000, note: 'åƒ¹æ ¼å–ä¸­é–“å€¼' },
            { id: 1004, date: '2026/01/15', code: '3017', name: 'å¥‡é‹', type: 'Sell', price: 1380, qty: 3000, note: 'è³£å‡ºå…¨æ•¸' },
            { id: 1101, date: '2026/01/07', code: '3324', name: 'é›™é´»', type: 'Buy', price: 0, qty: 1000, note: 'ã€éœ€è£œåƒ¹ã€‘' },
            { id: 1102, date: '2026/01/08', code: '3324', name: 'é›™é´»', type: 'Buy', price: 0, qty: 1000, note: 'ã€éœ€è£œåƒ¹ã€‘' },
            { id: 1103, date: '2026/01/15', code: '3324', name: 'é›™é´»', type: 'Sell', price: 0, qty: 2000, note: 'ã€éœ€è£œåƒ¹ã€‘è³£å‡ºå…¨æ•¸' },
            { id: 1201, date: '2026/01/12', code: '4971', name: 'IET-KY', type: 'Buy', price: 309, qty: 1000, note: '' },
            { id: 1202, date: '2026/01/13', code: '4971', name: 'IET-KY', type: 'Buy', price: 295, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 1203, date: '2026/01/13', code: '4971', name: 'IET-KY', type: 'Buy', price: 292.5, qty: 1000, note: '' },
            { id: 1301, date: '2026/01/12', code: '6788', name: 'è¯æ™¯é›»', type: 'Buy', price: 353.5, qty: 1000, note: '' },
            { id: 1302, date: '2026/01/13', code: '6788', name: 'è¯æ™¯é›»', type: 'Buy', price: 340, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 1303, date: '2026/01/13', code: '6788', name: 'è¯æ™¯é›»', type: 'Buy', price: 338.5, qty: 1000, note: '' },
            { id: 1401, date: '2026/01/09', code: '7751', name: 'ç«‘é¨°', type: 'Buy', price: 722, qty: 1000, note: '' },
            { id: 1402, date: '2026/01/15', code: '7751', name: 'ç«‘é¨°', type: 'Buy', price: 838, qty: 1000, note: '' },
            { id: 1501, date: '2026/01/15', code: '3189', name: 'æ™¯ç¢©', type: 'Buy', price: 175.5, qty: 1000, note: '' },
        ];

        const formatNumber = (val) => new Intl.NumberFormat('zh-TW').format(Math.round(val));
        const formatMoney = (val) => `$${formatNumber(val)}`;
        const formatDecimal = (val) => val.toFixed(2);
        const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
        const getColor = (val) => val > 0 ? 'text-red-600' : val < 0 ? 'text-green-600' : 'text-slate-900';
        const getPriceColor = (current, cost) => current > cost ? 'text-red-600' : current < cost ? 'text-green-600' : 'text-slate-800';

        // --- Smart Input Modal (Replacing AIGeminiModal) ---
        const SmartInputModal = ({ onClose, onAnalyze, apiKey, setApiKey }) => {
            const [mode, setMode] = useState('transactions'); 
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [textInput, setTextInput] = useState('');
            const fileInputRef = useRef(null);

            const handleAnalyze = async () => {
                if (!textInput.trim() && !fileInputRef.current?.files?.[0]) {
                    alert("è«‹è²¼ä¸Šæ–‡å­—æŒ‡ä»¤æˆ–ä¸Šå‚³åœ–ç‰‡");
                    return;
                }

                setIsAnalyzing(true);

                // 1. å„ªå…ˆå˜—è©¦æœ¬åœ°æ–‡å­—è§£æ (ä¸éœ€ API)
                if (textInput.trim()) {
                    const localResult = parseTextLocally(textInput, mode);
                    if (localResult) {
                        onAnalyze(localResult, mode);
                        onClose();
                        alert(`âœ… æ–‡å­—åˆ†ææˆåŠŸï¼(æœ¬åœ°æ¨¡å¼)`);
                        setIsAnalyzing(false);
                        return;
                    }
                }

                // 2. å¦‚æœæœ¬åœ°è§£æå¤±æ•—æˆ–æœ‰åœ–ç‰‡ï¼Œæ‰å˜—è©¦ä½¿ç”¨ Gemini API
                if (!apiKey) {
                    alert("âš ï¸ ç„¡æ³•è­˜åˆ¥æ–‡å­—æ ¼å¼ï¼Œæˆ–æ‚¨ä¸Šå‚³äº†åœ–ç‰‡ã€‚\nè‹¥è¦ä½¿ç”¨é€²éš AI åˆ†æ(å«åœ–ç‰‡)ï¼Œè«‹è¼¸å…¥ Gemini API Keyã€‚");
                    setIsAnalyzing(false);
                    return;
                }

                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    
                    let prompt = "";
                    let content = [];

                    if (mode === 'transactions') {
                        prompt = `ä½ æ˜¯ä¸€å€‹è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ã€‚è«‹åˆ†æä»¥ä¸‹å…§å®¹(æ–‡å­—æˆ–åœ–ç‰‡)ã€‚
                        æå–äº¤æ˜“è³‡è¨Šï¼šdate(YYYY/MM/DD, è‹¥ç„¡å¹´ä»½è«‹ç”¨ ${new Date().getFullYear()}, è‹¥ç„¡æ—¥æœŸè«‹ç”¨ä»Šæ—¥), code, name, type(Buy/Sell), price(æ•¸å€¼), qty(æ•¸å€¼, é è¨­1000), note(ä¿ç•™å®Œæ•´æŒ‡ä»¤å…§å®¹, è‹¥æœ‰'æ–°æœƒå“¡'å­—æ¨£è«‹æ¨™è¨»)ã€‚
                        ç‰¹æ®Šè¦å‰‡ï¼š
                        1. è‹¥æŒ‡ä»¤ç‚ºã€Œå¿ƒå¾—åˆ†äº«ã€æˆ–ã€Œçœ‹æ³•ã€è€Œç„¡æ˜ç¢ºè²·è³£å‹•ä½œï¼ˆå¦‚"å‰µæ–°é«˜", "ç²åˆ©ä¸éŒ¯", "çºŒæŠ±", "å…±è¥„ç››èˆ‰"ï¼‰ï¼Œè«‹å»ºç«‹ä¸€ç­† qty: 0 çš„ Buy äº¤æ˜“ï¼Œä¸¦å°‡å…§å®¹å®Œæ•´æ”¾å…¥ noteã€‚
                        2. è‹¥æŒ‡ä»¤åŒ…å« "åŠ ç¢¼", "è²·é€²", "å»ºå€‰" -> type: Buyã€‚
                        3. è‹¥æŒ‡ä»¤åŒ…å« "è³£å‡º", "ç²åˆ©äº†çµ", "èª¿ç¯€" -> type: Sellã€‚
                        è«‹å›å‚³ JSON Arrayã€‚åªå›å‚³JSONï¼Œä¸è¦Markdownã€‚
                        ${textInput ? 'æ–‡å­—å…§å®¹ï¼š\n' + textInput : ''}`;
                    } else {
                        prompt = `è«‹è¾¨è­˜å…§å®¹ä¸­çš„è‚¡ç¥¨æ¸…å–®èˆ‡æœ€æ–°åƒ¹æ ¼(æ”¶ç›¤åƒ¹)ã€‚å›å‚³ JSON Objectã€‚Keyç‚ºä»£è™Ÿï¼ŒValueç‚ºåƒ¹æ ¼ã€‚ç¯„ä¾‹ï¼š{"2330": 1050, "2317": 200}ã€‚åªå›å‚³JSONã€‚
                        ${textInput ? 'æ–‡å­—å…§å®¹ï¼š\n' + textInput : ''}`;
                    }

                    content.push(prompt);
                    
                    if (fileInputRef.current?.files?.[0]) {
                        const imagePart = await fileToGenerativePart(fileInputRef.current.files[0]);
                        content.push(imagePart);
                    }

                    const result = await model.generateContent(content);
                    const response = await result.response;
                    const text = response.text();
                    const data = cleanAndParseJSON(text);
                    
                    if (data) {
                        onAnalyze(data, mode);
                        onClose();
                        alert("âœ… AI åˆ†æå®Œæˆï¼");
                    } else {
                        alert("âŒ AI ç„¡æ³•è§£æè³‡æ–™ï¼Œè«‹ç¢ºèªæ ¼å¼ã€‚");
                    }
                } catch (error) {
                    console.error("AI Error:", error);
                    alert("âŒ åˆ†æå¤±æ•—ï¼š" + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl p-6 relative flex flex-col max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                        <h2 className="text-xl font-bold flex items-center gap-2 mb-4 text-slate-800"><Icon name="bot" className="text-orange-600"/> æ™ºæ…§åŠ©ç† (æ–‡å­—/AI)</h2>
                        
                        <div className="space-y-4 overflow-y-auto pr-2">
                            {/* API Key Input (Optional hint) */}
                            <div className="relative">
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Gemini API Key (ç´”æ–‡å­—æ¨¡å¼å¯ä¸å¡«)" className="w-full border rounded p-2 text-sm bg-slate-50"/>
                                <span className="absolute right-2 top-2 text-[10px] text-slate-400 bg-white px-1">é¸å¡«</span>
                            </div>
                            
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setMode('transactions')} className={`flex-1 py-2 text-sm font-bold rounded transition-all ${mode==='transactions'?'bg-white shadow text-blue-600':'text-slate-500'}`}>è¾¨è­˜äº¤æ˜“/æŒ‡ä»¤</button>
                                <button onClick={() => setMode('prices')} className={`flex-1 py-2 text-sm font-bold rounded transition-all ${mode==='prices'?'bg-white shadow text-blue-600':'text-slate-500'}`}>æ›´æ–°è‚¡åƒ¹</button>
                            </div>

                            <div className="space-y-3 pt-2">
                                <textarea 
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                    placeholder={mode === 'transactions' ? "åœ¨æ­¤è²¼ä¸Šè€å¸«çš„æŒ‡ä»¤...\nä¾‹å¦‚ï¼š\n[è‘‰å®‡ä¹˜-é€²éšçµ„:]\nå—èŒ‚(8150) æ˜¨å¤©çš„69-70é™„è¿‘ï¼Œå¯ä»¥åŠ ç¢¼..." : "åœ¨æ­¤è²¼ä¸Šè‚¡åƒ¹åˆ—è¡¨...\nä¾‹å¦‚ï¼š\n1ï¸âƒ£ æ™¯ç¢©ï¼ˆ3189ï¼‰\nè‚¡åƒ¹ï¼š206.0"}
                                    className="w-full h-48 border rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none bg-slate-50"
                                ></textarea>
                            </div>

                            <div className="relative flex py-2 items-center">
                                <div className="flex-grow border-t border-slate-200"></div>
                                <span className="flex-shrink-0 mx-4 text-slate-400 text-xs">æˆ–æ˜¯ (éœ€è¦ API Key)</span>
                                <div className="flex-grow border-t border-slate-200"></div>
                            </div>

                            <button onClick={() => fileInputRef.current.click()} className="w-full border-2 border-dashed border-slate-300 hover:border-purple-500 hover:bg-purple-50 text-slate-500 py-3 rounded-xl flex items-center justify-center gap-2 transition-all text-sm">
                                <Icon name="image" size={16}/> ä¸Šå‚³æˆªåœ–åˆ†æ
                            </button>
                            <input type="file" ref={fileInputRef} accept="image/*" className="hidden" />

                            <button onClick={handleAnalyze} disabled={isAnalyzing} className="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mt-4 transition-all">
                                {isAnalyzing ? 'åˆ†æä¸­...' : <><Icon name="zap"/> é–‹å§‹åˆ†æ</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Settings Modal ---
        const CloudSettingsModal = ({ onClose, onConnect, currentRoom, apiKey, setApiKey }) => {
            const [roomName, setRoomName] = useState(currentRoom || "default");
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">ç³»çµ±è¨­å®š</h2><button onClick={onClose}><Icon name="x"/></button></div>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-bold mb-1">åŒæ­¥æˆ¿é–“åç¨±</label><input type="text" value={roomName} onChange={(e)=>setRoomName(e.target.value)} className="w-full border rounded p-2"/></div>
                            <div><label className="block text-sm font-bold mb-1">Gemini API Key</label><input type="password" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} className="w-full border rounded p-2"/></div>
                            <button onClick={()=>{onConnect(roomName); onClose();}} className="w-full bg-blue-600 text-white font-bold py-2 rounded">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Simple Holdings Modal ---
        const SimpleHoldingsModal = ({ holdings, onClose }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                <div className="bg-white rounded-2xl w-full max-w-4xl shadow-2xl p-6 relative max-h-[90vh] flex flex-col">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="table" className="text-orange-600"/> ç°¡æ˜“æŒè‚¡è¡¨</h2>
                    <div className="overflow-auto flex-1">
                        <table className="w-full text-left border-collapse min-w-[500px]">
                            <thead className="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th className="p-4 rounded-tl-lg font-bold">ç·¨è™Ÿ</th>
                                    <th className="p-4 font-bold">è‚¡å¸‚ä»£è™Ÿ</th>
                                    <th className="p-4 font-bold">è‚¡å¸‚åç¨±</th>
                                    <th className="p-4 text-right font-bold">è²·å…¥å‡åƒ¹</th>
                                    <th className="p-4 text-right rounded-tr-lg font-bold">å¼µæ•¸åŠè‚¡æ•¸</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-slate-800">
                                {holdings.map((stock, index) => {
                                    const marketStyle = getMarketStyle(stock.meta.market);
                                    return (
                                        <tr key={stock.code} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 font-bold text-slate-500">{index + 1}</td>
                                            <td className="p-4 font-mono font-bold text-lg">{stock.code}</td>
                                            <td className="p-4 font-bold text-xl">{stock.name}</td>
                                            <td className="p-4 text-right font-mono font-bold text-lg">{formatDecimal(stock.displayAvgCost)}</td>
                                            <td className="p-4 text-right">
                                                <span className="font-bold text-xl">{Math.floor(stock.inventory / 1000)}</span> <span className="text-sm text-slate-500 mr-2">å¼µ</span>
                                                {stock.inventory % 1000 > 0 && <span className="text-slate-500 font-mono">({stock.inventory % 1000} è‚¡)</span>}
                                            </td>
                                        </tr>
                                    );
                                })}
                                {holdings.length === 0 && <tr><td colSpan="5" className="p-12 text-center text-slate-400 text-lg font-bold">ç›®å‰ç„¡æŒè‚¡ï¼Œè«‹å»ºç«‹å€‰ä½ï¼</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // --- Edit Modal ---
        const EditTransactionModal = ({ transaction, onSave, onCancel }) => {
            const [formData, setFormData] = useState(transaction);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({...prev, [name]: (name==='price'||name==='qty')?parseFloat(value):value})); };
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">ç·¨è¼¯äº¤æ˜“</h3>
                        <div className="space-y-3">
                            <div><label className="text-xs">æ—¥æœŸ</label><input name="date" value={formData.date} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">ä»£è™Ÿ</label><input name="code" value={formData.code} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                                <div className="flex-1"><label className="text-xs">åç¨±</label><input name="name" value={formData.name} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">è²·è³£</label><select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div>
                                <div className="flex-1"><label className="text-xs">åƒ¹æ ¼</label><input type="number" name="price" value={formData.price} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div><label className="text-xs">è‚¡æ•¸</label><input type="number" name="qty" value={formData.qty} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div><label className="text-xs">å‚™è¨»</label><input name="note" value={formData.note} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                        </div>
                        <div className="mt-6 flex justify-end gap-2"><button onClick={onCancel} className="px-4 py-2 border rounded">å–æ¶ˆ</button><button onClick={()=>onSave(formData)} className="px-4 py-2 bg-blue-600 text-white rounded">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const StockBillStrong = () => {
            const [activeTab, setActiveTab] = useState('holdings'); 
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
            const [prices, setPrices] = useState(INITIAL_PRICES);
            const [userAvatar, setUserAvatar] = useState(null);
            const [geminiApiKey, setGeminiApiKey] = useState("AIzaSyDVIFDMODO28W2hW3Cfv7egUyO4LApzR50");
            const [syncRoom, setSyncRoom] = useState("default");
            const [isSyncing, setIsSyncing] = useState(false); 
            const [showCloudSettings, setShowCloudSettings] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showSimpleTable, setShowSimpleTable] = useState(false); 
            const [editingId, setEditingId] = useState(null);
            const [selectedStockCode, setSelectedStockCode] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const initAuth = async () => {
                    if (isFirebaseAvailable) {
                        try {
                            // ä¿®æ­£é‚è¼¯ï¼šå¦‚æœä½¿ç”¨çš„æ˜¯æ‰‹å‹•è¨­å®šçš„ Config (MANUAL_FIREBASE_CONFIG)ï¼Œ
                            // å‰‡ä¸æ‡‰è©²ä½¿ç”¨ Canvas ç’°å¢ƒæä¾›çš„ __initial_auth_token (å› ç‚ºé‚£æ˜¯çµ¦é è¨­å°ˆæ¡ˆç”¨çš„)
                            const usingManualConfig = activeConfig === MANUAL_FIREBASE_CONFIG;
                            
                            if (!usingManualConfig && window.__initial_auth_token) {
                                await signInWithCustomToken(auth, window.__initial_auth_token);
                            } else {
                                await signInAnonymously(auth);
                            }
                            
                            onAuthStateChanged(auth, setUser);
                        } catch (error) {
                            console.error("Firebase Auth Error:", error);
                            let errorMsg = "é›²ç«¯é€£ç·šå¤±æ•—ï¼Œåˆ‡æ›è‡³å–®æ©Ÿæ¨¡å¼ã€‚";
                            if (error.code === 'auth/operation-not-allowed') {
                                errorMsg = "âš ï¸ è«‹è‡³ Firebase Console é–‹å•Ÿã€ŒåŒ¿åç™»å…¥ (Anonymous Auth)ã€åŠŸèƒ½ï¼Œå¦å‰‡ç„¡æ³•åŒæ­¥ã€‚";
                            } else if (error.code === 'auth/configuration-not-found') {
                                errorMsg = "âš ï¸ Firebase è¨­å®šéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Console çš„ Authentication è¨­å®šã€‚";
                            }
                            alert(errorMsg);
                            // Fallback
                            setUser({ uid: 'local-user' });
                        }
                    } else {
                        setUser({ uid: 'local-user' });
                    }
                };
                initAuth();
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const savedKey = localStorage.getItem('stock_bill_gemini_key');
                if (savedKey) setGeminiApiKey(savedKey); 
                const savedRoom = localStorage.getItem('stock_bill_fb_room');
                if (savedRoom) { setSyncRoom(savedRoom); setIsSyncing(true); }
                const savedAvatar = localStorage.getItem('stock_bill_avatar');
                if (savedAvatar) setUserAvatar(savedAvatar); // è‡ªå‹•è¼‰å…¥å¤§é ­è²¼

                if (!isFirebaseAvailable) {
                    const localTx = localStorage.getItem('stock_bill_transactions');
                    if(localTx) setTransactions(JSON.parse(localTx));
                    const localPrices = localStorage.getItem('stock_bill_prices');
                    if(localPrices) setPrices(JSON.parse(localPrices));
                }
            }, []);

            useEffect(() => { if(geminiApiKey) localStorage.setItem('stock_bill_gemini_key', geminiApiKey); }, [geminiApiKey]);

            // Avatar Upload & Save Logic
            const handleAvatarUpload = async (e) => {
                const f = e.target.files[0];
                if(f) {
                    const base64 = await compressImage(f);
                    setUserAvatar(base64);
                    localStorage.setItem('stock_bill_avatar', base64); // æ°¸ä¹…å„²å­˜
                }
            };

            // Sync Logic
            useEffect(() => {
                if (!user || !syncRoom || !isFirebaseAvailable) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.transactions) setTransactions(JSON.parse(data.transactions));
                        if (data.prices) setPrices(JSON.parse(data.prices));
                    } else if (isSyncing) {
                        setDoc(docRef, { transactions: JSON.stringify(transactions), prices: JSON.stringify(prices) }, { merge: true });
                    }
                });
                return () => unsubscribe();
            }, [user, syncRoom, isSyncing]);

            useEffect(() => {
                if (!user) return;
                if (isFirebaseAvailable && isSyncing) {
                    const saveData = async () => {
                        try {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                            await setDoc(docRef, { transactions: JSON.stringify(transactions), prices: JSON.stringify(prices) }, { merge: true });
                        } catch(e) { console.error(e); }
                    };
                    const t = setTimeout(saveData, 1000);
                    return () => clearTimeout(t);
                }
                localStorage.setItem('stock_bill_transactions', JSON.stringify(transactions));
                localStorage.setItem('stock_bill_prices', JSON.stringify(prices));
            }, [transactions, prices, user, isSyncing, syncRoom]);

            const handleAIResult = (data, mode) => {
                if (mode === 'transactions') {
                    if (Array.isArray(data) && data.length > 0) {
                        const newTx = data.map(t => ({ ...t, id: Date.now() + Math.random() }));
                        setTransactions(prev => [...prev, ...newTx]);
                    } else { alert("AI æœªèƒ½è¾¨è­˜å‡ºäº¤æ˜“ï¼Œè«‹ç¢ºèªåœ–ç‰‡æ ¼å¼"); }
                } else {
                    if(typeof data === 'object') {
                        setPrices(prev => ({ ...prev, ...data }));
                    } else { alert("AI æœªèƒ½è¾¨è­˜å‡ºè‚¡åƒ¹"); }
                }
            };

            const portfolio = useMemo(() => {
                const holdingsMap = {};
                const realizedMap = {};
                let realizedPL = 0;
                const sortedTrans = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTrans.forEach(t => {
                    if (!holdingsMap[t.code]) holdingsMap[t.code] = { 
                        code: t.code, name: t.name, inventory: 0, totalCost: 0, avgCost: 0, history: [], 
                        callSignalCount: 0, newMemberCount: 0, 
                        callSignalBuyCost: 0, callSignalBuyQty: 0,
                        latestThought: null
                    };
                    if (!realizedMap[t.code]) realizedMap[t.code] = { code: t.code, name: t.name, totalPL: 0, trades: [] };
                    
                    const stock = holdingsMap[t.code];
                    stock.history.push(t);
                    realizedMap[t.code].trades.push(t);
                    const qty = t.qty || 1000;
                    
                    if (t.note && t.note.length > 2 && t.note !== 'ã€æ–°æœƒå“¡ã€‘') {
                        stock.latestThought = { date: t.date, content: t.note };
                    }

                    if (t.type === 'Buy') {
                        if (t.note && t.note.includes('æ–°æœƒå“¡')) {
                            stock.newMemberCount += 1;
                        } else {
                            stock.callSignalCount += 1;
                            stock.callSignalBuyCost += t.price * qty;
                            stock.callSignalBuyQty += qty;
                            stock.totalCost += t.price * qty;
                            stock.inventory += qty;
                            stock.avgCost = stock.inventory > 0 ? stock.totalCost / stock.inventory : 0;
                        }
                    } else {
                        if (stock.inventory > 0) {
                            const sellQty = Math.min(stock.inventory, qty); 
                            const profit = (t.price - stock.avgCost) * sellQty;
                            realizedPL += profit;
                            realizedMap[t.code].totalPL += profit;
                            stock.totalCost -= stock.avgCost * sellQty;
                            stock.inventory -= sellQty;
                        }
                    }
                });

                const holdings = Object.values(holdingsMap).filter(h => h.inventory > 0 || h.newMemberCount > 0 || h.callSignalCount > 0).map(h => {
                    const currentPrice = prices[h.code] || h.avgCost;
                    const marketValue = currentPrice * h.inventory;
                    const unrealizedPL = (currentPrice - h.avgCost) * h.inventory;
                    const displayAvgCost = h.callSignalBuyQty > 0 ? (h.callSignalBuyCost / h.callSignalBuyQty) : 0;
                    const fundPercentage = (marketValue / INITIAL_CAPITAL) * 100;
                    const roi = h.avgCost > 0 ? ((currentPrice - h.avgCost) / h.avgCost) * 100 : 0; 

                    const meta = INITIAL_META_DATA[h.code] || { market: 'ä¸Šå¸‚', industry: 'æœªåˆ†é¡', thoughts: '' };
                    if (h.latestThought) {
                        meta.thoughts = `${h.latestThought.content} (${h.latestThought.date})`;
                    }

                    return { ...h, currentPrice, marketValue, unrealizedPL, displayAvgCost, fundPercentage, meta, roi };
                }).filter(h => h.inventory > 0); 

                const realizedStocks = Object.values(realizedMap).filter(r => holdingsMap[r.code].inventory === 0 && r.totalPL !== 0); 
                const totalMarketValue = holdings.reduce((sum, h) => sum + h.marketValue, 0);
                const totalUnrealizedPL = holdings.reduce((sum, h) => sum + h.unrealizedPL, 0);
                const totalEquity = INITIAL_CAPITAL + realizedPL + totalUnrealizedPL;
                const cash = totalEquity - totalMarketValue;
                const usageRate = totalEquity > 0 ? totalMarketValue / totalEquity : 0;
                return { holdings, realizedStocks, realizedPL, totalUnrealizedPL, totalEquity, totalMarketValue, usageRate, cash };
            }, [transactions, prices]);

            return (
                <div className="min-h-screen font-sans text-slate-900 pb-10 relative">
                    {editingId && <EditTransactionModal transaction={transactions.find(t => t.id === editingId)} onSave={(updatedTx) => {setTransactions(prev => prev.map(t => t.id === updatedTx.id ? updatedTx : t)); setEditingId(null);}} onCancel={() => setEditingId(null)} />}
                    {showCloudSettings && <CloudSettingsModal onClose={() => setShowCloudSettings(false)} onConnect={(room)=>{setSyncRoom(room);setIsSyncing(true);localStorage.setItem('stock_bill_fb_room',room);}} currentRoom={syncRoom} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {showAIModal && <SmartInputModal onClose={() => setShowAIModal(false)} onAnalyze={handleAIResult} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {showSimpleTable && <SimpleHoldingsModal holdings={portfolio.holdings} onClose={() => setShowSimpleTable(false)} />}

                    <header className="bg-yellow-400 shadow-xl border-b-4 border-orange-500 sticky top-0 z-40 header-fun-pattern">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center relative z-10 gap-4">
                            <div className="flex items-center gap-4">
                                <label className="relative cursor-pointer group flex-shrink-0 z-50" title="é»æ“Šæ›´æ›é ­è²¼ (è‡ªå‹•å„²å­˜)">
                                    <div className="w-16 h-16 rounded-full border-4 border-orange-500 bg-white overflow-hidden shadow-xl flex items-center justify-center">
                                        {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <Icon name="user" size={40} className="text-slate-300" />}
                                    </div>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleAvatarUpload} />
                                </label>
                                <div>
                                    <h1 className="text-6xl md:text-7xl font-extrabold text-blue-800 tracking-wide ml-8 drop-shadow-2xl" style={{ textShadow: '4px 4px 0px #fff' }}>è‚¡å¸‚æ¯”çˆ¾å¼·</h1>
                                    <p className="text-lg font-bold text-white tracking-widest ml-9 mt-1 drop-shadow-md">ç”¢æ¥­è¶¨å‹¢æŒ–æ˜è€…</p>
                                    <p className="text-sm font-bold bg-orange-600 text-white inline-block px-2 transform -skew-x-12 mt-2 ml-9">v4.6.1 AI æ——è‰¦ç‰ˆ</p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                                <div className="text-right text-slate-800 font-bold bg-white/40 backdrop-blur px-3 py-1 rounded-lg border border-slate-800/20 shadow-sm">
                                    ç”¨500è¬å¾2025/10/28æ—¥é–‹å§‹æ¨¡æ“¬æ“ä½œ
                                </div>
                                <div className="text-right text-orange-900 font-bold font-mono">
                                    <div className="text-xl">{currentTime.toLocaleTimeString()}</div>
                                    <div className="text-xs">{currentTime.toLocaleDateString()}</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSimpleTable(true)} className="bg-orange-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white flex items-center gap-1 hover:bg-orange-700 transition-colors"><Icon name="table" size={14}/> ç°¡æ˜“æŒè‚¡è¡¨</button>
                                    <button onClick={() => setShowAIModal(true)} className="bg-purple-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white/50 flex items-center gap-1 hover:bg-purple-700 transition-colors"><Icon name="bot" size={14}/> æ™ºæ…§åŠ©ç†</button>
                                    <button onClick={() => setShowCloudSettings(true)} className={`font-bold text-xs px-3 py-2 rounded flex items-center gap-1 shadow-md text-white ${isSyncing?'bg-green-600':'bg-slate-400'}`}><Icon name="settings" size={14}/> {isSyncing ? syncRoom : 'è¨­å®š'}</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        <section className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-5 text-slate-800 shadow-lg border-4 border-yellow-300 relative overflow-hidden">
                                <Icon name="wallet" size={80} className="absolute -right-4 -top-4 opacity-10 text-orange-600"/>
                                <p className="text-slate-500 text-xs font-bold uppercase mb-1">ç¸½è³‡ç”¢</p>
                                <h2 className="text-3xl font-black text-slate-900 mb-2">{formatMoney(portfolio.totalMarketValue)}</h2>
                                <div className="flex justify-between items-end border-t border-yellow-300 pt-2">
                                    <div><p className="text-slate-500 text-xs font-bold">ç¾é‡‘</p><span className="font-mono font-bold text-slate-700">{formatMoney(portfolio.cash)}</span></div>
                                    <div className="text-right"><span className="text-xs text-slate-500 block">æ°´ä½</span><span className="text-xl font-bold text-orange-600">{formatPercent(portfolio.usageRate)}</span></div>
                                </div>
                            </div>
                            
                            {/* å„ªåŒ–å¾Œçš„ä¸»ç•«é¢æç›Šå¡ç‰‡ï¼šæ·ºé»ƒåº• (Yellow-50) */}
                            <div className="md:col-span-2 bg-yellow-50 rounded-2xl p-6 shadow-xl flex items-center justify-around border-4 border-slate-200">
                                <div className="text-center w-1/2 border-r-2 border-slate-100 pr-4">
                                    <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wide">æœªå¯¦ç¾æç›Š</p>
                                    <div className={`text-3xl font-black tracking-tight ${getColor(portfolio.totalUnrealizedPL)}`}>
                                        {portfolio.totalUnrealizedPL > 0 ? '+' : ''}{formatMoney(portfolio.totalUnrealizedPL)}
                                    </div>
                                </div>
                                <div className="text-center w-1/2 pl-4">
                                    <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wide">å·²å¯¦ç¾æç›Š</p>
                                    <div className={`text-3xl font-black tracking-tight ${getColor(portfolio.realizedPL)}`}>
                                        {portfolio.realizedPL > 0 ? '+' : ''}{formatMoney(portfolio.realizedPL)}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-yellow-200 flex flex-col justify-center gap-2">
                                <div className="text-purple-600 font-bold flex items-center gap-2"><Icon name="bot" size={16}/> æ™ºæ…§åŠ©ç†</div>
                                <p className="text-xs text-slate-500">é»æ“Šå³ä¸Šè§’æŒ‰éˆ•ï¼Œè²¼ä¸Šå ±åƒ¹æˆ–æŒ‡ä»¤ï¼Œç§’é€Ÿåˆ†æã€‚</p>
                            </div>
                        </section>

                        <div className="bg-yellow-50/80 backdrop-blur-sm rounded-3xl p-6 shadow-xl border-2 border-yellow-200 min-h-[500px]">
                            <div className="flex gap-4 mb-6 border-b-2 border-yellow-200 pb-2 overflow-x-auto">
                                {[{id:'holdings',label:'æŒæœ‰åº«å­˜',icon:'briefcase'},{id:'timeline',label:'äº¤æ˜“ç´€éŒ„',icon:'history'},{id:'realized',label:'å·²çµç®—',icon:'check'}].map(tab=>(
                                    <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold transition-all whitespace-nowrap ${activeTab===tab.id?'bg-orange-600 text-white shadow-lg':'bg-white text-slate-500 hover:bg-yellow-100'}`}><Icon name={tab.icon} size={18}/> {tab.label}</button>
                                ))}
                            </div>

                            {activeTab === 'holdings' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {portfolio.holdings.map((stock, i) => {
                                        const marketStyle = getMarketStyle(stock.meta.market);
                                        return (
                                        <div key={stock.code} onClick={()=>setSelectedStockCode(selectedStockCode===stock.code?null:stock.code)} className="bg-white rounded-2xl shadow-xl border border-slate-100 hover:shadow-2xl transition-all cursor-pointer overflow-hidden flex flex-col group relative">
                                            
                                            {/* Top Banner (Ticker Style) */}
                                            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white relative z-10">
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded shadow-sm ${marketStyle.badge}`}>{stock.meta.market}</span>
                                                        <span className="font-mono text-slate-400 text-xs font-bold">{stock.code}</span>
                                                        {/* ä¸€éµçœ‹ç›¤é€£çµ */}
                                                        <a 
                                                            href={`https://www.cmoney.tw/forum/stock/${stock.code}`} 
                                                            target="_blank" 
                                                            onClick={(e) => e.stopPropagation()} 
                                                            className="text-gray-300 hover:text-blue-500 transition-colors ml-1"
                                                            title="é–‹å•Ÿç±Œç¢¼Kç·š"
                                                        >
                                                            <Icon name="external-link" size={14} />
                                                        </a>
                                                    </div>
                                                    <div className="font-black text-2xl text-slate-800 tracking-tight mt-1">{stock.name}</div>
                                                </div>
                                                
                                                {/* Price Display (Red/Green) */}
                                                <div className="text-right" title="é»æ“Šä¿®æ”¹æ”¶ç›¤åƒ¹" onClick={(e)=>{e.stopPropagation(); const p=prompt('è¼¸å…¥æ–°æ”¶ç›¤åƒ¹',stock.currentPrice); if(p) setPrices(prev=>({...prev,[stock.code]:parseFloat(p)}));}}>
                                                    <div className="text-[10px] text-slate-400 mb-0.5 flex items-center justify-end gap-1">æ”¶ç›¤åƒ¹ <span className="font-mono">{currentTime.toLocaleDateString()}</span></div>
                                                    <div className={`text-3xl font-black font-mono leading-none ${getPriceColor(stock.currentPrice, stock.avgCost)}`}>
                                                        {stock.currentPrice}
                                                    </div>
                                                    <div className={`text-xs font-bold mt-1 ${getColor(stock.roi)}`}>
                                                        {stock.roi > 0 ? 'â–²' : stock.roi < 0 ? 'â–¼' : ''} {Math.abs(stock.roi).toFixed(2)}%
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Middle Stats Grid */}
                                            <div className="p-4 bg-slate-50/50">
                                                <div className="grid grid-cols-2 gap-y-3 gap-x-4 text-sm">
                                                    <div>
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">æ‘³è¨Šå‡åƒ¹</span>
                                                        <span className="font-bold text-lg text-slate-700 font-mono">{formatDecimal(stock.displayAvgCost)}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">åº«å­˜</span>
                                                        <span className="font-bold text-lg text-slate-800">{Math.floor(stock.inventory/1000)}<span className="text-xs text-slate-500">å¼µ</span> <span className="text-xs text-slate-400 font-mono">({stock.inventory})</span></span>
                                                    </div>
                                                    <div>
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">è³‡é‡‘éƒ¨ä½</span>
                                                        <div className="flex items-center gap-2">
                                                            <div className="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
                                                                <div className="h-full bg-blue-500 rounded-full" style={{width: `${Math.min(stock.fundPercentage, 100)}%`}}></div>
                                                            </div>
                                                            <span className="font-bold text-xs text-slate-600 font-mono">{Math.round(stock.fundPercentage)}%</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">æœªå¯¦ç¾æç›Š</span>
                                                        <span className={`font-black text-lg font-mono ${getColor(stock.unrealizedPL)}`}>{stock.unrealizedPL > 0 ? '+' : ''}{formatNumber(stock.unrealizedPL)}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bottom Notes */}
                                            <div className="p-4 space-y-2 border-t border-slate-100 bg-white">
                                                <div className="flex gap-2 text-[10px]">
                                                    <span className="bg-orange-100 text-orange-700 px-2 py-1 rounded font-bold">æ‘³è¨Š {stock.callSignalCount}</span>
                                                    <span className="bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">æ–°æœƒå“¡ {stock.newMemberCount}</span>
                                                </div>
                                                <p className="text-xs text-slate-600 line-clamp-2 leading-relaxed">
                                                    <span className="font-bold text-orange-500">äº®é»ï¼š</span>{stock.meta.highlight}
                                                </p>
                                                {stock.meta.thoughts && (
                                                    <div className="text-xs text-slate-500 italic bg-slate-50 p-2 rounded border border-slate-100 mt-2">
                                                        <span className="font-bold not-italic text-slate-400 mr-1">ç­†è¨˜:</span> {stock.meta.thoughts}
                                                    </div>
                                                )}
                                            </div>
                                        </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* æ˜ç´°å€å¡Š (ç•¶ activeTab ç‚º holdings ä¸”æœ‰é»é¸æ™‚é¡¯ç¤º) */}
                            {activeTab === 'holdings' && selectedStockCode && (
                                <div className="mt-8 bg-white rounded-xl shadow-2xl border-2 border-orange-500 overflow-hidden animate-fade-in relative z-50">
                                    <div className="bg-orange-500 px-6 py-3 font-bold text-white flex justify-between items-center">
                                        <span className="text-lg flex items-center gap-2"><Icon name="list" size={20}/> {portfolio.holdings.find(s => s.code === selectedStockCode)?.name} ({selectedStockCode}) äº¤æ˜“æ˜ç´°</span>
                                        <button onClick={() => setSelectedStockCode(null)} className="hover:bg-orange-600 p-1 rounded"><Icon name="x" size={20}/></button>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-orange-50 text-slate-500 font-bold border-b border-orange-200">
                                                <tr>
                                                    <th className="px-6 py-3">æ—¥æœŸ</th>
                                                    <th className="px-6 py-3">å‹•ä½œ</th>
                                                    <th className="px-6 py-3 text-right">æˆäº¤åƒ¹</th>
                                                    <th className="px-6 py-3 text-right">è‚¡æ•¸</th>
                                                    <th className="px-6 py-3 text-right">å‚™è¨»</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-orange-100">
                                                {portfolio.holdings.find(s => s.code === selectedStockCode)?.history
                                                    .filter(t => !t.note.includes('æ–°æœƒå“¡')) 
                                                    .map(t => (
                                                    <tr key={t.id} className="hover:bg-orange-50 transition-colors">
                                                        <td className="px-6 py-3 font-mono text-slate-600 font-medium">{t.date}</td>
                                                        <td className="px-6 py-3">
                                                            <span className={`px-2 py-1 rounded text-xs font-bold ${t.type === 'Buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                                {t.type === 'Buy' ? 'è²·å…¥' : 'è³£å‡º'}
                                                            </span>
                                                        </td>
                                                        <td className="px-6 py-3 text-right font-mono font-bold text-slate-700">{t.price}</td>
                                                        <td className="px-6 py-3 text-right font-mono text-slate-500">{t.qty}</td>
                                                        <td className="px-6 py-3 text-right text-slate-500 text-xs">{t.note}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {activeTab === 'timeline' && (
                                <div className="bg-white rounded-xl shadow border overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100 text-slate-500 uppercase"><tr><th className="px-4 py-3">æ—¥æœŸ</th><th className="px-4 py-3">åç¨±</th><th className="px-4 py-3">å‹•ä½œ</th><th className="px-4 py-3 text-right">åƒ¹æ ¼</th><th className="px-4 py-3 text-right">è‚¡æ•¸</th><th className="px-4 py-3">æ“ä½œ</th></tr></thead>
                                        <tbody>
                                            {[...transactions]
                                                .filter(t => !t.note.includes('æ–°æœƒå“¡')) 
                                                .sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => (
                                                <tr key={t.id} className="border-b hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-mono">{t.date}</td>
                                                    <td className="px-4 py-3 font-bold">{t.name} <span className="text-xs text-slate-400 font-normal">{t.code}</span></td>
                                                    <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs text-white ${t.type==='Buy'?'bg-red-500':'bg-green-500'}`}>{t.type}</span></td>
                                                    <td className="px-4 py-3 text-right font-mono font-bold">{t.price}</td>
                                                    <td className="px-4 py-3 text-right font-mono">{t.qty}</td>
                                                    <td className="px-4 py-3"><button onClick={()=>setEditingId(t.id)} className="text-blue-600 hover:underline"><Icon name="edit-2" size={14}/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            
                            {activeTab === 'realized' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {portfolio.realizedStocks.map(stock => (
                                        <div key={stock.code} className="bg-white rounded-xl shadow p-4 border flex justify-between items-center">
                                            <div><h3 className="font-bold text-lg">{stock.name}</h3><div className="text-xs text-slate-400">å·²æ¸…å€‰</div></div>
                                            <div className={`text-2xl font-bold font-mono ${getColor(stock.totalPL)}`}>{stock.totalPL>0?'+':''}{formatMoney(stock.totalPL)}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockBillStrong />);
    </script>
</body>
</html>
