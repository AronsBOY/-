<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>股市比爾強 v3.1 AI旗艦版</title>
    
    <!-- App 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#facc15">
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. 載入 Markdown 解析 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { overscroll-behavior-y: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        
        /* 錯誤提示遮罩 */
        #local-file-error { display: none; }
    </style>
</head>
<body class="bg-yellow-400 select-none text-slate-800">
    <div id="root"></div>

    <!-- 本地檔案開啟錯誤提示 -->
    <div id="local-file-error" class="fixed inset-0 z-[100] bg-black/90 text-white flex flex-col items-center justify-center p-8 text-center">
        <h2 class="text-3xl font-bold text-red-500 mb-4">⚠️ 無法直接執行</h2>
        <p class="mb-4 text-lg">瀏覽器安全性限制 (CORS) 禁止直接讀取 AI 與資料庫模組。</p>
        <p class="mb-6 text-gray-400">您目前的網址開頭是 <code>file://</code>，這會導致程式被瀏覽器攔截。</p>
        <div class="bg-gray-800 p-6 rounded-xl text-left space-y-2 max-w-md">
            <h3 class="font-bold text-yellow-400 mb-2">解決方法：</h3>
            <p>1. 使用 VS Code 安裝 <strong>Live Server</strong> 套件。</p>
            <p>2. 右鍵點擊此 HTML 檔案，選擇 <strong>Open with Live Server</strong>。</p>
            <p>3. 或者將檔案上傳至 GitHub Pages / Vercel 等空間。</p>
        </div>
        <button onclick="document.getElementById('local-file-error').style.display='none'" class="mt-8 px-6 py-2 border border-white/30 rounded-full hover:bg-white/10">暫時關閉提示 (程式可能無法運作)</button>
    </div>

    <script>
        // 檢測是否為 file:// 協議
        if (window.location.protocol === 'file:') {
            document.getElementById('local-file-error').style.display = 'flex';
        }
    </script>

    <!-- 用於 Gemini AI -->
    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- Firebase 初始化 ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

        const { useState, useMemo, useEffect, useRef } = React;

        // --- Helper: Icon ---
        const Icon = ({ name, size = 24, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const k = name.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
                    setIconNode(window.lucide.icons[k] || window.lucide.icons[Object.keys(window.lucide.icons).find(key => key.toLowerCase() === k.toLowerCase())] || window.lucide.icons.Circle);
                }
            }, [name]);
            if (!iconNode) return <span className={className} style={{width:size, height:size}} />;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // --- Helper: Image Tools ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300; 
                        const maxHeight = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const fileToGenerativePart = async (file) => {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        };

        // --- 初始資料 ---
        const INITIAL_CAPITAL = 5000000;
        const INITIAL_META_DATA = {
            '8358': { market: '上櫃', industry: '電子零組件', highlight: '銅箔基板需求強勁，伺服器升級受惠。' },
            '3081': { market: '上櫃', industry: '通信網路', highlight: '光通訊磊晶片領先者，矽光子題材。' },
            '5284': { market: '上市', industry: '航太工業', highlight: '伺服器機殼與航太零組件，業績創高。' },
            '2360': { market: '上市', industry: '其他電子', highlight: '精密量測儀器龍頭，半導體測試需求增。' },
            '4722': { market: '上櫃', industry: '化學工業', highlight: '光固化材料龍頭，CoWoS 關鍵化學品供應商。' },
            '8996': { market: '上市', industry: '電機機械', highlight: '熱管理專家，液冷散熱切入資料中心。' },
            '4931': { market: '上市', industry: '電腦周邊', highlight: '鋰電池模組，BBU 備援電池需求爆發。' },
            '7853': { market: '興櫃', industry: '半導體業', highlight: '半導體 AOI 檢測設備，先進封裝需求。' },
            '7828': { market: '興櫃', industry: '軟體服務', highlight: '數位轉型雲端服務商，資安需求強勁。' },
            '3017': { market: '上市', industry: '電腦周邊', highlight: '散熱模組大廠，AI 伺服器散熱解決方案。' },
            '3324': { market: '上市', industry: '電腦周邊', highlight: '散熱解決方案，水冷板出貨放量。' },
            '4971': { market: '上櫃', industry: '半導體業', highlight: 'MBE 砷化鎵磊晶全球龍頭，國防與航太需求。' },
            '6788': { market: '上櫃', industry: '半導體業', highlight: '晶圓代工 AMC 設備供應商，先進製程擴產。' },
            '7751': { market: '興櫃', industry: '半導體設備', highlight: '先進封裝檢測，CoWoS 訂單能見度高。' },
            '3189': { market: '上市', industry: '半導體業', highlight: 'ABF 載板復甦，HPC 與 AI 晶片需求強。' },
        };
        const INITIAL_PRICES = { '8358': 260.0, '3081': 618.0, '5284': 270.5, '2360': 856.0, '4722': 165.0, '8996': 577.0, '4931': 173.0, '7853': 113.5, '7828': 530.0, '3017': 1380.0, '3324': 710.0, '4971': 308.0, '6788': 350.0, '7751': 861.0, '3189': 192.5 };
        const INITIAL_TRANSACTIONS = [
             { id: 101, date: '2025/10/28', code: '8358', name: '金居', type: 'Buy', price: 224.0, qty: 1000, note: '建立持股' },
             { id: 201, date: '2025/10/30', code: '3081', name: '聯亞', type: 'Buy', price: 433.5, qty: 1000, note: '建立持股' },
             { id: 301, date: '2025/11/07', code: '5284', name: 'JPP-KY', type: 'Buy', price: 296.5, qty: 1000, note: '建立持股' },
             { id: 401, date: '2025/11/02', code: '2360', name: '致茂', type: 'Buy', price: 776.5, qty: 1000, note: '【新會員】建立持股' },
             { id: 501, date: '2025/12/15', code: '4722', name: '國精化', type: 'Buy', price: 188.5, qty: 1000, note: '建立持股' },
        ];

        const formatNumber = (val) => new Intl.NumberFormat('zh-TW').format(Math.round(val));
        const formatMoney = (val) => `$${formatNumber(val)}`;
        const formatDecimal = (val) => val.toFixed(2);
        const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
        const getColor = (val) => val > 0 ? 'text-red-600' : val < 0 ? 'text-green-600' : 'text-slate-900';

        // --- AI Modal ---
        const AIGeminiModal = ({ onClose, onAnalyze, apiKey, setApiKey }) => {
            const [mode, setMode] = useState('transactions'); 
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const fileInputRef = useRef(null);

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                if (!apiKey) { alert("請先輸入 Gemini API Key"); return; }
                setIsAnalyzing(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    const imagePart = await fileToGenerativePart(file);
                    
                    let prompt = "";
                    if (mode === 'transactions') {
                        prompt = `你是一個股票交易助手。請分析這張截圖中的股票交易紀錄。
                        請提取：date(YYYY/MM/DD), code, name, type(Buy/Sell), price(數值), qty(數值), note("AI識別")。
                        回傳純 JSON Array。範例：[{"date":"2025/01/01", "code":"2330", "name":"台積電", "type":"Buy", "price":1000, "qty":1000}]。不要 Markdown。`;
                    } else {
                        prompt = `請辨識截圖中的股票現價。Key為代號，Value為價格。
                        回傳純 JSON Object。範例：{"2330": 1050, "2317": 200}。不要 Markdown。`;
                    }

                    const result = await model.generateContent([prompt, imagePart]);
                    const response = await result.response;
                    const text = response.text().replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(text);
                    onAnalyze(data, mode);
                    onClose();
                    alert("✅ 分析完成！");
                } catch (error) {
                    console.error("AI Error:", error);
                    alert("❌ 分析失敗：" + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 relative">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                        <h2 className="text-xl font-bold flex items-center gap-2 mb-4"><Icon name="sparkles" className="text-purple-600"/> AI 智慧助理</h2>
                        <div className="space-y-4">
                            <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Gemini API Key" className="w-full border rounded p-2 text-sm"/>
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setMode('transactions')} className={`flex-1 py-2 text-sm font-bold rounded ${mode==='transactions'?'bg-white shadow':'text-slate-500'}`}>辨識交易</button>
                                <button onClick={() => setMode('prices')} className={`flex-1 py-2 text-sm font-bold rounded ${mode==='prices'?'bg-white shadow':'text-slate-500'}`}>更新股價</button>
                            </div>
                            <button onClick={() => fileInputRef.current.click()} disabled={isAnalyzing} className="w-full bg-slate-900 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2">
                                {isAnalyzing ? '分析中...' : <><Icon name="camera"/> 上傳截圖</>}
                            </button>
                            <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                        </div>
                    </div>
                </div>
            );
        };

        // --- Settings Modal ---
        const CloudSettingsModal = ({ onClose, onConnect, currentRoom, apiKey, setApiKey }) => {
            const [roomName, setRoomName] = useState(currentRoom || "default");
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6">
                        <div className="flex justify-between items-center mb-4"><h2 className="text-xl font-bold">系統設定</h2><button onClick={onClose}><Icon name="x"/></button></div>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-bold mb-1">同步房間名稱</label><input type="text" value={roomName} onChange={(e)=>setRoomName(e.target.value)} className="w-full border rounded p-2"/></div>
                            <div><label className="block text-sm font-bold mb-1">Gemini API Key</label><input type="password" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} className="w-full border rounded p-2"/></div>
                            <button onClick={()=>{onConnect(roomName); onClose();}} className="w-full bg-blue-600 text-white font-bold py-2 rounded">儲存設定</button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Simple Holdings Modal (New!) ---
        const SimpleHoldingsModal = ({ holdings, onClose }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                <div className="bg-white rounded-2xl w-full max-w-4xl shadow-2xl p-6 relative max-h-[90vh] flex flex-col">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="table" className="text-blue-600"/> 簡易持股表</h2>
                    <div className="overflow-auto flex-1">
                        <table className="w-full text-left border-collapse min-w-[500px]">
                            <thead className="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th className="p-4 rounded-tl-lg font-bold">編號</th>
                                    <th className="p-4 font-bold">股市代號</th>
                                    <th className="p-4 font-bold">股市名稱</th>
                                    <th className="p-4 text-right font-bold">買入均價</th>
                                    <th className="p-4 text-right rounded-tr-lg font-bold">張數及股數</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-slate-800">
                                {holdings.map((stock, index) => (
                                    <tr key={stock.code} className="hover:bg-blue-50 transition-colors">
                                        <td className="p-4 font-bold text-slate-500">{index + 1}</td>
                                        <td className="p-4 font-mono font-bold text-lg">{stock.code}</td>
                                        <td className="p-4 font-bold text-xl">{stock.name}</td>
                                        <td className="p-4 text-right font-mono font-bold text-lg">{formatDecimal(stock.avgCost)}</td>
                                        <td className="p-4 text-right">
                                            <span className="font-bold text-xl">{Math.floor(stock.inventory / 1000)}</span> <span className="text-sm text-slate-500 mr-2">張</span>
                                            {stock.inventory % 1000 > 0 && <span className="text-slate-500 font-mono">({stock.inventory % 1000} 股)</span>}
                                        </td>
                                    </tr>
                                ))}
                                {holdings.length === 0 && <tr><td colSpan="5" className="p-12 text-center text-slate-400 text-lg font-bold">目前無持股，請建立倉位！</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // --- Edit Modal ---
        const EditTransactionModal = ({ transaction, onSave, onCancel }) => {
            const [formData, setFormData] = useState(transaction);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({...prev, [name]: (name==='price'||name==='qty')?parseFloat(value):value})); };
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">編輯交易</h3>
                        <div className="space-y-3">
                            <div><label className="text-xs">日期</label><input name="date" value={formData.date} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">代號</label><input name="code" value={formData.code} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                                <div className="flex-1"><label className="text-xs">名稱</label><input name="name" value={formData.name} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">買賣</label><select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div>
                                <div className="flex-1"><label className="text-xs">價格</label><input type="number" name="price" value={formData.price} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div><label className="text-xs">股數</label><input type="number" name="qty" value={formData.qty} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div><label className="text-xs">備註</label><input name="note" value={formData.note} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                        </div>
                        <div className="mt-6 flex justify-end gap-2"><button onClick={onCancel} className="px-4 py-2 border rounded">取消</button><button onClick={()=>onSave(formData)} className="px-4 py-2 bg-blue-600 text-white rounded">儲存</button></div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const StockBillStrong = () => {
            const [activeTab, setActiveTab] = useState('holdings'); 
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
            const [prices, setPrices] = useState(INITIAL_PRICES);
            const [userAvatar, setUserAvatar] = useState(null);
            // Updated with User's requested API Key
            const [geminiApiKey, setGeminiApiKey] = useState("AIzaSyDVIFDMODO28W2hW3Cfv7egUyO4LApzR50");
            const [syncRoom, setSyncRoom] = useState("default");
            const [isSyncing, setIsSyncing] = useState(false); 
            const [showCloudSettings, setShowCloudSettings] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showSimpleTable, setShowSimpleTable] = useState(false); // New state for Simple Table
            const [editingId, setEditingId] = useState(null);
            const [selectedStockCode, setSelectedStockCode] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());

            useEffect(() => {
                const initAuth = async () => {
                    if (window.__initial_auth_token) await signInWithCustomToken(auth, window.__initial_auth_token);
                    else await signInAnonymously(auth);
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const savedKey = localStorage.getItem('stock_bill_gemini_key');
                if (savedKey) setGeminiApiKey(savedKey); // If local storage has one, it might overwrite the default, but user can reset it
                const savedRoom = localStorage.getItem('stock_bill_fb_room');
                if (savedRoom) { setSyncRoom(savedRoom); setIsSyncing(true); }
            }, []);

            useEffect(() => { if(geminiApiKey) localStorage.setItem('stock_bill_gemini_key', geminiApiKey); }, [geminiApiKey]);

            useEffect(() => {
                if (!user || !syncRoom) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.transactions) setTransactions(JSON.parse(data.transactions));
                        if (data.prices) setPrices(JSON.parse(data.prices));
                        if (data.userAvatar) setUserAvatar(data.userAvatar);
                        setIsSyncing(true);
                    } else if (isSyncing) {
                        setDoc(docRef, { transactions: JSON.stringify(transactions), prices: JSON.stringify(prices), userAvatar: userAvatar||"" }, { merge: true });
                    }
                });
                return () => unsubscribe();
            }, [user, syncRoom, isSyncing]);

            useEffect(() => {
                if (!user) return;
                if (!isSyncing) return;
                const saveData = async () => {
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                        await setDoc(docRef, { transactions: JSON.stringify(transactions), prices: JSON.stringify(prices), userAvatar: userAvatar||"" }, { merge: true });
                    } catch(e) { console.error(e); }
                };
                const t = setTimeout(saveData, 1000);
                return () => clearTimeout(t);
            }, [transactions, prices, userAvatar, user, isSyncing, syncRoom]);

            const handleAIResult = (data, mode) => {
                if (mode === 'transactions') {
                    if (Array.isArray(data) && data.length > 0) {
                        const newTx = data.map(t => ({ ...t, id: Date.now() + Math.random() }));
                        setTransactions(prev => [...prev, ...newTx]);
                    }
                } else {
                    setPrices(prev => ({ ...prev, ...data }));
                }
            };

            const portfolio = useMemo(() => {
                const holdingsMap = {};
                const realizedMap = {};
                let realizedPL = 0;
                const sortedTrans = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTrans.forEach(t => {
                    if (!holdingsMap[t.code]) holdingsMap[t.code] = { code: t.code, name: t.name, inventory: 0, totalCost: 0, avgCost: 0, history: [], callSignalCount: 0 };
                    if (!realizedMap[t.code]) realizedMap[t.code] = { code: t.code, name: t.name, totalPL: 0, trades: [] };
                    const stock = holdingsMap[t.code];
                    stock.history.push(t);
                    realizedMap[t.code].trades.push(t);
                    const qty = t.qty || 1000;
                    if (t.type === 'Buy') {
                        stock.totalCost += t.price * qty;
                        stock.inventory += qty;
                        stock.avgCost = stock.inventory > 0 ? stock.totalCost / stock.inventory : 0;
                        stock.callSignalCount += 1;
                    } else {
                        if (stock.inventory > 0) {
                            const sellQty = Math.min(stock.inventory, qty);
                            const profit = (t.price - stock.avgCost) * sellQty;
                            realizedPL += profit;
                            realizedMap[t.code].totalPL += profit;
                            stock.totalCost -= stock.avgCost * sellQty;
                            stock.inventory -= sellQty;
                        }
                    }
                });
                const holdings = Object.values(holdingsMap).filter(h => h.inventory > 0).map(h => {
                    const currentPrice = prices[h.code] || h.avgCost;
                    const marketValue = currentPrice * h.inventory;
                    const unrealizedPL = (currentPrice - h.avgCost) * h.inventory;
                    return { ...h, currentPrice, marketValue, unrealizedPL, meta: INITIAL_META_DATA[h.code] || {} };
                });
                const realizedStocks = Object.values(realizedMap).filter(r => holdingsMap[r.code].inventory === 0 && r.trades.length > 0);
                const totalMarketValue = holdings.reduce((sum, h) => sum + h.marketValue, 0);
                const totalUnrealizedPL = holdings.reduce((sum, h) => sum + h.unrealizedPL, 0);
                const totalEquity = INITIAL_CAPITAL + realizedPL + totalUnrealizedPL;
                const cash = totalEquity - totalMarketValue;
                const usageRate = totalEquity > 0 ? totalMarketValue / totalEquity : 0;
                return { holdings, realizedStocks, realizedPL, totalUnrealizedPL, totalEquity, totalMarketValue, usageRate, cash };
            }, [transactions, prices]);

            return (
                <div className="min-h-screen bg-yellow-400 font-sans text-slate-900 pb-10">
                    {editingId && <EditTransactionModal transaction={transactions.find(t => t.id === editingId)} onSave={(updatedTx) => {setTransactions(prev => prev.map(t => t.id === updatedTx.id ? updatedTx : t)); setEditingId(null);}} onCancel={() => setEditingId(null)} />}
                    {showCloudSettings && <CloudSettingsModal onClose={() => setShowCloudSettings(false)} onConnect={(room)=>{setSyncRoom(room);setIsSyncing(true);localStorage.setItem('stock_bill_fb_room',room);}} currentRoom={syncRoom} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {showAIModal && <AIGeminiModal onClose={() => setShowAIModal(false)} onAnalyze={handleAIResult} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {/* New Simple Table Modal */}
                    {showSimpleTable && <SimpleHoldingsModal holdings={portfolio.holdings} onClose={() => setShowSimpleTable(false)} />}

                    <header className="bg-yellow-400 shadow-xl border-b-4 border-blue-800 sticky top-0 z-40">
                        <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center relative z-10 gap-4">
                            <div className="flex items-center gap-4">
                                <label className="relative cursor-pointer group flex-shrink-0 z-50">
                                    <div className="w-16 h-16 rounded-full border-4 border-blue-800 bg-white overflow-hidden shadow-xl flex items-center justify-center">
                                        {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <Icon name="user" size={40} className="text-slate-300" />}
                                    </div>
                                    <input type="file" accept="image/*" className="hidden" onChange={async (e) => {const f=e.target.files[0]; if(f) setUserAvatar(await compressImage(f));}} />
                                </label>
                                <div>
                                    <h1 className="text-4xl md:text-5xl font-extrabold text-blue-800 tracking-wide" style={{ textShadow: '2px 2px 0px #fff' }}>股市比爾強</h1>
                                    <p className="text-sm font-bold bg-blue-900 text-white inline-block px-2 transform -skew-x-12 mt-1">v3.1 AI 旗艦版</p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                                <div className="text-right text-blue-900 font-bold font-mono">
                                    <div className="text-xl">{currentTime.toLocaleTimeString()}</div>
                                    <div className="text-xs">{currentTime.toLocaleDateString()}</div>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSimpleTable(true)} className="bg-blue-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white flex items-center gap-1 hover:bg-blue-700 transition-colors"><Icon name="table" size={14}/> 簡易持股表</button>
                                    <button onClick={() => setShowAIModal(true)} className="bg-purple-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white/50 flex items-center gap-1 hover:bg-purple-700 transition-colors"><Icon name="sparkles" size={14}/> AI 助理</button>
                                    <button onClick={() => setShowCloudSettings(true)} className={`font-bold text-xs px-3 py-2 rounded flex items-center gap-1 shadow-md text-white ${isSyncing?'bg-green-600':'bg-slate-400'}`}><Icon name="settings" size={14}/> {isSyncing ? syncRoom : '設定'}</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        <section className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-yellow-100 rounded-2xl p-5 text-slate-800 shadow-lg border-4 border-yellow-200 relative overflow-hidden">
                                <Icon name="wallet" size={80} className="absolute -right-4 -top-4 opacity-10"/>
                                <p className="text-slate-500 text-xs font-bold uppercase mb-1">總資產</p>
                                <h2 className="text-3xl font-bold text-slate-900 mb-2">{formatMoney(portfolio.totalMarketValue)}</h2>
                                <div className="flex justify-between items-end border-t border-yellow-300 pt-2">
                                    <div><p className="text-slate-500 text-xs font-bold">現金</p><span className="font-mono font-bold">{formatMoney(portfolio.cash)}</span></div>
                                    <div className="text-right"><span className="text-xs text-slate-500 block">水位</span><span className="text-xl font-bold">{formatPercent(portfolio.usageRate)}</span></div>
                                </div>
                            </div>
                            <div className="md:col-span-2 bg-slate-800 rounded-2xl p-5 text-white shadow-lg flex items-center justify-around">
                                <div className="text-center"><p className="text-slate-400 text-xs font-bold mb-1">未實現</p><div className={`text-4xl font-bold ${portfolio.totalUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>{portfolio.totalUnrealizedPL > 0 ? '+' : ''}{formatMoney(portfolio.totalUnrealizedPL)}</div></div>
                                <div className="w-px h-16 bg-slate-600"></div>
                                <div className="text-center"><p className="text-slate-400 text-xs font-bold mb-1">已實現</p><div className={`text-3xl font-bold ${portfolio.realizedPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>{portfolio.realizedPL > 0 ? '+' : ''}{formatMoney(portfolio.realizedPL)}</div></div>
                            </div>
                            <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-yellow-200 flex flex-col justify-center gap-2">
                                <div className="text-purple-600 font-bold flex items-center gap-2"><Icon name="sparkles" size={16}/> 試試 AI</div>
                                <p className="text-xs text-slate-500">上傳庫存截圖，自動更新股價；上傳成交回報，自動記帳。</p>
                            </div>
                        </section>

                        <div className="bg-yellow-50 rounded-3xl p-6 shadow-xl border-2 border-yellow-200 min-h-[500px]">
                            <div className="flex gap-4 mb-6 border-b-2 border-yellow-200 pb-2 overflow-x-auto">
                                {[{id:'holdings',label:'持有庫存',icon:'briefcase'},{id:'timeline',label:'交易紀錄',icon:'history'},{id:'realized',label:'已結算',icon:'check'}].map(tab=>(
                                    <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold transition-all whitespace-nowrap ${activeTab===tab.id?'bg-blue-600 text-white shadow-lg':'bg-white text-slate-500 hover:bg-yellow-100'}`}><Icon name={tab.icon} size={18}/> {tab.label}</button>
                                ))}
                            </div>

                            {activeTab === 'holdings' && (
                                <div className="flex gap-4 overflow-x-auto pb-4">
                                    {portfolio.holdings.map((stock, i) => (
                                        <div key={stock.code} onClick={()=>setSelectedStockCode(selectedStockCode===stock.code?null:stock.code)} className="min-w-[300px] bg-white rounded-2xl shadow border-2 border-transparent hover:border-blue-400 cursor-pointer transition-all flex-shrink-0">
                                            <div className="bg-slate-50 p-3 border-b flex justify-between items-center">
                                                <div className="flex items-center gap-2"><span className="bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold">{i+1}</span><span className="font-bold text-lg">{stock.name}</span><span className="text-xs text-slate-400">{stock.code}</span></div>
                                                <div className="text-right" title="點擊修改股價" onClick={(e)=>{e.stopPropagation(); const p=prompt('輸入新價',stock.currentPrice); if(p) setPrices(prev=>({...prev,[stock.code]:parseFloat(p)}));}}><div className="font-bold text-xl">{stock.currentPrice}</div></div>
                                            </div>
                                            <div className="p-4 space-y-3">
                                                <div className="bg-yellow-50 p-2 rounded text-xs text-slate-700 leading-relaxed border border-yellow-100">{stock.meta.highlight||'暫無亮點'}</div>
                                                <div className="grid grid-cols-2 gap-2 text-sm">
                                                    <div><span className="text-slate-400 text-xs block">均價</span><span className="font-bold font-mono">{formatDecimal(stock.avgCost)}</span></div>
                                                    <div className="text-right"><span className="text-slate-400 text-xs block">張數</span><span className="font-bold font-mono">{stock.inventory/1000}</span></div>
                                                    <div><span className="text-slate-400 text-xs block">市值</span><span className="font-bold font-mono">{formatMoney(stock.marketValue)}</span></div>
                                                    <div className="text-right"><span className="text-slate-400 text-xs block">損益</span><span className={`font-bold font-mono ${getColor(stock.unrealizedPL)}`}>{formatMoney(stock.unrealizedPL)}</span></div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}

                            {activeTab === 'timeline' && (
                                <div className="bg-white rounded-xl shadow border overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-slate-100 text-slate-500 uppercase"><tr><th className="px-4 py-3">日期</th><th className="px-4 py-3">名稱</th><th className="px-4 py-3">動作</th><th className="px-4 py-3 text-right">價格</th><th className="px-4 py-3 text-right">股數</th><th className="px-4 py-3">操作</th></tr></thead>
                                        <tbody>
                                            {[...transactions].sort((a,b)=>new Date(b.date)-new Date(a.date)).map(t => (
                                                <tr key={t.id} className="border-b hover:bg-slate-50">
                                                    <td className="px-4 py-3 font-mono">{t.date}</td>
                                                    <td className="px-4 py-3 font-bold">{t.name} <span className="text-xs text-slate-400 font-normal">{t.code}</span></td>
                                                    <td className="px-4 py-3"><span className={`px-2 py-1 rounded text-xs text-white ${t.type==='Buy'?'bg-red-500':'bg-green-500'}`}>{t.type}</span></td>
                                                    <td className="px-4 py-3 text-right font-mono font-bold">{t.price}</td>
                                                    <td className="px-4 py-3 text-right font-mono">{t.qty}</td>
                                                    <td className="px-4 py-3"><button onClick={()=>setEditingId(t.id)} className="text-blue-600 hover:underline"><Icon name="edit-2" size={14}/></button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                            
                            {activeTab === 'realized' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    {portfolio.realizedStocks.map(stock => (
                                        <div key={stock.code} className="bg-white rounded-xl shadow p-4 border flex justify-between items-center">
                                            <div><h3 className="font-bold text-lg">{stock.name}</h3><div className="text-xs text-slate-400">已清倉</div></div>
                                            <div className={`text-2xl font-bold font-mono ${getColor(stock.totalPL)}`}>{stock.totalPL>0?'+':''}{formatMoney(stock.totalPL)}</div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockBillStrong />);
    </script>
</body>
</html>
