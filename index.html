<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡å¸‚æ¯”çˆ¾å¼· v2.0 AIç‰ˆ</title>
    
    <!-- App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#facc15">
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. è¼‰å…¥ Markdown è§£æ (ç”¨æ–¼ AI å›æ‡‰é¡¯ç¤º) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        /* é¿å… iOS ä¸‹æ‹‰é‡æ–°æ•´ç† */
        html, body { overscroll-behavior-y: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
    </style>
</head>
<body class="bg-yellow-400 select-none">
    <div id="root"></div>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // --- Firebase åˆå§‹åŒ– ---
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        // ç°¡å–®é˜²å‘†
        if (!firebaseConfig.apiKey) console.warn("Firebase config missing. Sync may not work.");
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';

        const { useState, useMemo, useEffect, useRef } = React;

        // --- Helper: Icon ---
        const Icon = ({ name, size = 24, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const iconName = name.charAt(0).toUpperCase() + name.slice(1).replace(/-./g, x => x[1].toUpperCase());
                    const lucideIcon = window.lucide.icons[iconName] || window.lucide.icons[Object.keys(window.lucide.icons).find(k => k.toLowerCase() === name.replace(/-/g, '').toLowerCase())];
                    setIconNode(lucideIcon);
                }
            }, [name]);
            if (!iconNode) return <span style={{width: size, height: size, display: 'inline-block'}} />;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        // --- Helper: Image Tools ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300; // Avatar ä¸éœ€è¦å¤ªå¤§
                        const maxHeight = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const fileToGenerativePart = async (file) => {
            const base64EncodedDataPromise = new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result.split(',')[1]);
                reader.readAsDataURL(file);
            });
            return {
                inlineData: { data: await base64EncodedDataPromise, mimeType: file.type },
            };
        };

        // --- åˆå§‹è³‡æ–™ ---
        const INITIAL_CAPITAL = 5000000;
        const INITIAL_META_DATA = {
            '8358': { market: 'ä¸Šæ«ƒ', industry: 'é›»å­é›¶çµ„ä»¶', highlight: 'éŠ…ç®”åŸºæ¿éœ€æ±‚å¼·å‹ï¼Œä¼ºæœå™¨å‡ç´šå—æƒ ã€‚' },
            '3081': { market: 'ä¸Šæ«ƒ', industry: 'é€šä¿¡ç¶²è·¯', highlight: 'å…‰é€šè¨Šç£Šæ™¶ç‰‡é ˜å…ˆè€…ï¼ŒçŸ½å…‰å­é¡Œæã€‚' },
            '5284': { market: 'ä¸Šå¸‚', industry: 'èˆªå¤ªå·¥æ¥­', highlight: 'ä¼ºæœå™¨æ©Ÿæ®¼èˆ‡èˆªå¤ªé›¶çµ„ä»¶ï¼Œæ¥­ç¸¾å‰µé«˜ã€‚' },
            '2360': { market: 'ä¸Šå¸‚', industry: 'å…¶ä»–é›»å­', highlight: 'ç²¾å¯†é‡æ¸¬å„€å™¨é¾é ­ï¼ŒåŠå°é«”æ¸¬è©¦éœ€æ±‚å¢ã€‚' },
            '4722': { market: 'ä¸Šæ«ƒ', industry: 'åŒ–å­¸å·¥æ¥­', highlight: 'å…‰å›ºåŒ–ææ–™é¾é ­ï¼ŒCoWoS é—œéµåŒ–å­¸å“ä¾›æ‡‰å•†ã€‚' },
            '8996': { market: 'ä¸Šå¸‚', industry: 'é›»æ©Ÿæ©Ÿæ¢°', highlight: 'ç†±ç®¡ç†å°ˆå®¶ï¼Œæ¶²å†·æ•£ç†±åˆ‡å…¥è³‡æ–™ä¸­å¿ƒã€‚' },
            '4931': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'é‹°é›»æ± æ¨¡çµ„ï¼ŒBBU å‚™æ´é›»æ± éœ€æ±‚çˆ†ç™¼ã€‚' },
            '7853': { market: 'èˆˆæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'åŠå°é«” AOI æª¢æ¸¬è¨­å‚™ï¼Œå…ˆé€²å°è£éœ€æ±‚ã€‚' },
            '7828': { market: 'èˆˆæ«ƒ', industry: 'è»Ÿé«”æœå‹™', highlight: 'æ•¸ä½è½‰å‹é›²ç«¯æœå‹™å•†ï¼Œè³‡å®‰éœ€æ±‚å¼·å‹ã€‚' },
            '3017': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'æ•£ç†±æ¨¡çµ„å¤§å» ï¼ŒAI ä¼ºæœå™¨æ•£ç†±è§£æ±ºæ–¹æ¡ˆã€‚' },
            '3324': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'æ•£ç†±è§£æ±ºæ–¹æ¡ˆï¼Œæ°´å†·æ¿å‡ºè²¨æ”¾é‡ã€‚' },
            '4971': { market: 'ä¸Šæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'MBE ç ·åŒ–éµç£Šæ™¶å…¨çƒé¾é ­ï¼Œåœ‹é˜²èˆ‡èˆªå¤ªéœ€æ±‚ã€‚' },
            '6788': { market: 'ä¸Šæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'æ™¶åœ“ä»£å·¥ AMC è¨­å‚™ä¾›æ‡‰å•†ï¼Œå…ˆé€²è£½ç¨‹æ“´ç”¢ã€‚' },
            '7751': { market: 'èˆˆæ«ƒ', industry: 'åŠå°é«”è¨­å‚™', highlight: 'å…ˆé€²å°è£æª¢æ¸¬ï¼ŒCoWoS è¨‚å–®èƒ½è¦‹åº¦é«˜ã€‚' },
            '3189': { market: 'ä¸Šå¸‚', industry: 'åŠå°é«”æ¥­', highlight: 'ABF è¼‰æ¿å¾©ç”¦ï¼ŒHPC èˆ‡ AI æ™¶ç‰‡éœ€æ±‚å¼·ã€‚' },
        };
        const INITIAL_PRICES = { '8358': 260.0, '3081': 618.0, '5284': 270.5, '2360': 856.0, '4722': 165.0, '8996': 577.0, '4931': 173.0, '7853': 113.5, '7828': 530.0, '3017': 1380.0, '3324': 710.0, '4971': 308.0, '6788': 350.0, '7751': 861.0, '3189': 192.5 };
        const INITIAL_TRANSACTIONS = [
             { id: 101, date: '2025/10/28', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 224.0, qty: 1000, note: 'å»ºç«‹æŒè‚¡' },
             // ... ç‚ºäº†ç¯€çœé•·åº¦ï¼Œä¿ç•™éƒ¨åˆ†åˆå§‹è³‡æ–™ ...
             { id: 201, date: '2025/10/30', code: '3081', name: 'è¯äº', type: 'Buy', price: 433.5, qty: 1000, note: 'å»ºç«‹æŒè‚¡' },
             { id: 301, date: '2025/11/07', code: '5284', name: 'JPP-KY', type: 'Buy', price: 296.5, qty: 1000, note: 'å»ºç«‹æŒè‚¡' },
             { id: 401, date: '2025/11/02', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 776.5, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘å»ºç«‹æŒè‚¡' },
             { id: 501, date: '2025/12/15 10:01', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 188.5, qty: 1000, note: 'å»ºç«‹æŒè‚¡' },
        ];

        const formatNumber = (val) => new Intl.NumberFormat('zh-TW').format(Math.round(val));
        const formatMoney = (val) => `$${formatNumber(val)}`;
        const formatDecimal = (val) => val.toFixed(2);
        const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
        const getColor = (val) => val > 0 ? 'text-red-600' : val < 0 ? 'text-green-600' : 'text-slate-900';

        // --- AI Modal ---
        const AIGeminiModal = ({ onClose, onAnalyze, apiKey, setApiKey }) => {
            const [mode, setMode] = useState('transactions'); // transactions | prices
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const fileInputRef = useRef(null);

            const handleFileChange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                if (!apiKey) {
                    alert("è«‹å…ˆè¼¸å…¥ Gemini API Key æ‰èƒ½ä½¿ç”¨ AI åŠŸèƒ½ï¼");
                    return;
                }

                setIsAnalyzing(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });

                    const imagePart = await fileToGenerativePart(file);
                    
                    let prompt = "";
                    if (mode === 'transactions') {
                        prompt = `
                            ä½ æ˜¯ä¸€å€‹è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ã€‚è«‹åˆ†æé€™å¼µæˆªåœ–ä¸­çš„è‚¡ç¥¨äº¤æ˜“ç´€éŒ„ã€‚
                            è«‹æå–ä»¥ä¸‹æ¬„ä½ä¸¦å›å‚³ä¸€å€‹ JSON Arrayï¼Œä¸è¦åŒ…å« markdown æ¨™ç±¤ï¼Œåªè¦ç´” JSON å­—ä¸²ï¼š
                            [
                                {
                                    "date": "YYYY/MM/DD (å¹´ä»½å¦‚æœæ˜¯æ°‘åœ‹è«‹è½‰è¥¿å…ƒ)",
                                    "code": "è‚¡ç¥¨ä»£è™Ÿ",
                                    "name": "è‚¡ç¥¨åç¨±",
                                    "type": "Buy æˆ– Sell (å¦‚æœæ˜¯è²·é€²ã€èè³‡è²·é€²ã€ç¾è‚¡è²·é€²éƒ½ç®— Buy; è³£å‡ºã€ç¾è‚¡è³£å‡ºéƒ½ç®— Sell)",
                                    "price": æ•¸å€¼ (æˆäº¤å–®åƒ¹),
                                    "qty": æ•¸å€¼ (è‚¡æ•¸ï¼Œå¦‚æœæ˜¯å¼µæ•¸è«‹ä¹˜ä»¥1000),
                                    "note": "AIè­˜åˆ¥"
                                }
                            ]
                            å¦‚æœç„¡æ³•è¾¨è­˜ï¼Œå›å‚³ç©ºé™£åˆ— []ã€‚
                        `;
                    } else {
                        prompt = `
                            ä½ æ˜¯ä¸€å€‹è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ã€‚è«‹åˆ†æé€™å¼µæˆªåœ–ä¸­çš„è‚¡ç¥¨è¡Œæƒ…åˆ—è¡¨ã€‚
                            æˆ‘éœ€è¦æ›´æ–°æ”¶ç›¤åƒ¹ã€‚è«‹æå–è‚¡ç¥¨ä»£è™Ÿå’Œæœ€æ–°æˆäº¤åƒ¹/æ”¶ç›¤åƒ¹ã€‚
                            å›å‚³ä¸€å€‹ JSON Objectï¼Œæ ¼å¼å¦‚ä¸‹ (ä¸è¦ markdownï¼Œåªè¦ç´” JSON)ï¼š
                            {
                                "8358": 260.5,
                                "3081": 618.0
                            }
                            Keyæ˜¯ä»£è™Ÿ(å­—ä¸²), Valueæ˜¯åƒ¹æ ¼(æ•¸å€¼)ã€‚
                        `;
                    }

                    const result = await model.generateContent([prompt, imagePart]);
                    const response = await result.response;
                    let text = response.text();
                    
                    // æ¸…ç† markdown
                    text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    const data = JSON.parse(text);
                    
                    onAnalyze(data, mode);
                    onClose();
                    alert("âœ… åˆ†æå®Œæˆï¼è³‡æ–™å·²æ›´æ–°ã€‚");

                } catch (error) {
                    console.error("AI Error:", error);
                    alert("âŒ åˆ†æå¤±æ•—ï¼šè«‹ç¢ºèª API Key æ­£ç¢ºï¼Œæˆ–åœ–ç‰‡æ¸…æ™°åº¦ã€‚\n" + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800">
                                <Icon name="sparkles" className="text-purple-600"/> AI æ™ºæ…§åŠ©ç†
                            </h2>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>

                        <div className="space-y-6">
                            {/* API Key Input */}
                            <div>
                                <label className="block text-xs font-bold text-slate-500 uppercase mb-1">Gemini API Key</label>
                                <input 
                                    type="password" 
                                    value={apiKey} 
                                    onChange={(e) => setApiKey(e.target.value)} 
                                    placeholder="è²¼ä¸Šæ‚¨çš„ API Key"
                                    className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:ring-2 focus:ring-purple-500 outline-none"
                                />
                                <p className="text-[10px] text-slate-400 mt-1">Key åƒ…å„²å­˜æ–¼æœ¬åœ°ç€è¦½å™¨ï¼Œä¸æœƒä¸Šå‚³è‡³ä¼ºæœå™¨ã€‚</p>
                            </div>

                            {/* Mode Selection */}
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button 
                                    onClick={() => setMode('transactions')}
                                    className={`flex-1 py-2 text-sm font-bold rounded-md transition-all flex items-center justify-center gap-2 ${mode === 'transactions' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <Icon name="file-text" size={16}/> è¾¨è­˜äº¤æ˜“
                                </button>
                                <button 
                                    onClick={() => setMode('prices')}
                                    className={`flex-1 py-2 text-sm font-bold rounded-md transition-all flex items-center justify-center gap-2 ${mode === 'prices' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}
                                >
                                    <Icon name="trending-up" size={16}/> æ›´æ–°è‚¡åƒ¹
                                </button>
                            </div>

                            {/* Upload Area */}
                            <div 
                                onClick={() => !isAnalyzing && fileInputRef.current.click()}
                                className={`border-2 border-dashed rounded-xl p-8 text-center cursor-pointer transition-colors ${isAnalyzing ? 'border-purple-300 bg-purple-50 cursor-wait' : 'border-slate-300 hover:border-purple-500 hover:bg-slate-50'}`}
                            >
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} accept="image/*" className="hidden" />
                                {isAnalyzing ? (
                                    <div className="flex flex-col items-center animate-pulse">
                                        <Icon name="loader-2" size={40} className="text-purple-600 animate-spin mb-2"/>
                                        <p className="text-purple-700 font-bold">AI æ­£åœ¨åˆ†æåœ–ç‰‡...</p>
                                    </div>
                                ) : (
                                    <div className="flex flex-col items-center">
                                        <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mb-3 text-purple-600">
                                            <Icon name="camera" size={32}/>
                                        </div>
                                        <p className="text-slate-700 font-bold mb-1">é»æ“Šä¸Šå‚³æˆªåœ–</p>
                                        <p className="text-xs text-slate-400">æ”¯æ´æ‰‹æ©Ÿæˆªåœ–ã€çœ‹ç›¤è»Ÿé«”ç•«é¢</p>
                                    </div>
                                )}
                            </div>

                            <div className="text-xs text-slate-500 bg-slate-50 p-3 rounded border border-slate-100">
                                {mode === 'transactions' ? 
                                    "ğŸ’¡ æç¤ºï¼šè«‹ä¸Šå‚³åˆ¸å•† App çš„ã€Œæˆäº¤å›å ±ã€æˆ–ã€Œåº«å­˜æ˜ç´°ã€æˆªåœ–ï¼ŒAI å°‡è‡ªå‹•åŠ å…¥äº¤æ˜“ç´€éŒ„ã€‚" : 
                                    "ğŸ’¡ æç¤ºï¼šè«‹ä¸Šå‚³åˆ¸å•† App çš„ã€Œè‡ªé¸è‚¡åˆ—è¡¨ã€æˆ–ã€Œå ±åƒ¹ç•«é¢ã€ï¼ŒAI å°‡è‡ªå‹•æ›´æ–°æœ€æ–°æ”¶ç›¤åƒ¹ã€‚"
                                }
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CloudSettingsModal = ({ onClose, onConnect, currentRoom, apiKey, setApiKey }) => {
            const [roomName, setRoomName] = useState(currentRoom || "default");
            const handleSave = () => {
                if (roomName.trim()) onConnect(roomName.trim());
                else alert("è«‹è¼¸å…¥æˆ¿é–“åç¨±");
            };
            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md shadow-2xl p-6">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 className="text-xl font-bold flex items-center gap-2 text-slate-800"><Icon name="settings" className="text-blue-600"/> ç³»çµ±è¨­å®š</h2>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">åŒæ­¥æˆ¿é–“åç¨±</label>
                                <input type="text" value={roomName} onChange={(e) => setRoomName(e.target.value)} className="w-full border border-slate-300 rounded p-2 font-bold text-slate-700"/>
                            </div>
                            <hr/>
                            <div>
                                <label className="block text-sm font-bold text-slate-700 mb-1">Gemini API Key (AI åŠŸèƒ½ç”¨)</label>
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="AI Key" className="w-full border border-slate-300 rounded p-2 text-sm"/>
                            </div>
                            <button onClick={handleSave} className="w-full bg-blue-600 text-white font-bold py-2 rounded hover:bg-blue-700 transition-colors">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        function StockBillStrong() {
            const [activeTab, setActiveTab] = useState('holdings'); 
            const [user, setUser] = useState(null);
            
            // è³‡æ–™ç‹€æ…‹
            const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
            const [prices, setPrices] = useState(INITIAL_PRICES);
            const [userAvatar, setUserAvatar] = useState(null);
            const [geminiApiKey, setGeminiApiKey] = useState("");
            
            // Sync ç‹€æ…‹
            const [syncRoom, setSyncRoom] = useState("default");
            const [isSyncing, setIsSyncing] = useState(false); 

            // Modal ç‹€æ…‹
            const [showCloudSettings, setShowCloudSettings] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [showSimpleTable, setShowSimpleTable] = useState(false); 
            const [selectedStockCode, setSelectedStockCode] = useState(null);

            // 1. åˆå§‹åŒ– Auth
            useEffect(() => {
                const initAuth = async () => {
                    if (typeof window.__initial_auth_token !== 'undefined' && window.__initial_auth_token) {
                        await signInWithCustomToken(auth, window.__initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
                onAuthStateChanged(auth, setUser);
            }, []);

            // 2. è¼‰å…¥ LocalStorage
            useEffect(() => {
                const savedRoom = localStorage.getItem('stock_bill_fb_room');
                const savedKey = localStorage.getItem('stock_bill_gemini_key');
                if (savedKey) setGeminiApiKey(savedKey);

                if (savedRoom) {
                    setSyncRoom(savedRoom);
                    setIsSyncing(true);
                } else {
                    const savedTx = localStorage.getItem('stock_bill_transactions');
                    if (savedTx) setTransactions(JSON.parse(savedTx));
                    
                    const savedPrices = localStorage.getItem('stock_bill_prices');
                    if (savedPrices) setPrices(JSON.parse(savedPrices));

                    const savedAvatar = localStorage.getItem('stock_bill_avatar');
                    if (savedAvatar) setUserAvatar(savedAvatar);
                }
            }, []);

            // 3. å„²å­˜ Gemini Key
            useEffect(() => {
                if(geminiApiKey) localStorage.setItem('stock_bill_gemini_key', geminiApiKey);
            }, [geminiApiKey]);

            // 4. Firestore ç›£è½
            useEffect(() => {
                if (!user || !syncRoom) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.transactions) setTransactions(JSON.parse(data.transactions));
                        if (data.prices) setPrices(JSON.parse(data.prices));
                        // ç¢ºä¿å¦‚æœé›²ç«¯æœ‰ avatar å°±ç”¨é›²ç«¯çš„ï¼Œå¦å‰‡ä¿ç•™æœ¬åœ°
                        if (data.userAvatar && data.userAvatar !== "") setUserAvatar(data.userAvatar);
                        setIsSyncing(true);
                    } else if (isSyncing) {
                        setDoc(docRef, {
                            transactions: JSON.stringify(transactions),
                            prices: JSON.stringify(prices),
                            userAvatar: userAvatar || ""
                        }, { merge: true });
                    }
                });
                return () => unsubscribe();
            }, [user, syncRoom, isSyncing]);

            // 5. è³‡æ–™å¯«å…¥ (Debounce)
            useEffect(() => {
                if (!user) { // å³ä½¿é›¢ç·šä¹Ÿè¦å­˜æœ¬åœ°
                    localStorage.setItem('stock_bill_transactions', JSON.stringify(transactions));
                    localStorage.setItem('stock_bill_prices', JSON.stringify(prices));
                    if (userAvatar) localStorage.setItem('stock_bill_avatar', userAvatar);
                    return;
                }
                if (!isSyncing) return;

                const saveData = async () => {
                    try {
                        const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                        await setDoc(docRef, {
                            transactions: JSON.stringify(transactions),
                            prices: JSON.stringify(prices),
                            userAvatar: userAvatar || ""
                        }, { merge: true });
                    } catch (e) { console.error(e); }
                };
                const timeoutId = setTimeout(saveData, 1000);
                return () => clearTimeout(timeoutId);
            }, [transactions, prices, userAvatar, user, isSyncing, syncRoom]);

            // --- Handlers ---
            const handleCloudConnect = (room) => {
                setSyncRoom(room);
                setIsSyncing(true);
                localStorage.setItem('stock_bill_fb_room', room);
                setShowCloudSettings(false);
                alert(`âœ… å·²åˆ‡æ›è‡³æˆ¿é–“ï¼š${room}`);
            };

            const handleAvatarUpload = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                try {
                    const compressedBase64 = await compressImage(file);
                    setUserAvatar(compressedBase64);
                    // å¼·åˆ¶ç«‹å³å¯«å…¥æœ¬åœ°ï¼Œé¿å…ç‹€æ…‹å»¶é²
                    localStorage.setItem('stock_bill_avatar', compressedBase64);
                } catch(err) { console.error(err); }
            };

            const handleManualPriceUpdate = (e, code, currentPrice) => {
                e.stopPropagation(); 
                const newPrice = prompt(`è«‹è¼¸å…¥ ${code} çš„æœ€æ–°æ”¶ç›¤åƒ¹ï¼š`, currentPrice);
                if (newPrice && !isNaN(newPrice)) {
                    setPrices(prev => ({ ...prev, [code]: parseFloat(newPrice) }));
                }
            };

            const handleAIResult = (data, mode) => {
                if (mode === 'transactions') {
                    if (Array.isArray(data) && data.length > 0) {
                        const newTx = data.map(t => ({
                            ...t,
                            id: Date.now() + Math.random(), // ç”¢ç”Ÿå”¯ä¸€ ID
                        }));
                        setTransactions(prev => [...prev, ...newTx]);
                    } else {
                        alert("AI æœªèƒ½è¾¨è­˜å‡ºæœ‰æ•ˆäº¤æ˜“ç´€éŒ„ï¼Œè«‹ç¢ºèªåœ–ç‰‡ã€‚");
                    }
                } else if (mode === 'prices') {
                    if (typeof data === 'object') {
                        setPrices(prev => ({ ...prev, ...data }));
                    } else {
                        alert("AI æœªèƒ½è¾¨è­˜å‡ºåƒ¹æ ¼ï¼Œè«‹ç¢ºèªåœ–ç‰‡ã€‚");
                    }
                }
            };

            const handleReset = () => {
                if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿ")) {
                    setTransactions(INITIAL_TRANSACTIONS);
                    setPrices(INITIAL_PRICES);
                    setUserAvatar(null);
                    localStorage.clear(); // æ¸…é™¤æ‰€æœ‰
                    alert("å·²é‡ç½®ã€‚");
                }
            };

            // æŠ•è³‡çµ„åˆè¨ˆç®—
            const portfolio = useMemo(() => {
                const holdingsMap = {};
                const realizedMap = {};
                let realizedPL = 0;
                
                const sortedTrans = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTrans.forEach(t => {
                    if (!holdingsMap[t.code]) holdingsMap[t.code] = { code: t.code, name: t.name, inventory: 0, totalCost: 0, avgCost: 0, callSignalCount: 0, newMemberCount: 0, history: [], callSignalCostSum: 0, callSignalQtySum: 0 };
                    if (!realizedMap[t.code]) realizedMap[t.code] = { code: t.code, name: t.name, totalPL: 0, trades: [] };

                    const stock = holdingsMap[t.code];
                    stock.history.push(t);
                    realizedMap[t.code].trades.push(t);

                    if (t.note && t.note.includes('æ–°æœƒå“¡')) {
                        if (t.type === 'Buy') stock.newMemberCount += 1;
                        return; 
                    }
                    const quantity = t.qty || 1000;
                    if (t.type === 'Buy') {
                        stock.totalCost += t.price * quantity;
                        stock.inventory += quantity;
                        stock.avgCost = stock.inventory > 0 ? stock.totalCost / stock.inventory : 0;
                        stock.callSignalCount += 1;
                        stock.callSignalCostSum += t.price * quantity;
                        stock.callSignalQtySum += quantity;
                    } else {
                        if (stock.inventory > 0) {
                            const sellQty = Math.min(stock.inventory, quantity);
                            const profit = (t.price - stock.avgCost) * sellQty;
                            realizedPL += profit;
                            realizedMap[t.code].totalPL += profit;
                            stock.totalCost -= stock.avgCost * sellQty;
                            stock.inventory -= sellQty;
                        }
                    }
                });

                const currentHoldings = Object.values(holdingsMap).filter(h => h.inventory > 0).map(h => {
                    const currentPrice = prices[h.code] || h.avgCost;
                    const marketValue = currentPrice * h.inventory;
                    const unrealizedPL = (currentPrice - h.avgCost) * h.inventory;
                    const callSignalAvgCost = h.callSignalQtySum > 0 ? h.callSignalCostSum / h.callSignalQtySum : h.avgCost;
                    return { ...h, currentPrice, marketValue, unrealizedPL, callSignalAvgCost, meta: INITIAL_META_DATA[h.code] || {} };
                });

                const realizedStocks = Object.values(realizedMap).filter(r => holdingsMap[r.code].inventory === 0 && r.trades.length > 0).map(r => ({ ...r, meta: INITIAL_META_DATA[r.code] || {} }));

                const totalMarketValue = currentHoldings.reduce((sum, h) => sum + h.marketValue, 0);
                const totalUnrealizedPL = currentHoldings.reduce((sum, h) => sum + h.unrealizedPL, 0);
                const totalEquity = INITIAL_CAPITAL + realizedPL + totalUnrealizedPL;
                const cash = totalEquity - totalMarketValue;
                const usageRate = totalEquity > 0 ? totalMarketValue / totalEquity : 0;

                return { holdings: currentHoldings, realizedStocks, realizedPL, totalUnrealizedPL, totalEquity, totalMarketValue, usageRate, cash };
            }, [transactions, prices]);

            // --- Sub-components ---
            const SimpleHoldingsModal = ({ holdings, onClose }) => (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-yellow-50 rounded-2xl w-full max-w-4xl shadow-2xl border-4 border-yellow-300 flex flex-col max-h-[90vh]">
                        <div className="bg-yellow-300 px-6 py-4 flex justify-between items-center rounded-t-xl border-b border-yellow-400"><div className="flex items-center gap-2"><Icon name="table" className="text-slate-800"/><h2 className="text-2xl font-bold text-slate-900">ç°¡æ˜“æŒè‚¡è¡¨</h2></div><button onClick={onClose}><Icon name="x" className="text-slate-800"/></button></div>
                        <div className="p-6 overflow-x-auto"><table className="w-full text-left border-collapse min-w-[600px]"><thead><tr className="border-b-2 border-yellow-200 text-slate-600"><th className="py-3 px-4 font-bold text-lg">è‚¡ç¥¨åç¨±</th><th className="py-3 px-4 font-bold text-lg">ä»£è™Ÿ</th><th className="py-3 px-4 text-center font-bold text-lg text-blue-700">è²·å…¥æ¬¡æ•¸</th><th className="py-3 px-4 text-right font-bold text-lg text-slate-800">å‡åƒ¹</th></tr></thead><tbody className="divide-y divide-yellow-100">{holdings.length === 0 ? (<tr><td colSpan="4" className="py-8 text-center text-slate-400 font-bold text-xl">ç›®å‰ç„¡æŒè‚¡</td></tr>) : (holdings.map((stock) => (<tr key={stock.code} className="hover:bg-yellow-100/50"><td className="py-4 px-4 font-bold text-xl text-slate-900">{stock.name}</td><td className="py-4 px-4 font-mono text-slate-500 font-medium">{stock.code}</td><td className="py-4 px-4 text-center"><span className="inline-block bg-blue-100 text-blue-800 px-3 py-1 rounded-full font-bold">{stock.callSignalCount}</span></td><td className="py-4 px-4 text-right font-mono font-bold text-xl text-slate-800">{stock.callSignalAvgCost > 0 ? formatDecimal(stock.callSignalAvgCost) : '-'}</td></tr>)))}</tbody></table></div>
                    </div>
                </div>
            );

            const EditTransactionModal = ({ transaction, onSave, onCancel }) => {
                const [formData, setFormData] = useState(transaction);
                const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({...prev, [name]: name === 'price' || name === 'qty' ? parseFloat(value) : value})); };
                return (
                    <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white p-6 rounded-xl w-full max-w-md shadow-2xl overflow-y-auto max-h-[90vh]">
                            <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><Icon name="edit-2" size={20} /> ç·¨è¼¯äº¤æ˜“</h3>
                            <div className="space-y-3">
                                <div><label className="text-xs text-slate-500">æ—¥æœŸ</label><input name="date" value={formData.date} onChange={handleChange} className="w-full border p-2 rounded" /></div>
                                <div className="flex gap-2"><div className="flex-1"><label className="text-xs text-slate-500">ä»£è™Ÿ</label><input name="code" value={formData.code} onChange={handleChange} className="w-full border p-2 rounded" /></div><div className="flex-1"><label className="text-xs text-slate-500">åç¨±</label><input name="name" value={formData.name} onChange={handleChange} className="w-full border p-2 rounded" /></div></div>
                                <div className="flex gap-2"><div className="flex-1"><label className="text-xs text-slate-500">è²·è³£</label><select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div><div className="flex-1"><label className="text-xs text-slate-500">åƒ¹æ ¼</label><input type="number" step="0.1" name="price" value={formData.price} onChange={handleChange} className="w-full border p-2 rounded" /></div></div>
                                <div className="flex gap-2"><div className="flex-1"><label className="text-xs text-slate-500">è‚¡æ•¸</label><input type="number" name="qty" value={formData.qty} onChange={handleChange} className="w-full border p-2 rounded" /></div></div>
                                <div><label className="text-xs text-slate-500">å‚™è¨»</label><input name="note" value={formData.note} onChange={handleChange} className="w-full border p-2 rounded" /></div>
                            </div>
                            <div className="mt-6 flex justify-end gap-2"><button onClick={onCancel} className="px-4 py-2 text-slate-600 hover:bg-slate-100 rounded">å–æ¶ˆ</button><button onClick={() => onSave(formData)} className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">å„²å­˜</button></div>
                        </div>
                    </div>
                );
            };

            const ClockWidget = () => {
                const [time, setTime] = useState(new Date());
                useEffect(() => { const timer = setInterval(() => setTime(new Date()), 1000); return () => clearInterval(timer); }, []);
                const weekDays = ['æ˜ŸæœŸæ—¥', 'æ˜ŸæœŸä¸€', 'æ˜ŸæœŸäºŒ', 'æ˜ŸæœŸä¸‰', 'æ˜ŸæœŸå››', 'æ˜ŸæœŸäº”', 'æ˜ŸæœŸå…­'];
                return (
                    <div className="flex flex-col items-end text-blue-900 font-bold">
                        <div className="text-xl font-mono tracking-wider tabular-nums">{time.toLocaleTimeString('zh-TW', { hour12: false, hour: '2-digit', minute: '2-digit' })}</div>
                        <div className="text-xs font-medium opacity-90">{time.getFullYear()}/{time.getMonth()+1}/{time.getDate()} {weekDays[time.getDay()]}</div>
                    </div>
                );
            };

            return (
                <div className="min-h-screen bg-yellow-400 font-sans text-slate-900 pb-10">
                    {/* Modals */}
                    {editingId && <EditTransactionModal transaction={transactions.find(t => t.id === editingId)} onSave={(updatedTx) => {setTransactions(prev => prev.map(t => t.id === updatedTx.id ? updatedTx : t)); setEditingId(null);}} onCancel={() => setEditingId(null)} />}
                    {showSimpleTable && <SimpleHoldingsModal holdings={portfolio.holdings} onClose={() => setShowSimpleTable(false)} />}
                    {showCloudSettings && <CloudSettingsModal onClose={() => setShowCloudSettings(false)} onConnect={handleCloudConnect} currentRoom={syncRoom} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {showAIModal && <AIGeminiModal onClose={() => setShowAIModal(false)} onAnalyze={handleAIResult} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}

                    {/* Header */}
                    <header className="bg-yellow-400 shadow-2xl border-b-4 border-blue-800 sticky top-0 z-40 overflow-visible relative">
                        <div className="absolute top-0 left-0 w-full h-full opacity-5 pointer-events-none overflow-hidden"><Icon name="trending-up" size={400} className="absolute -left-20 -bottom-20 text-blue-900 transform -rotate-12"/><Icon name="dollar-sign" size={300} className="absolute right-0 -top-10 text-blue-900 transform rotate-12"/></div>
                        <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center relative z-10 gap-4">
                            <div className="flex items-center gap-4 w-full md:w-auto">
                                {/* Avatar: ç¢ºä¿å®ƒä¸æœƒè¢«é‡ç½®ï¼Œä¸¦ä¸” sticky åœ¨å·¦ä¸Šè§’ */}
                                <label className="relative cursor-pointer group flex-shrink-0 z-50">
                                    <div className="w-16 h-16 md:w-20 md:h-20 rounded-full border-4 border-blue-800 bg-white overflow-hidden shadow-xl flex items-center justify-center transition-transform hover:scale-105">
                                        {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <Icon name="user" size={40} className="text-slate-300" />}
                                    </div>
                                    <div className="absolute inset-0 bg-black/40 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="camera" size={24} className="text-white"/></div>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleAvatarUpload} />
                                </label>
                                <div>
                                    <h1 className="text-4xl md:text-6xl font-extrabold text-blue-800 tracking-wide leading-tight" style={{ textShadow: '3px 3px 0px #fff, 6px 6px 0px rgba(0,0,0,0.1)' }}>è‚¡å¸‚æ¯”çˆ¾å¼·</h1>
                                    <div className="inline-block bg-blue-900 text-white px-3 py-1 mt-2 rounded-lg shadow-md transform -skew-x-12"><p className="text-sm md:text-base font-bold tracking-widest transform skew-x-12">ç”¢æ¥­è¶¨å‹¢æŒ–æ˜è€…</p></div>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                                <ClockWidget />
                                <div className="flex gap-2 flex-wrap justify-end">
                                    <button onClick={() => setShowAIModal(true)} className="cursor-pointer bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white font-bold text-xs px-4 py-2 rounded-full flex items-center gap-1 shadow-lg border border-white/50 animate-pulse"><Icon name="sparkles" size={16}/> AI åŠ©ç†</button>
                                    <button onClick={() => setShowCloudSettings(true)} className={`cursor-pointer ${isSyncing ? 'bg-green-600 hover:bg-green-700' : 'bg-slate-100 hover:bg-slate-200 text-slate-700'} font-bold text-xs px-3 py-1.5 rounded flex items-center gap-1 border border-slate-300 shadow-md text-white transition-colors`}><Icon name={isSyncing ? "cloud-lightning" : "settings"} size={14}/> {isSyncing ? syncRoom : 'è¨­å®š'}</button>
                                    <button onClick={() => setShowSimpleTable(true)} className="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white font-bold text-xs px-4 py-2 rounded flex items-center gap-1 shadow-lg border-2 border-white"><Icon name="maximize" size={16}/> æŒè‚¡è¡¨</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        {/* Summary Cards */}
                        <section className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div className="bg-yellow-100 rounded-2xl p-5 text-slate-800 shadow-xl border-4 border-yellow-200 relative overflow-hidden group">
                                <div className="absolute top-0 right-0 p-4 opacity-10 group-hover:scale-110 transition-transform text-slate-900"><Icon name="wallet" size={80} /></div>
                                <div className="relative z-10"><p className="text-slate-500 text-xs font-bold uppercase tracking-wider mb-1">å·²æŠ•å…¥æœ¬é‡‘</p><h2 className="text-3xl font-bold text-slate-900 mb-2">{formatMoney(portfolio.totalMarketValue)}</h2><div className="h-0.5 bg-yellow-300 w-full my-2"></div><div className="flex justify-between items-end"><div><p className="text-slate-500 text-xs font-bold uppercase tracking-wider">å‰©é¤˜æœ¬é‡‘</p><span className="text-xl font-mono text-slate-700 font-bold">{formatMoney(portfolio.cash)}</span></div><div className="text-right"><span className="text-xs text-slate-500 block">è³‡é‡‘æ°´ä½</span><span className="text-2xl font-bold text-slate-900">{formatPercent(portfolio.usageRate)}</span></div></div></div>
                            </div>
                            <div className="md:col-span-2 bg-gradient-to-r from-slate-800 to-slate-700 rounded-2xl p-5 text-white shadow-xl flex items-center justify-around border border-slate-600">
                                <div className="text-center"><p className="text-slate-400 text-xs font-bold mb-1">æœªå¯¦ç¾æç›Š</p><div className={`text-4xl font-bold ${portfolio.totalUnrealizedPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>{portfolio.totalUnrealizedPL > 0 ? '+' : ''}{formatMoney(portfolio.totalUnrealizedPL)}</div></div>
                                <div className="w-px h-16 bg-slate-600"></div>
                                <div className="text-center"><p className="text-slate-400 text-xs font-bold mb-1">å·²å¯¦ç¾æç›Š</p><div className={`text-3xl font-bold ${portfolio.realizedPL >= 0 ? 'text-red-400' : 'text-green-400'}`}>{portfolio.realizedPL > 0 ? '+' : ''}{formatMoney(portfolio.realizedPL)}</div></div>
                            </div>
                            <div className="bg-white rounded-2xl p-4 shadow-xl flex flex-col justify-center gap-3 border-2 border-yellow-200">
                                <div className="text-purple-600 text-sm font-bold flex items-center gap-2"><Icon name="sparkles" size={16}/> è©¦è©¦ AI åŠŸèƒ½ï¼</div>
                                <div className="text-xs text-slate-500 p-2 bg-slate-50 rounded">
                                    é»æ“Šå³ä¸Šè§’ <span className="font-bold text-purple-600">AI åŠ©ç†</span><br/>
                                    ğŸ“¸ ä¸Šå‚³æˆäº¤æˆªåœ– -> è‡ªå‹•è¨˜å¸³<br/>
                                    ğŸ“ˆ ä¸Šå‚³åº«å­˜æˆªåœ– -> è‡ªå‹•æ›´æ–°è‚¡åƒ¹
                                </div>
                            </div>
                        </section>

                        <div className="bg-yellow-50 rounded-3xl p-6 shadow-2xl min-h-[500px] border-2 border-yellow-200">
                            <div className="flex gap-4 mb-6 border-b-2 border-yellow-200 pb-2 overflow-x-auto">
                                {[{ id: 'holdings', label: 'æŒæœ‰åº«å­˜', icon: 'briefcase' }, { id: 'timeline', label: 'é€²å‡ºæ™‚é–“è»¸', icon: 'history' }, { id: 'realized', label: 'å·²çµç®—è‚¡ç¥¨', icon: 'check' }].map(tab => (
                                    <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-3 rounded-xl font-bold text-lg transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-blue-600 text-white shadow-lg scale-105' : 'bg-white text-slate-500 hover:bg-yellow-100'}`}><Icon name={tab.icon} size={20} /> {tab.label}</button>
                                ))}
                            </div>
                            
                            {/* Holdings Tab */}
                            {activeTab === 'holdings' && (
                                <div className="space-y-4">
                                    <div className="flex gap-4 overflow-x-auto pb-4 w-full">
                                        {portfolio.holdings.length === 0 ? <div className="w-full text-center py-20 text-slate-400 font-bold text-xl border-4 border-dashed border-yellow-200 rounded-xl">ç›®å‰ç„¡åº«å­˜ï¼Œç­‰å¾…æŒ‡ä»¤...</div> : portfolio.holdings.map((stock, index) => (
                                            <div key={stock.code} onClick={() => setSelectedStockCode(selectedStockCode === stock.code ? null : stock.code)} className="min-w-[320px] bg-white rounded-2xl shadow-lg border-2 border-slate-100 overflow-hidden hover:border-blue-400 transition-colors cursor-pointer group flex-shrink-0">
                                                <div className="bg-slate-50 p-4 border-b border-slate-100 flex justify-between items-center">
                                                    <div className="flex items-center gap-3"><div className="bg-blue-600 text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm">{index + 1}</div><div><h3 className="text-xl font-bold text-slate-800 leading-none">{stock.name}</h3><div className="text-xs text-slate-500 mt-1 font-mono flex items-center gap-1">{stock.code}</div></div></div>
                                                    <div className="text-right cursor-pointer hover:bg-blue-50 p-1 rounded transition-colors group/price relative" title="é»æ“Šä¿®æ”¹è‚¡åƒ¹" onClick={(e) => handleManualPriceUpdate(e, stock.code, stock.currentPrice)}>
                                                        <div className="text-2xl font-bold font-mono text-slate-800 flex items-center justify-end gap-1">{stock.currentPrice}<Icon name="edit-2" size={14} className="text-blue-400 opacity-50 group-hover/price:opacity-100" /></div>
                                                        <div className="text-xs text-slate-400">æ”¶ç›¤åƒ¹</div>
                                                    </div>
                                                </div>
                                                <div className="p-4 space-y-4">
                                                    <div className="flex gap-2"><div className="flex-1 bg-blue-50 p-2 rounded-lg text-center border border-blue-100"><div className="text-[10px] text-blue-500 font-bold mb-1">è²·å…¥æ¬¡æ•¸</div><div className="text-xl font-bold text-blue-700">{stock.callSignalCount}</div></div><div className="flex-1 bg-purple-50 p-2 rounded-lg text-center border border-purple-100"><div className="text-[10px] text-purple-500 font-bold mb-1">æ–°æœƒå“¡</div><div className="text-xl font-bold text-purple-700">{stock.newMemberCount}</div></div></div>
                                                    <div className="bg-yellow-50 p-3 rounded-lg border border-yellow-100"><div className="text-[10px] text-yellow-600 font-bold mb-1 flex items-center gap-1"><Icon name="search" size={10}/> ç”¢æ¥­äº®é»</div><p className="text-sm text-slate-700 font-medium leading-relaxed">{stock.meta.highlight || 'æš«ç„¡è³‡æ–™'}</p></div>
                                                    <div className="grid grid-cols-2 gap-y-3 gap-x-4 text-sm">
                                                        <div><span className="text-slate-400 text-xs block">å‡åƒ¹æˆæœ¬</span><span className="font-mono font-bold text-slate-700">{formatDecimal(stock.avgCost)}</span></div><div className="text-right"><span className="text-slate-400 text-xs block">æŒæœ‰å¼µæ•¸</span><span className="font-mono font-bold text-slate-700">{stock.inventory / 1000}</span></div>
                                                        <div><span className="text-slate-400 text-xs block">è³‡é‡‘éƒ¨ä½</span><span className="font-mono font-bold text-slate-700">{formatPercent(stock.marketValue / INITIAL_CAPITAL)}</span></div><div className="text-right"><span className="text-slate-400 text-xs block">æç›Š</span><span className={`font-mono font-bold text-lg ${getColor(stock.unrealizedPL)}`}>{stock.unrealizedPL > 0 ? '+' : ''}{formatMoney(stock.unrealizedPL)}</span></div>
                                                    </div>
                                                </div>
                                                <div className="bg-slate-50 p-2 text-center text-xs text-slate-400 font-medium group-hover:bg-blue-50 group-hover:text-blue-500 transition-colors">{selectedStockCode === stock.code ? 'é»æ“Šæ”¶èµ·æ˜ç´°' : 'é»æ“ŠæŸ¥çœ‹äº¤æ˜“æ˜ç´°'}</div>
                                            </div>
                                        ))}
                                    </div>
                                    {selectedStockCode && (<div className="mt-4 bg-white rounded-xl shadow-lg border border-blue-200 overflow-hidden animate-fade-in"><div className="bg-blue-50 px-4 py-2 border-b border-blue-100 font-bold text-blue-800 flex justify-between"><span>{portfolio.holdings.find(s => s.code === selectedStockCode)?.name} ({selectedStockCode}) äº¤æ˜“æ˜ç´°</span><button onClick={() => setSelectedStockCode(null)}><Icon name="x" size={18}/></button></div><table className="w-full text-sm"><thead className="bg-slate-50 text-slate-500"><tr><th className="px-4 py-2 text-left">æ—¥æœŸ</th><th className="px-4 py-2 text-left">å‹•ä½œ</th><th className="px-4 py-2 text-right">æˆäº¤åƒ¹</th><th className="px-4 py-2 text-right">è‚¡æ•¸</th><th className="px-4 py-2 text-right">å‚™è¨»</th></tr></thead><tbody>{portfolio.holdings.find(s => s.code === selectedStockCode)?.history.map(t => (<tr key={t.id} className="border-b border-slate-50 hover:bg-slate-50"><td className="px-4 py-2 font-mono">{t.date}</td><td className="px-4 py-2"><span className={`px-2 py-0.5 rounded text-xs ${t.type === 'Buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>{t.type === 'Buy' ? 'è²·å…¥' : 'è³£å‡º'}</span></td><td className="px-4 py-2 text-right font-mono">{t.price}</td><td className="px-4 py-2 text-right font-mono">{t.qty}</td><td className="px-4 py-2 text-right text-slate-500 text-xs">{t.note}</td></tr>))}</tbody></table></div>)}
                                </div>
                            )}
                            
                            {/* Timeline Tab */}
                            {activeTab === 'timeline' && (<div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden overflow-x-auto"><table className="w-full min-w-[800px]"><thead className="bg-slate-100 text-slate-600 font-bold text-sm uppercase tracking-wider"><tr><th className="px-6 py-4 text-left">æ™‚é–“</th><th className="px-6 py-4 text-left">åç¨±</th><th className="px-6 py-4 text-center">å‹•ä½œ</th><th className="px-6 py-4 text-right">åƒ¹æ ¼</th><th className="px-6 py-4 text-right">è‚¡æ•¸</th><th className="px-6 py-4 text-left">å‚™è¨»</th><th className="px-6 py-4 text-center">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-slate-100">{[...transactions].sort((a,b) => new Date(b.date) - new Date(a.date)).map((t) => (<tr key={t.id} className="hover:bg-blue-50 transition-colors group"><td className="px-6 py-4 font-mono text-slate-600 font-medium">{t.date}</td><td className="px-6 py-4"><div className="font-bold text-slate-800 text-lg">{t.name}</div><div className="text-xs text-slate-400 font-mono">{t.code}</div></td><td className="px-6 py-4 text-center"><span className={`inline-block px-3 py-1 rounded-full text-sm font-bold shadow-sm ${t.type === 'Buy' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'}`}>{t.type === 'Buy' ? 'è²·é€²' : 'è³£å‡º'}</span></td><td className="px-6 py-4 text-right font-mono font-bold text-slate-700 text-lg">{formatDecimal(t.price)}</td><td className="px-6 py-4 text-right font-mono text-slate-500">{t.qty}</td><td className="px-6 py-4 text-slate-500 text-sm">{t.note}</td><td className="px-6 py-4 text-center"><button onClick={() => setEditingId(t.id)} className="p-2 text-slate-400 hover:text-blue-600 hover:bg-blue-100 rounded-full transition-all"><Icon name="edit-2" size={16} /></button></td></tr>))}</tbody></table></div>)}
                            
                            {/* Realized Tab */}
                            {activeTab === 'realized' && (<div className="grid grid-cols-1 md:grid-cols-2 gap-4">{portfolio.realizedStocks.length === 0 ? <div className="col-span-full text-center py-20 text-slate-400">å°šç„¡å·²çµç®—è‚¡ç¥¨</div> : portfolio.realizedStocks.map(stock => (<div key={stock.code} className="bg-white rounded-xl shadow-sm border border-slate-200 p-5 flex flex-col justify-between hover:shadow-md transition-shadow"><div className="flex justify-between items-start mb-4"><div><h3 className="text-lg font-bold text-slate-700">{stock.name} <span className="text-sm font-normal text-slate-400">({stock.code})</span></h3><span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded mt-1 inline-block">å·²æ¸…å€‰</span></div><div className={`text-2xl font-bold font-mono ${getColor(stock.totalPL)}`}>{stock.totalPL > 0 ? '+' : ''}{formatMoney(stock.totalPL)}</div></div><div className="bg-slate-50 rounded-lg p-3 text-xs space-y-1"><div className="text-slate-400 font-bold mb-2">æ­·å²æ“ä½œæ‘˜è¦</div>{stock.trades.map(t => (<div key={t.id} className="flex justify-between border-b border-slate-200 pb-1 last:border-0"><span className="font-mono text-slate-500">{t.date}</span><span className={t.type === 'Buy' ? 'text-red-600' : 'text-green-600'}>{t.type === 'Buy' ? 'è²·' : 'è³£'} {t.price} x {t.qty}</span></div>))}</div></div>))}</div>)}
                        </div>
                    </main>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockBillStrong />);
    </script>
</body>
</html>
