<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‚¡å¸‚æ¯”çˆ¾å¼· v5.5 AIæ——è‰¦ç‰ˆ</title>
    
    <!-- App è¨­å®š -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#facc15">
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. è¼‰å…¥ Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. è¼‰å…¥ Markdown è§£æ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 6. Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { overscroll-behavior-y: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        
        .bg-kline-pattern {
            background-color: #facc15;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 50v-10h2v10h-2zm0 20v-10h2v10h-2zm10-30v-15h2v15h-2zm0 25v-15h2v15h-2zm10 10v-20h2v20h-2zm0-30v-10h2v10h-2zm10 20v-25h2v25h-2zm0 15v-5h2v5h-2zm10-40v-10h2v10h-2zm0 45v-25h2v25h-2zm10-15v-10h2v10h-2zm0 20v-5h2v5h-2zm10-40v-5h2v5h-2zm0 35v-20h2v20h-2z' fill='%23ffffff' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .header-fun-pattern {
            background-color: #fbbf24;
            background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(255,255,255,0.2) 0%, transparent 20%),
                              url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Timeline specific styles */
        .timeline-line { position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; background: #3b82f6; border: 2px solid white; position: absolute; left: 15px; top: 24px; z-index: 10; }
    </style>
</head>
<body class="bg-kline-pattern select-none text-slate-800">
    <div id="root"></div>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        // ==================================================================================
        // ğŸ”´ æ‚¨çš„ Firebase è¨­å®š
        // ==================================================================================
        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBHZCCTR2pcISXTcFlKAQw-qCuss3tuVn4",
            authDomain: "billjohnloveu.firebaseapp.com",
            projectId: "billjohnloveu",
            storageBucket: "billjohnloveu.firebasestorage.app",
            messagingSenderId: "785959737628",
            appId: "1:785959737628:web:9cf63b00db322dd6ce82d9",
            measurementId: "G-QQ1HVNYMRS"
        };

        const rawConfig = window.__firebase_config;
        let activeConfig = MANUAL_FIREBASE_CONFIG;
        if (!activeConfig && rawConfig) { try { activeConfig = JSON.parse(rawConfig); } catch(e){} }

        let app, auth, db, appId;
        let isFirebaseAvailable = false;
        let globalLog = [];

        const addLog = (msg) => {
            console.log(msg);
            globalLog.unshift(`[${new Date().toLocaleTimeString()}] ${msg}`);
            if (globalLog.length > 20) globalLog.pop();
            window.dispatchEvent(new Event('logUpdated'));
        };

        if (activeConfig) {
            try {
                app = initializeApp(activeConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
                if (!window.__app_id && activeConfig.projectId) appId = activeConfig.projectId;
                isFirebaseAvailable = true;
                addLog(`Firebase åˆå§‹åŒ–æˆåŠŸ`);
            } catch (e) {
                addLog(`Firebase åˆå§‹åŒ–å¤±æ•—: ${e.message}`);
            }
        }

        const { useState, useMemo, useEffect, useRef } = React;

        const Icon = ({ name, size = 24, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const k = name.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
                    setIconNode(window.lucide.icons[k] || window.lucide.icons[Object.keys(window.lucide.icons).find(key => key.toLowerCase() === k.toLowerCase())] || window.lucide.icons.Circle);
                }
            }, [name]);
            if (!iconNode) return <span className={className} style={{width:size, height:size}} />;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300; 
                        const maxHeight = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const cleanAndParseJSON = (text) => {
            try { return JSON.parse(text); } 
            catch (e) {
                try {
                    let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleaned);
                } catch (e2) {
                    try {
                        const match = cleaned.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
                        if (match) return JSON.parse(match[0]);
                    } catch (e3) { return null; }
                }
            }
        };

        const parseTextLocally = (text, mode) => {
            const lines = text.split('\n');
            if (mode === 'prices') {
                const result = {};
                let currentCode = null;
                lines.forEach(line => {
                    const codeMatch = line.match(/[\(ï¼ˆ](\d{4})[\)ï¼‰]/);
                    if (codeMatch) currentCode = codeMatch[1];
                    const priceMatch = line.match(/è‚¡åƒ¹[:ï¼š]\s*([\d.]+)/);
                    if (currentCode && priceMatch) {
                        result[currentCode] = parseFloat(priceMatch[1]);
                        currentCode = null;
                    }
                });
                if (Object.keys(result).length === 0) {
                    lines.forEach(line => {
                        const parts = line.trim().split(/\s+/);
                        if (parts.length >= 2) {
                            const code = parts.find(p => /^\d{4}$/.test(p));
                            const price = parts.find(p => !isNaN(parseFloat(p)) && p !== code);
                            if (code && price) result[code] = parseFloat(price);
                        }
                    });
                }
                return Object.keys(result).length > 0 ? result : null;
            } else if (mode === 'transactions') {
                const result = [];
                const todayStr = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                lines.forEach(line => {
                    const codeMatch = line.match(/(.*?)[(ï¼ˆ](\d{4})[)ï¼‰](.*)/);
                    if (codeMatch) {
                        const rawName = codeMatch[1].trim().replace(/^[^a-zA-Z\u4e00-\u9fa5]+/, '');
                        const code = codeMatch[2];
                        const content = codeMatch[3];
                        let type = 'Buy', qty = 1000;
                        if (content.includes('è³£') || content.includes('å‡º') || content.includes('çµ')) type = 'Sell';
                        if (content.includes('å‰µæ–°é«˜') || content.includes('çºŒæŠ±') || content.includes('å…±è¥„ç››èˆ‰') || content.includes('æŒæœ‰')) qty = 0;
                        let price = 0;
                        const priceMatch = content.match(/(\d+(?:\.\d+)?)(?:[-~](\d+(?:\.\d+)?))?/);
                        if (priceMatch) {
                            price = priceMatch[2] ? (parseFloat(priceMatch[1]) + parseFloat(priceMatch[2])) / 2 : parseFloat(priceMatch[1]);
                        }
                        result.push({ date: todayStr, code: code, name: rawName, type: type, price: price, qty: qty, note: line.trim() });
                    }
                });
                return result.length > 0 ? result : null;
            }
            return null;
        };

        const getMarketStyle = (market) => {
            switch (market) {
                case 'ä¸Šå¸‚': return { badge: 'bg-blue-600 text-white', border: 'border-blue-600', text: 'text-blue-700', bg: 'bg-blue-50', icon: 'text-blue-500' };
                case 'ä¸Šæ«ƒ': return { badge: 'bg-emerald-600 text-white', border: 'border-emerald-600', text: 'text-emerald-700', bg: 'bg-emerald-50', icon: 'text-emerald-500' };
                case 'èˆˆæ«ƒ': return { badge: 'bg-rose-500 text-white', border: 'border-rose-500', text: 'text-rose-700', bg: 'bg-rose-50', icon: 'text-rose-500' };
                default: return { badge: 'bg-slate-600 text-white', border: 'border-slate-600', text: 'text-slate-700', bg: 'bg-slate-50', icon: 'text-slate-500' };
            }
        };

        const INITIAL_CAPITAL = 5000000;
        const INITIAL_META_DATA = {
            '8358': { market: 'ä¸Šæ«ƒ', industry: 'é›»å­é›¶çµ„ä»¶', highlight: 'éŠ…ç®”åŸºæ¿éœ€æ±‚å¼·å‹', thoughts: 'éŠ…ç®”åŸºæ¿éœ€æ±‚å¼·å‹ï¼ŒAIä¼ºæœå™¨å¸¶å‹•é«˜éšç”¢å“å‡ºè²¨ã€‚' },
            '3081': { market: 'ä¸Šæ«ƒ', industry: 'é€šä¿¡ç¶²è·¯', highlight: 'çŸ½å…‰å­é¡Œæ', thoughts: 'çŸ½å…‰å­ç‚ºæœªä¾†è¶¨å‹¢ï¼ŒæŒçºŒçœ‹å¥½é•·ç·šç™¼å±•ã€‚' },
            '5284': { market: 'ä¸Šå¸‚', industry: 'èˆªå¤ªå·¥æ¥­', highlight: 'æ¥­ç¸¾å‰µé«˜', thoughts: 'èˆªå¤ªå¾©ç”¦èˆ‡ä¼ºæœå™¨é›™å¼•æ“ï¼Œç‡Ÿæ”¶å¯æœŸã€‚' },
            '2360': { market: 'ä¸Šå¸‚', industry: 'å…¶ä»–é›»å­', highlight: 'ç²¾å¯†é‡æ¸¬å„€å™¨', thoughts: 'å…ˆé€²å°è£æª¢æ¸¬éœ€æ±‚å¤§å¢ï¼Œé¾é ­åœ°ä½ç©©å›ºã€‚' },
            '4722': { market: 'ä¸Šæ«ƒ', industry: 'åŒ–å­¸å·¥æ¥­', highlight: 'CoWoS ä¾›æ‡‰éˆ', thoughts: 'åˆ‡å…¥CoWoSä¾›æ‡‰éˆï¼Œè©•åƒ¹æœ‰é‡ä¼°ç©ºé–“ã€‚' },
            '8996': { market: 'ä¸Šå¸‚', industry: 'é›»æ©Ÿæ©Ÿæ¢°', highlight: 'ç†±ç®¡ç†å°ˆå®¶', thoughts: 'æ¶²å†·æ•£ç†±æ˜¯AIä¼ºæœå™¨æ¨™é…ï¼Œç‡Ÿæ”¶çˆ†ç™¼ã€‚' },
            '4931': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'BBU å‚™æ´é›»æ± ', thoughts: 'BBUéœ€æ±‚å› AIä¼ºæœå™¨è€Œèµ·ï¼ŒçŸ­ç·šå‹•èƒ½å¼·ã€‚' },
            '7853': { market: 'èˆˆæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'AOI æª¢æ¸¬', thoughts: 'èˆˆæ«ƒæ½›åŠ›è‚¡ï¼Œå—æƒ å…ˆé€²å°è£æ“´ç”¢ã€‚' },
            '7828': { market: 'èˆˆæ«ƒ', industry: 'è»Ÿé«”æœå‹™', highlight: 'æ•¸ä½è½‰å‹/è³‡å®‰', thoughts: 'æ•¸ä½è½‰å‹è¶¨å‹¢ä¸è®Šï¼Œè³‡å®‰ç‚ºå‰›æ€§éœ€æ±‚ã€‚' },
            '3017': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'æ•£ç†±æ¨¡çµ„', thoughts: '3D VCèˆ‡æ°´å†·æ¿å‡ºè²¨é †æš¢ï¼Œç²åˆ©å„ªæ–¼é æœŸã€‚' },
            '3324': { market: 'ä¸Šå¸‚', industry: 'é›»è…¦å‘¨é‚Š', highlight: 'æ°´å†·æ¿', thoughts: 'æ°´å†·æ¿å¸‚ä½”ç‡é«˜ï¼Œç‚ºä¸»è¦å—æƒ è€…ã€‚' },
            '4971': { market: 'ä¸Šæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'MBE ç ·åŒ–éµ', thoughts: 'åœ‹é˜²è¨‚å–®ç©©å®šï¼ŒåŠ ä¸Šè¡›æ˜Ÿé€šè¨Šéœ€æ±‚ã€‚' },
            '6788': { market: 'ä¸Šæ«ƒ', industry: 'åŠå°é«”æ¥­', highlight: 'AMC è¨­å‚™', thoughts: 'éš¨è‘—æ™¶åœ“å» æ“´å» ï¼Œå¾®æ±¡æŸ“é˜²æ²»éœ€æ±‚å¢ã€‚' },
            '7751': { market: 'èˆˆæ«ƒ', industry: 'åŠå°é«”è¨­å‚™', highlight: 'CoWoS æª¢æ¸¬', thoughts: 'CoWoSæ“´ç”¢è¨­å‚™äº¤æœŸé•·ï¼Œè¨‚å–®æ»¿æ‰‹ã€‚' },
            '3189': { market: 'ä¸Šå¸‚', industry: 'åŠå°é«”æ¥­', highlight: 'ABF è¼‰æ¿', thoughts: 'ABFè¼‰æ¿ç”¢æ¥­è½åº•å›å‡ï¼ŒAIæ™¶ç‰‡éœ€æ±‚å¸¶å‹•ã€‚' },
        };
        
        // åˆå§‹åƒ¹æ ¼ (å«å‰æ—¥æ”¶ç›¤) - å·²æ›´æ–°è‡³ 2026/1/19
        const INITIAL_PRICES = { 
            '8358': { price: 260.0, prev: 260.0 }, // å‡è¨­ç„¡è®Šå‹•
            '3081': { price: 618.0, prev: 618.0 },
            '5284': { price: 270.5, prev: 270.5 },
            '2360': { price: 856.0, prev: 856.0 },
            '4722': { price: 162.0, prev: 168.0 }, // 162 (è·Œ)
            '8996': { price: 577.0, prev: 577.0 },
            '4931': { price: 173.0, prev: 173.0 },
            '7853': { price: 113.5, prev: 113.5 },
            '7828': { price: 530.0, prev: 530.0 },
            '3017': { price: 1380.0, prev: 1380.0 },
            '3324': { price: 0.0, prev: 0.0 },
            '4971': { price: 338.5, prev: 292.5 }, // 338.5 (æ¼²)
            '6788': { price: 344.0, prev: 338.5 }, // 344 (æ¼²)
            '7751': { price: 820.0, prev: 838.0 }, // 820 (è·Œ)
            '3189': { price: 211.5, prev: 175.5 }  // 211.5 (å¤§æ¼²)
        };

        const INITIAL_TRANSACTIONS = [
            { id: 101, date: '2025/10/28', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 224, qty: 1000, note: '' },
            { id: 102, date: '2025/10/29', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 228, qty: 1000, note: '' },
            { id: 103, date: '2025/11/04', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 231.5, qty: 1000, note: '' },
            { id: 104, date: '2025/11/13', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 229, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘åƒ¹æ ¼æš«ä¼°' }, 
            { id: 105, date: '2025/11/18', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 227, qty: 1000, note: '' },
            { id: 106, date: '2025/12/02', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 230, qty: 1000, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 107, date: '2025/12/03', code: '8358', name: 'é‡‘å±…', type: 'Buy', price: 232, qty: 1000, note: '' },
            { id: 108, date: '2026/12/10', code: '8358', name: 'é‡‘å±…', type: 'Sell', price: 246.5, qty: 3500, note: 'è³£å‡ºä¸€åŠ' },
            { id: 109, date: '2026/12/22', code: '8358', name: 'é‡‘å±…', type: 'Sell', price: 260, qty: 3500, note: 'è³£å‡ºå…¨æ•¸' },
            // è¯äº (3081)
            { id: 201, date: '2025/10/30', code: '3081', name: 'è¯äº', type: 'Buy', price: 433.5, qty: 1000, note: '' },
            { id: 202, date: '2025/10/31', code: '3081', name: 'è¯äº', type: 'Buy', price: 433.5, qty: 1000, note: '' },
            { id: 203, date: '2025/11/18', code: '3081', name: 'è¯äº', type: 'Buy', price: 447, qty: 1000, note: '' },
            { id: 204, date: '2026/12/17', code: '3081', name: 'è¯äº', type: 'Sell', price: 602, qty: 1500, note: 'è³£å‡ºä¸€åŠ (ä¿®æ­£åƒ¹)' },
            { id: 205, date: '2027/01/05', code: '3081', name: 'è¯äº', type: 'Sell', price: 618, qty: 1500, note: 'è³£å‡ºå…¨æ•¸ (ä¿®æ­£åƒ¹)' },
            // JPP-KY (5284)
            { id: 301, date: '2025/11/07', code: '5284', name: 'JPP-KY', type: 'Buy', price: 296.5, qty: 1000, note: '' },
            { id: 302, date: '2025/11/13', code: '5284', name: 'JPP-KY', type: 'Buy', price: 0, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘éœ€è£œåƒ¹' },
            { id: 303, date: '2025/11/18', code: '5284', name: 'JPP-KY', type: 'Buy', price: 282, qty: 1000, note: '' },
            { id: 304, date: '2025/11/26', code: '5284', name: 'JPP-KY', type: 'Buy', price: 290, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 305, date: '2025/11/28', code: '5284', name: 'JPP-KY', type: 'Buy', price: 285, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 306, date: '2025/12/02', code: '5284', name: 'JPP-KY', type: 'Buy', price: 310, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 307, date: '2025/12/03', code: '5284', name: 'JPP-KY', type: 'Buy', price: 306, qty: 1000, note: '' },
            { id: 308, date: '2026/12/15', code: '5284', name: 'JPP-KY', type: 'Buy', price: 298, qty: 1000, note: '' },
            { id: 309, date: '2026/12/17', code: '5284', name: 'JPP-KY', type: 'Buy', price: 300, qty: 1000, note: '' },
            { id: 310, date: '2026/12/22', code: '5284', name: 'JPP-KY', type: 'Buy', price: 290, qty: 1000, note: '' },
            { id: 311, date: '2026/12/24', code: '5284', name: 'JPP-KY', type: 'Buy', price: 285, qty: 1000, note: '' },
            { id: 312, date: '2027/01/12', code: '5284', name: 'JPP-KY', type: 'Sell', price: 270.5, qty: 11000, note: 'è³£å‡ºå…¨æ•¸' },
            // è‡´èŒ‚ (2360)
            { id: 401, date: '2025/11/02', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 776.5, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 402, date: '2025/11/17', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 785, qty: 1000, note: '' },
            { id: 403, date: '2025/11/28', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 814, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 404, date: '2026/12/15', code: '2360', name: 'è‡´èŒ‚', type: 'Buy', price: 765, qty: 1000, note: '' },
            { id: 405, date: '2027/01/05', code: '2360', name: 'è‡´èŒ‚', type: 'Sell', price: 856, qty: 4000, note: 'è³£å‡ºå…¨æ•¸' },
            // åœ‹ç²¾åŒ– (4722)
            { id: 501, date: '2026/12/15', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 188.5, qty: 1000, note: '' },
            { id: 502, date: '2026/12/16', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 185, qty: 1000, note: '' },
            { id: 503, date: '2026/12/17', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 182, qty: 1000, note: '' },
            { id: 504, date: '2026/12/19', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 164, qty: 1000, note: '' },
            { id: 505, date: '2026/12/24', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 175, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 506, date: '2026/12/26', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 168, qty: 1000, note: '' },
            { id: 507, date: '2027/01/13', code: '4722', name: 'åœ‹ç²¾åŒ–', type: 'Buy', price: 168, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            // é«˜åŠ› (8996)
            { id: 601, date: '2026/12/23', code: '8996', name: 'é«˜åŠ›', type: 'Buy', price: 545, qty: 1000, note: '' },
            { id: 602, date: '2027/01/07', code: '8996', name: 'é«˜åŠ›', type: 'Sell', price: 577, qty: 1000, note: 'è³£å‡ºå…¨æ•¸' },
            // æ–°ç››åŠ› (4931)
            { id: 701, date: '2026/12/29', code: '4931', name: 'æ–°ç››åŠ›', type: 'Buy', price: 178, qty: 1000, note: '' },
            { id: 702, date: '2027/01/06', code: '4931', name: 'æ–°ç››åŠ›', type: 'Buy', price: 175, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 703, date: '2027/01/08', code: '4931', name: 'æ–°ç››åŠ›', type: 'Sell', price: 173, qty: 2000, note: 'è³£å‡ºå…¨æ•¸' },
            // æ”¿ç¾æ‡‰ç”¨ (7853)
            { id: 801, date: '2027/01/02', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 802, date: '2027/01/05', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 803, date: '2027/01/06', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 804, date: '2027/01/12', code: '7853', name: 'æ”¿ç¾æ‡‰ç”¨', type: 'Sell', price: 113.5, qty: 3000, note: 'è³£å‡ºå…¨æ•¸' },
            // å‰µæ–°æœå‹™ (7828)
            { id: 901, date: '2027/01/05', code: '7828', name: 'å‰µæ–°æœå‹™', type: 'Buy', price: 540, qty: 1000, note: '' },
            { id: 902, date: '2027/01/08', code: '7828', name: 'å‰µæ–°æœå‹™', type: 'Sell', price: 530, qty: 1000, note: 'è³£å‡ºå…¨æ•¸' },
            // å¥‡é‹ (3017)
            { id: 1001, date: '2027/01/07', code: '3017', name: 'å¥‡é‹', type: 'Buy', price: 1350, qty: 1000, note: '' },
            { id: 1002, date: '2027/01/08', code: '3017', name: 'å¥‡é‹', type: 'Buy', price: 1350, qty: 1000, note: '' },
            { id: 1003, date: '2027/01/14', code: '3017', name: 'å¥‡é‹', type: 'Buy', price: 1360, qty: 1000, note: 'åƒ¹æ ¼å–ä¸­é–“å€¼' },
            { id: 1004, date: '2027/01/15', code: '3017', name: 'å¥‡é‹', type: 'Sell', price: 1380, qty: 3000, note: 'è³£å‡ºå…¨æ•¸' },
            // é›™é´» (3324)
            { id: 1101, date: '2027/01/07', code: '3324', name: 'é›™é´»', type: 'Buy', price: 0, qty: 1000, note: 'ã€éœ€è£œåƒ¹ã€‘' },
            { id: 1102, date: '2027/01/08', code: '3324', name: 'é›™é´»', type: 'Buy', price: 0, qty: 1000, note: 'ã€éœ€è£œåƒ¹ã€‘' },
            { id: 1103, date: '2027/01/15', code: '3324', name: 'é›™é´»', type: 'Sell', price: 0, qty: 2000, note: 'ã€éœ€è£œåƒ¹ã€‘è³£å‡ºå…¨æ•¸' },
            // IET-KY (4971)
            { id: 1201, date: '2027/01/12', code: '4971', name: 'IET-KY', type: 'Buy', price: 309, qty: 1000, note: '' },
            { id: 1202, date: '2027/01/13', code: '4971', name: 'IET-KY', type: 'Buy', price: 295, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 1203, date: '2027/01/13', code: '4971', name: 'IET-KY', type: 'Buy', price: 292.5, qty: 1000, note: '' },
            // è¯æ™¯é›» (6788)
            { id: 1301, date: '2027/01/12', code: '6788', name: 'è¯æ™¯é›»', type: 'Buy', price: 353.5, qty: 1000, note: '' },
            { id: 1302, date: '2027/01/13', code: '6788', name: 'è¯æ™¯é›»', type: 'Buy', price: 340, qty: 0, note: 'ã€æ–°æœƒå“¡ã€‘' },
            { id: 1303, date: '2027/01/13', code: '6788', name: 'è¯æ™¯é›»', type: 'Buy', price: 338.5, qty: 1000, note: '' },
            // ç«‘é¨° (7751)
            { id: 1401, date: '2027/01/09', code: '7751', name: 'ç«‘é¨°', type: 'Buy', price: 722, qty: 1000, note: '' },
            { id: 1402, date: '2027/01/15', code: '7751', name: 'ç«‘é¨°', type: 'Buy', price: 838, qty: 1000, note: '' },
            // æ™¯ç¢© (3189)
            { id: 1501, date: '2027/01/15', code: '3189', name: 'æ™¯ç¢©', type: 'Buy', price: 175.5, qty: 1000, note: '' },
        ];

        const formatNumber = (val) => new Intl.NumberFormat('zh-TW').format(Math.round(val));
        const formatMoney = (val) => `$${formatNumber(val)}`;
        const formatDecimal = (val) => val ? val.toFixed(2) : '0.00';
        const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
        const getColor = (val) => val > 0 ? 'text-red-600' : val < 0 ? 'text-green-600' : 'text-slate-900';
        const getPriceColor = (current, ref) => current > ref ? 'text-red-600' : current < ref ? 'text-green-600' : 'text-slate-800';

        // --- Smart Input Modal ---
        const SmartInputModal = ({ onClose, onAnalyze, apiKey, setApiKey }) => {
            const [mode, setMode] = useState('transactions'); 
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [textInput, setTextInput] = useState('');

            const handleAnalyze = async () => {
                if (!textInput.trim()) { alert("è«‹è²¼ä¸Šæ–‡å­—æŒ‡ä»¤"); return; }
                if (!apiKey) { alert("è«‹å…ˆè¼¸å…¥ Gemini API Key"); return; }

                setIsAnalyzing(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-2.5-flash-preview-09-2025" });
                    
                    let prompt = "";
                    
                    if (mode === 'transactions') {
                        prompt = `ä½ æ˜¯ä¸€å€‹è‚¡ç¥¨äº¤æ˜“åŠ©æ‰‹ã€‚è«‹åˆ†æä»¥ä¸‹[è‘‰å®‡ä¹˜]çš„æ–‡å­—æŒ‡ä»¤ã€‚
                        è«‹æå–ï¼š
                        1. äº¤æ˜“è³‡è¨Š (è‹¥æœ‰): date(YYYY/MM/DD), code, name, type(Buy/Sell), price(æ•¸å€¼), qty(æ•¸å€¼, é è¨­1000)ã€‚
                        2. è‘‰å®‡ä¹˜çš„è©± (thoughts): æå–æŒ‡ä»¤ä¸­é—œæ–¼è©²è‚¡ç¥¨çš„åˆ†æã€å¿ƒå¾—ã€ç²åˆ©ç‹€æ³ç­‰æ–‡å­—ã€‚
                        
                        ç‰¹æ®Šè¦å‰‡ï¼š
                        - è‹¥æŒ‡ä»¤ç‚ºã€Œå¿ƒå¾—åˆ†äº«ã€æˆ–ã€Œçœ‹æ³•ã€è€Œç„¡æ˜ç¢ºè²·è³£ï¼Œå»ºç«‹ä¸€ç­† qty: 0 çš„ Buy äº¤æ˜“ï¼Œä¸¦å°‡åˆ†ææ”¾å…¥ thoughtsã€‚
                        - åƒ¹æ ¼è‹¥ç‚ºå€é–“ (69-70)ï¼Œå–å¹³å‡ã€‚
                        - note æ¬„ä½è«‹ä¿ç•™åŸå§‹æŒ‡ä»¤ã€‚
                        - **è‹¥æŒ‡ä»¤ä¸­å«æœ‰ã€Œæ–°æœƒå“¡ã€å­—æ¨£ï¼Œè«‹å°‡ qty è¨­ç‚º 0ï¼Œé€™éå¸¸é‡è¦ï¼**
                        
                        å›å‚³ JSON Arrayã€‚ç¯„ä¾‹ï¼š[{"date":"2026/01/20", "code":"8150", "name":"å—èŒ‚", "type":"Buy", "price":69.5, "qty":0, "note":"[è‘‰å®‡ä¹˜] æ–°æœƒå“¡...", "thoughts":"..."}]ã€‚
                        åªå›å‚³JSONã€‚
                        
                        æ–‡å­—å…§å®¹ï¼š
                        ${textInput}`;
                    } else {
                        prompt = `è«‹è¾¨è­˜ä»¥ä¸‹æ–‡å­—ä¸­çš„è‚¡ç¥¨æ¸…å–®èˆ‡åƒ¹æ ¼ã€‚
                        æå–ï¼šä»£è™Ÿ(code), æ”¶ç›¤åƒ¹(price), å‰æ—¥æ”¶ç›¤(prev)ã€‚
                        è‹¥ç„¡å‰æ—¥æ”¶ç›¤ï¼Œprev å¯è¨­ç‚º nullã€‚
                        å›å‚³ JSON Object: {"3189": {"price": 206.0, "prev": 211.5}, "4722": {"price": 169.5, "prev": 162.0}}ã€‚
                        åªå›å‚³JSONã€‚
                        æ–‡å­—å…§å®¹ï¼š
                        ${textInput}`;
                    }

                    const result = await model.generateContent([prompt]);
                    const response = await result.response;
                    const text = response.text();
                    const data = cleanAndParseJSON(text);
                    
                    if (data) {
                        onAnalyze(data, mode);
                        onClose();
                        alert("âœ… AI åˆ†æå®Œæˆä¸¦æ›´æ–°ï¼");
                    } else {
                        alert("âŒ AI ç„¡æ³•è§£æè³‡æ–™ã€‚");
                    }
                } catch (error) {
                    console.error("AI Error:", error);
                    alert("âŒ åˆ†æå¤±æ•—ï¼š" + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl p-6 relative flex flex-col max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                        <h2 className="text-xl font-bold flex items-center gap-2 mb-4 text-slate-800"><Icon name="bot" className="text-orange-600"/> æ™ºæ…§åŠ©ç†</h2>
                        
                        <div className="space-y-4 overflow-y-auto pr-2">
                            <div className="relative">
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Gemini API Key (å·²ç§»é™¤é è¨­å€¼)" className="w-full border rounded p-2 text-sm bg-slate-50"/>
                                <span className="absolute right-2 top-2 text-[10px] text-slate-400 bg-white px-1">è«‹å¡«å…¥æ–° Key</span>
                            </div>
                            
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setMode('transactions')} className={`flex-1 py-2 text-sm font-bold rounded transition-all ${mode==='transactions'?'bg-white shadow text-blue-600':'text-slate-500'}`}>æŒ‡ä»¤/å¿ƒå¾— (æ›´æ–°è‘‰å®‡ä¹˜çš„è©±)</button>
                                <button onClick={() => setMode('prices')} className={`flex-1 py-2 text-sm font-bold rounded transition-all ${mode==='prices'?'bg-white shadow text-blue-600':'text-slate-500'}`}>æ›´æ–°è‚¡åƒ¹</button>
                            </div>

                            <div className="space-y-3 pt-2">
                                <textarea 
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                    placeholder={mode === 'transactions' ? "è²¼ä¸Š [è‘‰å®‡ä¹˜] æŒ‡ä»¤...\nä¾‹å¦‚ï¼šå—èŒ‚(8150) æ˜¨å¤©çš„69-70é™„è¿‘ï¼Œå¯ä»¥åŠ ç¢¼ï¼Œé€™ç²åˆ©å¾ˆä¸éŒ¯ã€‚" : "è²¼ä¸Šè‚¡åƒ¹åˆ—è¡¨..."}
                                    className="w-full h-48 border rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none bg-slate-50"
                                ></textarea>
                            </div>

                            <button onClick={handleAnalyze} disabled={isAnalyzing} className="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mt-4 transition-all">
                                {isAnalyzing ? 'AI åˆ†æä¸­...' : <><Icon name="zap"/> é–‹å§‹åˆ†æ</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Settings Modal ---
        const CloudSettingsModal = ({ onClose, onConnect, currentRoom, apiKey, setApiKey, data, onRestore }) => {
            const [roomName, setRoomName] = useState(currentRoom || "default");
            const [logs, setLogs] = useState([]);

            useEffect(() => {
                const updateLogs = () => setLogs([...globalLog]);
                window.addEventListener('logUpdated', updateLogs);
                updateLogs();
                return () => window.removeEventListener('logUpdated', updateLogs);
            }, []);

            // åŒ¯å‡ºå‚™ä»½
            const handleExport = () => {
                const backupData = {
                    version: "5.5",
                    timestamp: new Date().toISOString(),
                    transactions: data.transactions,
                    prices: data.prices,
                    metaData: data.metaData,
                    settings: {
                        syncRoom: data.syncRoom,
                    }
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_bill_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // åŒ¯å…¥å‚™ä»½
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (!backup.transactions || !backup.prices) {
                            alert("ç„¡æ•ˆçš„å‚™ä»½æª”æ¡ˆæ ¼å¼");
                            return;
                        }
                        if (confirm(`ç¢ºå®šè¦å¾å‚™ä»½å›å¾©è³‡æ–™å—ï¼Ÿ\nå‚™ä»½æ™‚é–“: ${backup.timestamp}`)) {
                            onRestore(backup);
                            alert("è³‡æ–™å›å¾©æˆåŠŸï¼");
                        }
                    } catch (err) {
                        alert("è®€å–å‚™ä»½æª”æ¡ˆå¤±æ•—");
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="settings" className="text-slate-600"/> ç³»çµ±è¨­å®š</h2>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div className="space-y-4 overflow-y-auto pr-1">
                            <div><label className="block text-sm font-bold mb-1">åŒæ­¥æˆ¿é–“åç¨±</label><input type="text" value={roomName} onChange={(e)=>setRoomName(e.target.value)} className="w-full border rounded p-2"/></div>
                            <div><label className="block text-sm font-bold mb-1">Gemini API Key</label><input type="password" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} className="w-full border rounded p-2"/></div>
                            <button onClick={()=>{onConnect(roomName); onClose();}} className="w-full bg-blue-600 text-white font-bold py-2 rounded">å„²å­˜è¨­å®š & é€£ç·š</button>
                            
                            {/* å‚™ä»½é‚„åŸå°ˆå€ */}
                            <div className="pt-4 border-t border-slate-200">
                                <h3 className="text-sm font-bold text-slate-700 mb-2">è³‡æ–™å‚™ä»½èˆ‡é‚„åŸ</h3>
                                <div className="flex gap-2">
                                    <button onClick={handleExport} className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded flex items-center justify-center gap-1 border border-slate-300">
                                        <Icon name="download" size={16}/> åŒ¯å‡ºå‚™ä»½
                                    </button>
                                    <label className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded flex items-center justify-center gap-1 border border-slate-300 cursor-pointer">
                                        <Icon name="upload" size={16}/> åŒ¯å…¥é‚„åŸ
                                        <input type="file" accept=".json" onChange={handleImport} className="hidden"/>
                                    </label>
                                </div>
                            </div>

                            <div className="mt-4 border-t pt-4">
                                <h3 className="text-sm font-bold text-slate-700 mb-2">ç³»çµ±æ—¥èªŒ</h3>
                                <div className="bg-slate-900 text-green-400 font-mono text-xs p-3 rounded h-40 overflow-y-auto">
                                    {logs.length === 0 ? "å°šç„¡æ—¥èªŒ..." : logs.map((log, i) => <div key={i} className="mb-1 border-b border-slate-800 pb-1">{log}</div>)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Simple Holdings Modal ---
        const SimpleHoldingsModal = ({ holdings, onClose }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                <div className="bg-white rounded-2xl w-full max-w-4xl shadow-2xl p-6 relative max-h-[90vh] flex flex-col">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="table" className="text-orange-600"/> ç°¡æ˜“æŒè‚¡è¡¨</h2>
                    <div className="overflow-auto flex-1">
                        <table className="w-full text-left border-collapse min-w-[500px]">
                            <thead className="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th className="p-4 rounded-tl-lg font-bold">ç·¨è™Ÿ</th>
                                    <th className="p-4 font-bold">è‚¡å¸‚ä»£è™Ÿ</th>
                                    <th className="p-4 font-bold">è‚¡å¸‚åç¨±</th>
                                    <th className="p-4 text-right font-bold">è²·å…¥å‡åƒ¹</th>
                                    <th className="p-4 text-right rounded-tr-lg font-bold">å¼µæ•¸åŠè‚¡æ•¸</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-slate-800">
                                {holdings.map((stock, index) => {
                                    const marketStyle = getMarketStyle(stock.meta.market);
                                    return (
                                        <tr key={stock.code} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 font-bold text-slate-500">{index + 1}</td>
                                            <td className="p-4 font-mono font-bold text-lg">{stock.code}</td>
                                            <td className="p-4 font-bold text-xl">{stock.name}</td>
                                            <td className="p-4 text-right font-mono font-bold text-lg">{formatDecimal(stock.displayAvgCost)}</td>
                                            <td className="p-4 text-right">
                                                <span className="font-bold text-xl">{Math.floor(stock.inventory / 1000)}</span> <span className="text-sm text-slate-500 mr-2">å¼µ</span>
                                                {stock.inventory % 1000 > 0 && <span className="text-slate-500 font-mono">({stock.inventory % 1000} è‚¡)</span>}
                                            </td>
                                        </tr>
                                    );
                                })}
                                {holdings.length === 0 && <tr><td colSpan="5" className="p-12 text-center text-slate-400 text-lg font-bold">ç›®å‰ç„¡æŒè‚¡ï¼Œè«‹å»ºç«‹å€‰ä½ï¼</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // --- Edit Modal ---
        const EditTransactionModal = ({ transaction, onSave, onCancel }) => {
            const [formData, setFormData] = useState(transaction);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({...prev, [name]: (name==='price'||name==='qty')?parseFloat(value):value})); };
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">ç·¨è¼¯äº¤æ˜“</h3>
                        <div className="space-y-3">
                            <div><label className="text-xs">æ—¥æœŸ</label><input name="date" value={formData.date} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">ä»£è™Ÿ</label><input name="code" value={formData.code} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                                <div className="flex-1"><label className="text-xs">åç¨±</label><input name="name" value={formData.name} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">è²·è³£</label><select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div>
                                <div className="flex-1"><label className="text-xs">åƒ¹æ ¼</label><input type="number" name="price" value={formData.price} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div><label className="text-xs">è‚¡æ•¸</label><input type="number" name="qty" value={formData.qty} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div><label className="text-xs">å‚™è¨»</label><input name="note" value={formData.note} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                        </div>
                        <div className="mt-6 flex justify-end gap-2"><button onClick={onCancel} className="px-4 py-2 border rounded">å–æ¶ˆ</button><button onClick={()=>onSave(formData)} className="px-4 py-2 bg-blue-600 text-white rounded">å„²å­˜</button></div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const StockBillStrong = () => {
            const [activeTab, setActiveTab] = useState('holdings'); 
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
            
            // å‡ç´šç‰ˆ Prices State: æ”¯æ´ { price, prev, date } æˆ– å–®ç´” number (å…¼å®¹èˆŠè³‡æ–™)
            const [prices, setPrices] = useState(INITIAL_PRICES);
            
            // å‡ç´šç‰ˆ Meta Data: æ”¯æ´ thoughts
            const [metaData, setMetaData] = useState(INITIAL_META_DATA);

            const [userAvatar, setUserAvatar] = useState(null);
            const [geminiApiKey, setGeminiApiKey] = useState("AIzaSyDVIFDMODO28W2hW3Cfv7egUyO4LApzR50");
            const [syncRoom, setSyncRoom] = useState("default");
            const [isSyncing, setIsSyncing] = useState(false); 
            const [showCloudSettings, setShowCloudSettings] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showSimpleTable, setShowSimpleTable] = useState(false); 
            const [editingId, setEditingId] = useState(null);
            const [selectedStockCode, setSelectedStockCode] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());

            // ... (Auth & Sync Effects ä¿æŒä¸è®Šï¼Œçœç•¥ä»¥ç¯€çœé•·åº¦ï¼Œèˆ‡ v4.8 ç›¸åŒ) ...
            useEffect(() => {
                const initAuth = async () => {
                    if (isFirebaseAvailable) {
                        try {
                            const usingManualConfig = activeConfig === MANUAL_FIREBASE_CONFIG;
                            if (!usingManualConfig && window.__initial_auth_token) await signInWithCustomToken(auth, window.__initial_auth_token);
                            else await signInAnonymously(auth);
                            onAuthStateChanged(auth, (u) => { setUser(u); if(u) addLog(`ç”¨æˆ¶å·²ç™»å…¥`); });
                        } catch (error) { setUser({ uid: 'local-user' }); }
                    } else { setUser({ uid: 'local-user' }); }
                };
                initAuth();
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const savedKey = localStorage.getItem('stock_bill_gemini_key');
                if (savedKey) setGeminiApiKey(savedKey); 
                const savedRoom = localStorage.getItem('stock_bill_fb_room');
                if (savedRoom) { setSyncRoom(savedRoom); setIsSyncing(true); }
                const savedAvatar = localStorage.getItem('stock_bill_avatar');
                if (savedAvatar) setUserAvatar(savedAvatar); 
                if (!isFirebaseAvailable) {
                    const localTx = localStorage.getItem('stock_bill_transactions');
                    if(localTx) setTransactions(JSON.parse(localTx));
                    const localPrices = localStorage.getItem('stock_bill_prices');
                    if(localPrices) setPrices(JSON.parse(localPrices));
                    const localMeta = localStorage.getItem('stock_bill_meta');
                    if(localMeta) setMetaData(JSON.parse(localMeta));
                }
            }, []);

            // Sync Logic Update: Include metaData
            useEffect(() => {
                if (!user || !syncRoom || !isFirebaseAvailable) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.transactions) setTransactions(JSON.parse(data.transactions));
                        if (data.prices) setPrices(JSON.parse(data.prices));
                        if (data.metaData) setMetaData(JSON.parse(data.metaData));
                    } else if (isSyncing) {
                        setDoc(docRef, { 
                            transactions: JSON.stringify(transactions), 
                            prices: JSON.stringify(prices), 
                            metaData: JSON.stringify(metaData) 
                        }, { merge: true });
                    }
                });
                return () => unsubscribe();
            }, [user, syncRoom, isSyncing]);

            useEffect(() => {
                if (!user) return;
                if (isFirebaseAvailable && isSyncing) {
                    const saveData = async () => {
                        try {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                            await setDoc(docRef, { 
                                transactions: JSON.stringify(transactions), 
                                prices: JSON.stringify(prices),
                                metaData: JSON.stringify(metaData)
                            }, { merge: true });
                        } catch(e) { console.error(e); }
                    };
                    const t = setTimeout(saveData, 2000);
                    return () => clearTimeout(t);
                }
                localStorage.setItem('stock_bill_transactions', JSON.stringify(transactions));
                localStorage.setItem('stock_bill_prices', JSON.stringify(prices));
                localStorage.setItem('stock_bill_meta', JSON.stringify(metaData));
            }, [transactions, prices, metaData, user, isSyncing, syncRoom]);

            // Restore Data Function
            const handleRestore = (backup) => {
                if(backup.transactions) setTransactions(backup.transactions);
                if(backup.prices) setPrices(backup.prices);
                if(backup.metaData) setMetaData(backup.metaData);
                if(backup.settings?.syncRoom) setSyncRoom(backup.settings.syncRoom);
            };

            const handleAIResult = (data, mode) => {
                if (mode === 'transactions') {
                    if (Array.isArray(data) && data.length > 0) {
                        // 1. æ–°å¢äº¤æ˜“
                        const newTx = data.map(t => ({ ...t, id: Date.now() + Math.random() }));
                        setTransactions(prev => [...prev, ...newTx]);
                        
                        // 2. æ›´æ–°ã€è‘‰å®‡ä¹˜çš„è©±ã€‘
                        const newMeta = { ...metaData };
                        data.forEach(t => {
                            if (t.thoughts) {
                                if (!newMeta[t.code]) newMeta[t.code] = { market: 'ä¸Šå¸‚', industry: '', highlight: '' }; // é è¨­
                                newMeta[t.code].thoughts = t.thoughts; // è¦†è“‹æ›´æ–°
                            }
                        });
                        setMetaData(newMeta);
                        addLog(`æ›´æ–°äº¤æ˜“èˆ‡å¿ƒå¾—`);
                    }
                } else { // Prices Mode
                    if(typeof data === 'object') {
                        // æ”¯æ´ { current, prev } çµæ§‹
                        const newPrices = { ...prices };
                        Object.keys(data).forEach(code => {
                            const val = data[code];
                            if (typeof val === 'object' && val.price) {
                                newPrices[code] = { price: val.price, prev: val.prev || val.price };
                            } else {
                                // å…¼å®¹èˆŠæ ¼å¼ï¼šåªçµ¦åƒ¹æ ¼ï¼Œå‰æ—¥åƒ¹è¨­ç‚ºä»Šæ—¥åƒ¹(0æ¼²è·Œ)
                                newPrices[code] = { price: val, prev: val }; 
                            }
                        });
                        setPrices(newPrices);
                        addLog(`æ›´æ–°è‚¡åƒ¹`);
                    }
                }
            };

            const portfolio = useMemo(() => {
                const holdingsMap = {};
                const realizedMap = {};
                let realizedPL = 0;
                const sortedTrans = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTrans.forEach(t => {
                    if (!holdingsMap[t.code]) holdingsMap[t.code] = { 
                        code: t.code, name: t.name, inventory: 0, totalCost: 0, avgCost: 0, history: [], 
                        callSignalCount: 0, newMemberCount: 0, 
                        callSignalBuyCost: 0, callSignalBuyQty: 0
                    };
                    // åˆå§‹åŒ–å·²çµç®—: ç´€éŒ„è²·å…¥æ—¥æœŸç¯„åœã€ç¸½æˆæœ¬ã€ç¸½è‚¡æ•¸ã€ç¸½è³£å‡ºé‡‘é¡
                    if (!realizedMap[t.code]) realizedMap[t.code] = { 
                        code: t.code, name: t.name, totalPL: 0, trades: [], 
                        buyDates: [], sellDate: null, totalCost: 0, totalQty: 0, totalSellAmt: 0
                    };
                    
                    const stock = holdingsMap[t.code];
                    const realizedStock = realizedMap[t.code];
                    
                    stock.history.push(t);
                    realizedStock.trades.push(t);
                    const qty = t.qty || 1000;
                    
                    // æª¢æŸ¥æ˜¯å¦ç‚ºæ–°æœƒå“¡æŒ‡ä»¤
                    const isNewMember = t.qty === 0 || (t.note && t.note.includes('æ–°æœƒå“¡'));

                    if (t.type === 'Buy') {
                        if (isNewMember) {
                            stock.newMemberCount += 1;
                        } else {
                            stock.callSignalCount += 1;
                            stock.callSignalBuyCost += t.price * qty;
                            stock.callSignalBuyQty += qty;
                            
                            stock.totalCost += t.price * qty;
                            stock.inventory += qty;
                            stock.avgCost = stock.inventory > 0 ? stock.totalCost / stock.inventory : 0;
                            
                            // è¨˜éŒ„åˆ°å·²çµç®—è¿½è¹¤
                            realizedStock.buyDates.push(t.date);
                            realizedStock.totalCost += t.price * qty;
                            realizedStock.totalQty += qty;
                        }
                    } else { // Sell
                        if (stock.inventory > 0) {
                            const sellQty = Math.min(stock.inventory, qty); 
                            const profit = (t.price - stock.avgCost) * sellQty;
                            realizedPL += profit;
                            realizedStock.totalPL += profit;
                            realizedStock.totalSellAmt += t.price * sellQty;
                            realizedStock.sellDate = t.date; // æ›´æ–°æœ€å¾Œè³£å‡ºæ—¥
                            
                            stock.totalCost -= stock.avgCost * sellQty;
                            stock.inventory -= sellQty;
                        }
                    }
                });

                const holdings = Object.values(holdingsMap).filter(h => h.inventory > 0 || h.newMemberCount > 0 || h.callSignalCount > 0).map(h => {
                    // è™•ç†è‚¡åƒ¹çµæ§‹å…¼å®¹æ€§
                    const priceData = prices[h.code];
                    const currentPrice = priceData?.price || priceData || h.avgCost; // å…¼å®¹èˆŠæ ¼å¼
                    const prevPrice = priceData?.prev || currentPrice;
                    
                    const marketValue = currentPrice * h.inventory;
                    const unrealizedPL = (currentPrice - h.avgCost) * h.inventory;
                    const displayAvgCost = h.callSignalBuyQty > 0 ? (h.callSignalBuyCost / h.callSignalBuyQty) : 0;
                    const fundPercentage = (marketValue / INITIAL_CAPITAL) * 100;

                    // æ¼²è·Œå¹… (åŸºæ–¼å‰æ—¥æ”¶ç›¤)
                    const dailyChange = currentPrice - prevPrice;
                    const dailyChangePct = prevPrice > 0 ? (dailyChange / prevPrice) * 100 : 0;
                    
                    // ä¿®æ­£ ROI è¨ˆç®—ï¼šç•¶ avgCost ç‚º 0 æ™‚ï¼ˆä¾‹å¦‚æ–°æœƒå“¡ä¸”ç„¡åº«å­˜ï¼‰ï¼ŒROI ç‚º 0
                    const roi = h.avgCost > 0 ? ((currentPrice - h.avgCost) / h.avgCost) * 100 : 0;

                    const meta = metaData[h.code] || { market: 'ä¸Šå¸‚', industry: 'æœªåˆ†é¡', thoughts: '' };

                    // è‡ªå‹•æŠ“å–æœ€æ–°æ—¥æœŸ (ä»Šå¤©) èˆ‡ å‰æ—¥æ—¥æœŸ
                    const todayDate = new Date();
                    const yesterdayDate = new Date(todayDate);
                    yesterdayDate.setDate(yesterdayDate.getDate() - 1);

                    return { 
                        ...h, 
                        currentPrice, 
                        prevPrice, 
                        dailyChange, 
                        dailyChangePct, 
                        marketValue, 
                        unrealizedPL, 
                        displayAvgCost, 
                        fundPercentage, 
                        meta, 
                        roi,
                        todayDateStr: todayDate.toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}),
                        yesterdayDateStr: yesterdayDate.toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'})
                    };
                }).filter(h => h.inventory > 0); 

                // æ•´ç†å·²çµç®—å¡ç‰‡è³‡æ–™
                const realizedStocks = Object.values(realizedMap)
                    .filter(r => holdingsMap[r.code].inventory === 0 && r.totalPL !== 0)
                    .map(r => ({
                        ...r,
                        avgSellPrice: r.totalQty > 0 ? r.totalSellAmt / r.totalQty : 0,
                        avgCost: r.totalQty > 0 ? r.totalCost / r.totalQty : 0,
                        buyPeriod: r.buyDates.length > 0 ? `${r.buyDates[0]} ~ ${r.buyDates[r.buyDates.length-1]}` : 'N/A'
                    }));

                const totalMarketValue = holdings.reduce((sum, h) => sum + h.marketValue, 0);
                const totalUnrealizedPL = holdings.reduce((sum, h) => sum + h.unrealizedPL, 0);
                const totalEquity = INITIAL_CAPITAL + realizedPL + totalUnrealizedPL;
                const cash = totalEquity - totalMarketValue;
                const usageRate = totalEquity > 0 ? totalMarketValue / totalEquity : 0;
                return { holdings, realizedStocks, realizedPL, totalUnrealizedPL, totalEquity, totalMarketValue, usageRate, cash };
            }, [transactions, prices, metaData]);

            const handleAvatarUpload = async (e) => {
                const f = e.target.files[0];
                if(f) { const b = await compressImage(f); setUserAvatar(b); localStorage.setItem('stock_bill_avatar', b); }
            };

            return (
                <div className="min-h-screen font-sans text-slate-900 pb-10 relative">
                    {/* ... (Modals çœç•¥ï¼Œèˆ‡ v4.8 ç›¸åŒï¼Œåƒ…éœ€æ³¨æ„ AIGeminiModal çš„ Prompt å·²åœ¨ä¸Šé¢æ›´æ–°) ... */}
                    {editingId && <EditTransactionModal transaction={transactions.find(t => t.id === editingId)} onSave={(updatedTx) => {setTransactions(prev => prev.map(t => t.id === updatedTx.id ? updatedTx : t)); setEditingId(null);}} onCancel={() => setEditingId(null)} />}
                    {showCloudSettings && <CloudSettingsModal onClose={() => setShowCloudSettings(false)} onConnect={(room)=>{setSyncRoom(room);setIsSyncing(true);}} currentRoom={syncRoom} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} data={{transactions, prices, metaData, syncRoom, geminiApiKey}} onRestore={handleRestore} />}
                    {showAIModal && <SmartInputModal onClose={() => setShowAIModal(false)} onAnalyze={handleAIResult} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {showSimpleTable && <SimpleHoldingsModal holdings={portfolio.holdings} onClose={() => setShowSimpleTable(false)} />}

                    <header className="bg-yellow-400 shadow-xl border-b-4 border-orange-500 sticky top-0 z-40 header-fun-pattern">
                        {/* ... (Header ä¿æŒä¸è®Š) ... */}
                        <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center relative z-10 gap-4">
                            <div className="flex items-center gap-4">
                                <label className="relative cursor-pointer group flex-shrink-0 z-50" title="é»æ“Šæ›´æ›é ­è²¼ (è‡ªå‹•å„²å­˜)">
                                    <div className="w-16 h-16 rounded-full border-4 border-orange-500 bg-white overflow-hidden shadow-xl flex items-center justify-center">
                                        {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <Icon name="user" size={40} className="text-slate-300" />}
                                    </div>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleAvatarUpload} />
                                </label>
                                <div>
                                    <h1 className="text-6xl md:text-7xl font-extrabold text-blue-800 tracking-wide ml-8 drop-shadow-2xl" style={{ textShadow: '4px 4px 0px #fff' }}>è‚¡å¸‚æ¯”çˆ¾å¼·</h1>
                                    <p className="text-lg font-bold text-white tracking-widest ml-9 mt-1 drop-shadow-md">ç”¢æ¥­è¶¨å‹¢æŒ–æ˜è€…</p>
                                    <p className="text-sm font-bold bg-orange-600 text-white inline-block px-2 transform -skew-x-12 mt-2 ml-9">v5.5 AI æ——è‰¦ç‰ˆ</p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setShowCloudSettings(true)}>
                                    <div className={`flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold shadow-sm backdrop-blur ${isFirebaseAvailable ? 'bg-green-100/90 text-green-700 border border-green-300' : 'bg-red-100/90 text-red-700 border border-red-300'}`}>
                                        <div className={`w-2 h-2 rounded-full ${isFirebaseAvailable ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                        {isFirebaseAvailable ? 'é›²ç«¯åŒæ­¥ä¸­' : 'å–®æ©Ÿæ¨¡å¼'}
                                    </div>
                                    <div className="text-right text-slate-800 font-bold bg-white/40 backdrop-blur px-3 py-1 rounded-lg border border-slate-800/20 shadow-sm">ç”¨500è¬å¾2025/10/28æ—¥é–‹å§‹æ¨¡æ“¬æ“ä½œ</div>
                                </div>
                                <div className="text-right text-orange-900 font-bold font-mono"><div className="text-xl">{currentTime.toLocaleTimeString()}</div><div className="text-xs">{currentTime.toLocaleDateString()}</div></div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSimpleTable(true)} className="bg-orange-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white flex items-center gap-1 hover:bg-orange-700 transition-colors"><Icon name="table" size={14}/> ç°¡æ˜“æŒè‚¡è¡¨</button>
                                    <button onClick={() => setShowAIModal(true)} className="bg-purple-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white/50 flex items-center gap-1 hover:bg-purple-700 transition-colors"><Icon name="bot" size={14}/> æ™ºæ…§åŠ©ç†</button>
                                    <button onClick={() => setShowCloudSettings(true)} className={`font-bold text-xs px-3 py-2 rounded flex items-center gap-1 shadow-md text-white ${isSyncing?'bg-green-600':'bg-slate-400'}`}><Icon name="settings" size={14}/> {isSyncing ? syncRoom : 'è¨­å®š'}</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        <section className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            {/* è³‡ç”¢å¡ç‰‡ */}
                            <div className="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-5 text-slate-800 shadow-lg border-4 border-yellow-300 relative overflow-hidden">
                                <Icon name="wallet" size={80} className="absolute -right-4 -top-4 opacity-10 text-orange-600"/>
                                <p className="text-slate-500 text-xs font-bold uppercase mb-1">ç¸½è³‡ç”¢</p>
                                <h2 className="text-3xl font-black text-slate-900 mb-2">{formatMoney(portfolio.totalMarketValue)}</h2>
                                <div className="flex justify-between items-end border-t border-yellow-300 pt-2">
                                    <div><p className="text-slate-500 text-xs font-bold">ç¾é‡‘</p><span className="font-mono font-bold text-slate-700">{formatMoney(portfolio.cash)}</span></div>
                                    <div className="text-right"><span className="text-xs text-slate-500 block">æ°´ä½</span><span className="text-xl font-bold text-orange-600">{formatPercent(portfolio.usageRate)}</span></div>
                                </div>
                            </div>
                            
                            {/* æç›Šå¡ç‰‡ */}
                            <div className="md:col-span-2 bg-yellow-50 rounded-2xl p-6 shadow-xl flex items-center justify-around border-4 border-slate-200">
                                <div className="text-center w-1/2 border-r-2 border-slate-100 pr-4">
                                    <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wide">æœªå¯¦ç¾æç›Š</p>
                                    <div className={`text-3xl font-black tracking-tight ${getColor(portfolio.totalUnrealizedPL)}`}>
                                        {portfolio.totalUnrealizedPL > 0 ? '+' : ''}{formatMoney(portfolio.totalUnrealizedPL)}
                                    </div>
                                </div>
                                <div className="text-center w-1/2 pl-4">
                                    <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wide">å·²å¯¦ç¾æç›Š</p>
                                    <div className={`text-3xl font-black tracking-tight ${getColor(portfolio.realizedPL)}`}>
                                        {portfolio.realizedPL > 0 ? '+' : ''}{formatMoney(portfolio.realizedPL)}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-yellow-200 flex flex-col justify-center gap-2">
                                <div className="text-purple-600 font-bold flex items-center gap-2"><Icon name="bot" size={16}/> æ™ºæ…§åŠ©ç†</div>
                                <p className="text-xs text-slate-500">è²¼ä¸ŠæŒ‡ä»¤ï¼ŒAI è‡ªå‹•åˆ†æä¸¦æ›´æ–°ã€è‘‰å®‡ä¹˜çš„è©±ã€‘ã€‚</p>
                            </div>
                        </section>

                        <div className="bg-yellow-50/80 backdrop-blur-sm rounded-3xl p-6 shadow-xl border-2 border-yellow-200 min-h-[500px]">
                            <div className="flex gap-4 mb-6 border-b-2 border-yellow-200 pb-2 overflow-x-auto">
                                {[{id:'holdings',label:'æŒæœ‰åº«å­˜',icon:'briefcase'},{id:'timeline',label:'äº¤æ˜“ç´€éŒ„',icon:'history'},{id:'realized',label:'å·²çµç®—',icon:'check'}].map(tab=>(
                                    <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold transition-all whitespace-nowrap ${activeTab===tab.id?'bg-orange-600 text-white shadow-lg':'bg-white text-slate-500 hover:bg-yellow-100'}`}><Icon name={tab.icon} size={18}/> {tab.label}</button>
                                ))}
                            </div>

                            {activeTab === 'holdings' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {portfolio.holdings.map((stock, i) => {
                                        const marketStyle = getMarketStyle(stock.meta.market);
                                        return (
                                        <div key={stock.code} onClick={()=>setSelectedStockCode(selectedStockCode===stock.code?null:stock.code)} className="bg-white rounded-2xl shadow-xl border border-slate-100 hover:shadow-2xl transition-all cursor-pointer overflow-hidden flex flex-col group relative">
                                            
                                            {/* Top Banner (Ticker Style) */}
                                            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white relative z-10">
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded shadow-sm ${marketStyle.badge}`}>{stock.meta.market}</span>
                                                        <span className="font-mono text-slate-400 text-xs font-bold">{stock.code}</span>
                                                        <a href={`https://www.cmoney.tw/forum/stock/${stock.code}`} target="_blank" onClick={(e)=>e.stopPropagation()} className="text-gray-300 hover:text-blue-500 ml-1"><Icon name="external-link" size={14} /></a>
                                                    </div>
                                                    <div className="font-black text-2xl text-slate-800 tracking-tight mt-1">{stock.name}</div>
                                                </div>
                                                
                                                {/* Price Display */}
                                                <div className="text-right" title="é»æ“Šä¿®æ”¹æ”¶ç›¤åƒ¹" onClick={(e)=>{e.stopPropagation(); const p=prompt('è¼¸å…¥æ–°æ”¶ç›¤åƒ¹',stock.currentPrice); if(p) setPrices(prev=>({...prev,[stock.code]:{price:parseFloat(p), prev: stock.prevPrice}}));}}>
                                                    <div className="text-[10px] text-slate-400 mb-0.5 flex items-center justify-end gap-1">æ”¶ç›¤åƒ¹ <span className="font-mono">{currentTime.toLocaleDateString()}</span></div>
                                                    <div className={`text-3xl font-black font-mono leading-none ${getPriceColor(stock.currentPrice, stock.prevPrice)}`}>
                                                        {stock.currentPrice}
                                                    </div>
                                                    <div className={`text-xs font-bold mt-1 flex justify-end gap-1 ${getColor(stock.dailyChange)}`}>
                                                        {stock.dailyChange > 0 ? 'â–²' : 'â–¼'} {Math.abs(stock.dailyChange)} ({Math.abs(stock.dailyChangePct).toFixed(2)}%)
                                                    </div>
                                                    <div className="text-[10px] text-slate-300 mt-1 flex items-center justify-end gap-1 hover:text-blue-500" onClick={(e)=>{e.stopPropagation(); const p=prompt('ä¿®æ­£å‰æ—¥æ”¶ç›¤åƒ¹',stock.prevPrice); if(p) setPrices(prev=>({...prev,[stock.code]:{price: stock.currentPrice, prev:parseFloat(p)}}));}}>
                                                        å‰æ—¥({stock.yesterdayDateStr})æ”¶ç›¤: {stock.prevPrice}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Middle Stats Grid */}
                                            <div className="p-4 bg-slate-50/50">
                                                <div className="grid grid-cols-2 gap-y-3 gap-x-4 text-sm">
                                                    <div>
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">æ‘³è¨Šå‡åƒ¹</span>
                                                        <span className="font-bold text-lg text-slate-700 font-mono">{formatDecimal(stock.displayAvgCost)}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">åº«å­˜</span>
                                                        <span className="font-bold text-lg text-slate-800">{Math.floor(stock.inventory/1000)}<span className="text-xs text-slate-500">å¼µ</span> <span className="text-xs text-slate-400 font-mono">({stock.inventory})</span></span>
                                                    </div>
                                                    <div>
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">è³‡é‡‘éƒ¨ä½</span>
                                                        <div className="flex items-center gap-2">
                                                            <div className="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
                                                                <div className="h-full bg-blue-500 rounded-full" style={{width: `${Math.min(stock.fundPercentage, 100)}%`}}></div>
                                                            </div>
                                                            <span className="font-bold text-xs text-slate-600 font-mono">{Math.round(stock.fundPercentage)}%</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">æœªå¯¦ç¾æç›Š</span>
                                                        <span className={`font-black text-lg font-mono ${getColor(stock.unrealizedPL)}`}>{stock.unrealizedPL > 0 ? '+' : ''}{formatNumber(stock.unrealizedPL)}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bottom Notes - è‘‰å®‡ä¹˜çš„è©± */}
                                            <div className="p-4 space-y-2 border-t border-slate-100 bg-white">
                                                <div className="bg-slate-50 text-slate-700 text-sm p-3 rounded-xl border border-slate-200 leading-relaxed relative mt-2">
                                                    <div className="absolute -top-2 -left-1 bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">è‘‰å®‡ä¹˜çš„è©±</div>
                                                    <p className="mt-1 text-xs italic">{stock.meta.thoughts || 'å°šç„¡ç­†è¨˜'}</p>
                                                </div>
                                                <p className="text-[10px] text-slate-400 text-right">ç”¢æ¥­äº®é»ï¼š{stock.meta.highlight}</p>
                                            </div>
                                        </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* ... (äº¤æ˜“ç´€éŒ„å€å¡Šä¿æŒä¸è®Š) ... */}
                            {activeTab === 'timeline' && (
                                <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-8 relative min-h-[400px]">
                                    <div className="timeline-line"></div>
                                    <div className="space-y-8 pl-12">
                                        {[...transactions]
                                            .filter(t => !t.note.includes('æ–°æœƒå“¡'))
                                            .sort((a,b)=>new Date(b.date)-new Date(a.date))
                                            .map(t => (
                                                <div key={t.id} className="relative group">
                                                    <div className={`timeline-dot ${t.type === 'Buy' ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                                    <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative">
                                                        <div className="absolute -left-3 top-4 w-3 h-3 bg-white border-b border-l border-slate-100 transform rotate-45"></div>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <span className="font-mono text-xs text-slate-400 font-bold">{t.date}</span>
                                                                <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                                                    {t.name} <span className="text-xs font-normal text-slate-400">({t.code})</span>
                                                                </h4>
                                                            </div>
                                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${t.type === 'Buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                                {t.type === 'Buy' ? 'è²·å…¥' : 'è³£å‡º'}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between text-sm font-mono text-slate-600">
                                                            <span>{formatDecimal(t.price)} x {t.qty}</span>
                                                            <span>{t.note}</span>
                                                        </div>
                                                        <button onClick={()=>setEditingId(t.id)} className="absolute right-4 bottom-4 text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="edit-2" size={14}/></button>
                                                    </div>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                            )}

                            {/* å·²çµç®— æ˜ç´°å¡ç‰‡ */}
                            {activeTab === 'realized' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {portfolio.realizedStocks.map(stock => (
                                        <div key={stock.code} className="bg-white rounded-xl shadow-lg border border-slate-200 p-0 overflow-hidden flex flex-col">
                                            <div className="bg-slate-100 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                                                <div>
                                                    <div className="text-xs text-slate-400 font-bold">{stock.code}</div>
                                                    <div className="text-xl font-bold text-slate-700">{stock.name}</div>
                                                </div>
                                                <div className={`text-2xl font-black font-mono ${getColor(stock.totalPL)}`}>
                                                    {stock.totalPL > 0 ? '+' : ''}{formatMoney(stock.totalPL)}
                                                </div>
                                            </div>
                                            <div className="p-5 space-y-3 text-sm">
                                                <div className="flex justify-between border-b border-slate-50 pb-2">
                                                    <span className="text-slate-400">æ“ä½œæœŸé–“</span>
                                                    <span className="font-mono font-bold text-slate-600">{stock.buyPeriod}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">ç¸½æˆæœ¬</span>
                                                    <span className="font-mono">{formatMoney(stock.totalCost)}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">ç¸½å¼µæ•¸</span>
                                                    <span className="font-mono">{stock.totalQty/1000} å¼µ</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">å¹³å‡è³£åƒ¹</span>
                                                    <span className="font-mono font-bold text-blue-600">{formatDecimal(stock.avgSellPrice)}</span>
                                                </div>
                                                <div className="flex justify-between pt-2 border-t border-slate-100">
                                                    <span className="text-slate-400">ç²åˆ©ç‡</span>
                                                    <span className={`font-bold ${getColor(stock.totalPL)}`}>
                                                        {((stock.totalPL / stock.totalCost) * 100).toFixed(2)}%
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockBillStrong />);
    </script>
</body>
</html>
