<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>股市比爾強 v5.4 AI旗艦版</title>
    
    <!-- App 設定 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#facc15">
    
    <!-- 1. 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. 載入 React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. 載入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. 載入 Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. 載入 Markdown 解析 -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 6. Firebase SDK (CDN) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; -webkit-tap-highlight-color: transparent; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        html, body { overscroll-behavior-y: none; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        
        .bg-kline-pattern {
            background-color: #facc15;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M10 50v-10h2v10h-2zm0 20v-10h2v10h-2zm10-30v-15h2v15h-2zm0 25v-15h2v15h-2zm10 10v-20h2v20h-2zm0-30v-10h2v10h-2zm10 20v-25h2v25h-2zm0 15v-5h2v5h-2zm10-40v-10h2v10h-2zm0 45v-25h2v25h-2zm10-15v-10h2v10h-2zm0 20v-5h2v5h-2zm10-40v-5h2v5h-2zm0 35v-20h2v20h-2z' fill='%23ffffff' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        .header-fun-pattern {
            background-color: #fbbf24;
            background-image: radial-gradient(circle at 10% 20%, rgba(255,255,255,0.2) 0%, transparent 20%),
                              radial-gradient(circle at 90% 80%, rgba(255,255,255,0.2) 0%, transparent 20%),
                              url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.15'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Timeline specific styles */
        .timeline-line { position: absolute; left: 20px; top: 0; bottom: 0; width: 2px; background: #e2e8f0; }
        .timeline-dot { width: 12px; height: 12px; border-radius: 50%; background: #3b82f6; border: 2px solid white; position: absolute; left: 15px; top: 24px; z-index: 10; }
    </style>
</head>
<body class="bg-kline-pattern select-none text-slate-800">
    <div id="root"></div>

    <script type="importmap">
      {
        "imports": {
          "@google/generative-ai": "https://esm.run/@google/generative-ai"
        }
      }
    </script>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "@google/generative-ai";

        const MANUAL_FIREBASE_CONFIG = {
            apiKey: "AIzaSyBHZCCTR2pcISXTcFlKAQw-qCuss3tuVn4",
            authDomain: "billjohnloveu.firebaseapp.com",
            projectId: "billjohnloveu",
            storageBucket: "billjohnloveu.firebasestorage.app",
            messagingSenderId: "785959737628",
            appId: "1:785959737628:web:9cf63b00db322dd6ce82d9",
            measurementId: "G-QQ1HVNYMRS"
        };

        const rawConfig = window.__firebase_config;
        let activeConfig = MANUAL_FIREBASE_CONFIG;
        if (!activeConfig && rawConfig) { try { activeConfig = JSON.parse(rawConfig); } catch(e){} }

        let app, auth, db, appId;
        let isFirebaseAvailable = false;
        let globalLog = [];

        const addLog = (msg) => {
            console.log(msg);
            globalLog.unshift(`[${new Date().toLocaleTimeString()}] ${msg}`);
            if (globalLog.length > 20) globalLog.pop();
            window.dispatchEvent(new Event('logUpdated'));
        };

        if (activeConfig) {
            try {
                app = initializeApp(activeConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
                if (!window.__app_id && activeConfig.projectId) appId = activeConfig.projectId;
                isFirebaseAvailable = true;
                addLog(`Firebase 初始化成功`);
            } catch (e) {
                addLog(`Firebase 初始化失敗: ${e.message}`);
            }
        }

        const { useState, useMemo, useEffect, useRef } = React;

        const Icon = ({ name, size = 24, className }) => {
            const [iconNode, setIconNode] = useState(null);
            useEffect(() => {
                if (window.lucide && window.lucide.icons) {
                    const k = name.split('-').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join('');
                    setIconNode(window.lucide.icons[k] || window.lucide.icons[Object.keys(window.lucide.icons).find(key => key.toLowerCase() === k.toLowerCase())] || window.lucide.icons.Circle);
                }
            }, [name]);
            if (!iconNode) return <span className={className} style={{width:size, height:size}} />;
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {iconNode.map((child, index) => React.createElement(child[0], { ...child[1], key: index }))}
                </svg>
            );
        };

        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        const maxWidth = 300; 
                        const maxHeight = 300;
                        let width = img.width;
                        let height = img.height;
                        if (width > height) { if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; } } else { if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; } }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', 0.8));
                    };
                    img.onerror = reject;
                };
                reader.onerror = reject;
            });
        };

        const cleanAndParseJSON = (text) => {
            try { return JSON.parse(text); } 
            catch (e) {
                try {
                    let cleaned = text.replace(/```json/g, '').replace(/```/g, '').trim();
                    return JSON.parse(cleaned);
                } catch (e2) {
                    try {
                        const match = cleaned.match(/(\{[\s\S]*\}|\[[\s\S]*\])/);
                        if (match) return JSON.parse(match[0]);
                    } catch (e3) { return null; }
                }
            }
        };

        const parseTextLocally = (text, mode) => {
            const lines = text.split('\n');
            if (mode === 'prices') {
                const result = {};
                let currentCode = null;
                lines.forEach(line => {
                    const codeMatch = line.match(/[\(（](\d{4})[\)）]/);
                    if (codeMatch) currentCode = codeMatch[1];
                    const priceMatch = line.match(/股價[:：]\s*([\d.]+)/);
                    if (currentCode && priceMatch) {
                        result[currentCode] = parseFloat(priceMatch[1]);
                        currentCode = null;
                    }
                });
                if (Object.keys(result).length === 0) {
                    lines.forEach(line => {
                        const parts = line.trim().split(/\s+/);
                        if (parts.length >= 2) {
                            const code = parts.find(p => /^\d{4}$/.test(p));
                            const price = parts.find(p => !isNaN(parseFloat(p)) && p !== code);
                            if (code && price) result[code] = parseFloat(price);
                        }
                    });
                }
                return Object.keys(result).length > 0 ? result : null;
            } else if (mode === 'transactions') {
                const result = [];
                const todayStr = new Date().toISOString().split('T')[0].replace(/-/g, '/');
                lines.forEach(line => {
                    const codeMatch = line.match(/(.*?)[(（](\d{4})[)）](.*)/);
                    if (codeMatch) {
                        const rawName = codeMatch[1].trim().replace(/^[^a-zA-Z\u4e00-\u9fa5]+/, '');
                        const code = codeMatch[2];
                        const content = codeMatch[3];
                        let type = 'Buy', qty = 1000;
                        if (content.includes('賣') || content.includes('出') || content.includes('結')) type = 'Sell';
                        if (content.includes('創新高') || content.includes('續抱') || content.includes('共襄盛舉') || content.includes('持有')) qty = 0;
                        let price = 0;
                        const priceMatch = content.match(/(\d+(?:\.\d+)?)(?:[-~](\d+(?:\.\d+)?))?/);
                        if (priceMatch) {
                            price = priceMatch[2] ? (parseFloat(priceMatch[1]) + parseFloat(priceMatch[2])) / 2 : parseFloat(priceMatch[1]);
                        }
                        result.push({ date: todayStr, code: code, name: rawName, type: type, price: price, qty: qty, note: line.trim() });
                    }
                });
                return result.length > 0 ? result : null;
            }
            return null;
        };

        const getMarketStyle = (market) => {
            switch (market) {
                case '上市': return { badge: 'bg-blue-600 text-white', border: 'border-blue-600', text: 'text-blue-700', bg: 'bg-blue-50', icon: 'text-blue-500' };
                case '上櫃': return { badge: 'bg-emerald-600 text-white', border: 'border-emerald-600', text: 'text-emerald-700', bg: 'bg-emerald-50', icon: 'text-emerald-500' };
                case '興櫃': return { badge: 'bg-rose-500 text-white', border: 'border-rose-500', text: 'text-rose-700', bg: 'bg-rose-50', icon: 'text-rose-500' };
                default: return { badge: 'bg-slate-600 text-white', border: 'border-slate-600', text: 'text-slate-700', bg: 'bg-slate-50', icon: 'text-slate-500' };
            }
        };

        const INITIAL_CAPITAL = 5000000;
        const INITIAL_META_DATA = {
            '8358': { market: '上櫃', industry: '電子零組件', highlight: '銅箔基板需求強勁', thoughts: '銅箔基板需求強勁，AI伺服器帶動高階產品出貨。' },
            '3081': { market: '上櫃', industry: '通信網路', highlight: '矽光子題材', thoughts: '矽光子為未來趨勢，持續看好長線發展。' },
            '5284': { market: '上市', industry: '航太工業', highlight: '業績創高', thoughts: '航太復甦與伺服器雙引擎，營收可期。' },
            '2360': { market: '上市', industry: '其他電子', highlight: '精密量測儀器', thoughts: '先進封裝檢測需求大增，龍頭地位穩固。' },
            '4722': { market: '上櫃', industry: '化學工業', highlight: 'CoWoS 供應鏈', thoughts: '切入CoWoS供應鏈，評價有重估空間。' },
            '8996': { market: '上市', industry: '電機機械', highlight: '熱管理專家', thoughts: '液冷散熱是AI伺服器標配，營收爆發。' },
            '4931': { market: '上市', industry: '電腦周邊', highlight: 'BBU 備援電池', thoughts: 'BBU需求因AI伺服器而起，短線動能強。' },
            '7853': { market: '興櫃', industry: '半導體業', highlight: 'AOI 檢測', thoughts: '興櫃潛力股，受惠先進封裝擴產。' },
            '7828': { market: '興櫃', industry: '軟體服務', highlight: '數位轉型/資安', thoughts: '數位轉型趨勢不變，資安為剛性需求。' },
            '3017': { market: '上市', industry: '電腦周邊', highlight: '散熱模組', thoughts: '3D VC與水冷板出貨順暢，獲利優於預期。' },
            '3324': { market: '上市', industry: '電腦周邊', highlight: '水冷板', thoughts: '水冷板市佔率高，為主要受惠者。' },
            '4971': { market: '上櫃', industry: '半導體業', highlight: 'MBE 砷化鎵', thoughts: '國防訂單穩定，加上衛星通訊需求。' },
            '6788': { market: '上櫃', industry: '半導體業', highlight: 'AMC 設備', thoughts: '隨著晶圓廠擴廠，微污染防治需求增。' },
            '7751': { market: '興櫃', industry: '半導體設備', highlight: 'CoWoS 檢測', thoughts: 'CoWoS擴產設備交期長，訂單滿手。' },
            '3189': { market: '上市', industry: '半導體業', highlight: 'ABF 載板', thoughts: 'ABF載板產業落底回升，AI晶片需求帶動。' },
        };
        
        // 初始價格 (含前日收盤) - 已更新至 2026/1/19
        const INITIAL_PRICES = { 
            '8358': { price: 260.0, prev: 260.0 }, // 假設無變動
            '3081': { price: 618.0, prev: 618.0 },
            '5284': { price: 270.5, prev: 270.5 },
            '2360': { price: 856.0, prev: 856.0 },
            '4722': { price: 162.0, prev: 168.0 }, // 162 (跌)
            '8996': { price: 577.0, prev: 577.0 },
            '4931': { price: 173.0, prev: 173.0 },
            '7853': { price: 113.5, prev: 113.5 },
            '7828': { price: 530.0, prev: 530.0 },
            '3017': { price: 1380.0, prev: 1380.0 },
            '3324': { price: 0.0, prev: 0.0 },
            '4971': { price: 338.5, prev: 292.5 }, // 338.5 (漲)
            '6788': { price: 344.0, prev: 338.5 }, // 344 (漲)
            '7751': { price: 820.0, prev: 838.0 }, // 820 (跌)
            '3189': { price: 211.5, prev: 175.5 }  // 211.5 (大漲)
        };

        const INITIAL_TRANSACTIONS = [
            { id: 101, date: '2025/10/28', code: '8358', name: '金居', type: 'Buy', price: 224, qty: 1000, note: '' },
            { id: 102, date: '2025/10/29', code: '8358', name: '金居', type: 'Buy', price: 228, qty: 1000, note: '' },
            { id: 103, date: '2025/11/04', code: '8358', name: '金居', type: 'Buy', price: 231.5, qty: 1000, note: '' },
            { id: 104, date: '2025/11/13', code: '8358', name: '金居', type: 'Buy', price: 229, qty: 1000, note: '【新會員】價格暫估' }, 
            { id: 105, date: '2025/11/18', code: '8358', name: '金居', type: 'Buy', price: 227, qty: 1000, note: '' },
            { id: 106, date: '2025/12/02', code: '8358', name: '金居', type: 'Buy', price: 230, qty: 1000, note: '【新會員】' },
            { id: 107, date: '2025/12/03', code: '8358', name: '金居', type: 'Buy', price: 232, qty: 1000, note: '' },
            { id: 108, date: '2026/12/10', code: '8358', name: '金居', type: 'Sell', price: 246.5, qty: 3500, note: '賣出一半' },
            { id: 109, date: '2026/12/22', code: '8358', name: '金居', type: 'Sell', price: 260, qty: 3500, note: '賣出全數' },
            // 聯亞 (3081)
            { id: 201, date: '2025/10/30', code: '3081', name: '聯亞', type: 'Buy', price: 433.5, qty: 1000, note: '' },
            { id: 202, date: '2025/10/31', code: '3081', name: '聯亞', type: 'Buy', price: 433.5, qty: 1000, note: '' },
            { id: 203, date: '2025/11/18', code: '3081', name: '聯亞', type: 'Buy', price: 447, qty: 1000, note: '' },
            { id: 204, date: '2026/12/17', code: '3081', name: '聯亞', type: 'Sell', price: 602, qty: 1500, note: '賣出一半 (修正價)' },
            { id: 205, date: '2027/01/05', code: '3081', name: '聯亞', type: 'Sell', price: 618, qty: 1500, note: '賣出全數 (修正價)' },
            // JPP-KY (5284)
            { id: 301, date: '2025/11/07', code: '5284', name: 'JPP-KY', type: 'Buy', price: 296.5, qty: 1000, note: '' },
            { id: 302, date: '2025/11/13', code: '5284', name: 'JPP-KY', type: 'Buy', price: 0, qty: 0, note: '【新會員】需補價' },
            { id: 303, date: '2025/11/18', code: '5284', name: 'JPP-KY', type: 'Buy', price: 282, qty: 1000, note: '' },
            { id: 304, date: '2025/11/26', code: '5284', name: 'JPP-KY', type: 'Buy', price: 290, qty: 0, note: '【新會員】' },
            { id: 305, date: '2025/11/28', code: '5284', name: 'JPP-KY', type: 'Buy', price: 285, qty: 0, note: '【新會員】' },
            { id: 306, date: '2025/12/02', code: '5284', name: 'JPP-KY', type: 'Buy', price: 310, qty: 0, note: '【新會員】' },
            { id: 307, date: '2025/12/03', code: '5284', name: 'JPP-KY', type: 'Buy', price: 306, qty: 1000, note: '' },
            { id: 308, date: '2026/12/15', code: '5284', name: 'JPP-KY', type: 'Buy', price: 298, qty: 1000, note: '' },
            { id: 309, date: '2026/12/17', code: '5284', name: 'JPP-KY', type: 'Buy', price: 300, qty: 1000, note: '' },
            { id: 310, date: '2026/12/22', code: '5284', name: 'JPP-KY', type: 'Buy', price: 290, qty: 1000, note: '' },
            { id: 311, date: '2026/12/24', code: '5284', name: 'JPP-KY', type: 'Buy', price: 285, qty: 1000, note: '' },
            { id: 312, date: '2027/01/12', code: '5284', name: 'JPP-KY', type: 'Sell', price: 270.5, qty: 11000, note: '賣出全數' },
            // 致茂 (2360)
            { id: 401, date: '2025/11/02', code: '2360', name: '致茂', type: 'Buy', price: 776.5, qty: 0, note: '【新會員】' },
            { id: 402, date: '2025/11/17', code: '2360', name: '致茂', type: 'Buy', price: 785, qty: 1000, note: '' },
            { id: 403, date: '2025/11/28', code: '2360', name: '致茂', type: 'Buy', price: 814, qty: 0, note: '【新會員】' },
            { id: 404, date: '2026/12/15', code: '2360', name: '致茂', type: 'Buy', price: 765, qty: 1000, note: '' },
            { id: 405, date: '2027/01/05', code: '2360', name: '致茂', type: 'Sell', price: 856, qty: 4000, note: '賣出全數' },
            // 國精化 (4722)
            { id: 501, date: '2026/12/15', code: '4722', name: '國精化', type: 'Buy', price: 188.5, qty: 1000, note: '' },
            { id: 502, date: '2026/12/16', code: '4722', name: '國精化', type: 'Buy', price: 185, qty: 1000, note: '' },
            { id: 503, date: '2026/12/17', code: '4722', name: '國精化', type: 'Buy', price: 182, qty: 1000, note: '' },
            { id: 504, date: '2026/12/19', code: '4722', name: '國精化', type: 'Buy', price: 164, qty: 1000, note: '' },
            { id: 505, date: '2026/12/24', code: '4722', name: '國精化', type: 'Buy', price: 175, qty: 0, note: '【新會員】' },
            { id: 506, date: '2026/12/26', code: '4722', name: '國精化', type: 'Buy', price: 168, qty: 1000, note: '' },
            { id: 507, date: '2027/01/13', code: '4722', name: '國精化', type: 'Buy', price: 168, qty: 0, note: '【新會員】' },
            // 高力 (8996)
            { id: 601, date: '2026/12/23', code: '8996', name: '高力', type: 'Buy', price: 545, qty: 1000, note: '' },
            { id: 602, date: '2027/01/07', code: '8996', name: '高力', type: 'Sell', price: 577, qty: 1000, note: '賣出全數' },
            // 新盛力 (4931)
            { id: 701, date: '2026/12/29', code: '4931', name: '新盛力', type: 'Buy', price: 178, qty: 1000, note: '' },
            { id: 702, date: '2027/01/06', code: '4931', name: '新盛力', type: 'Buy', price: 175, qty: 0, note: '【新會員】' },
            { id: 703, date: '2027/01/08', code: '4931', name: '新盛力', type: 'Sell', price: 173, qty: 2000, note: '賣出全數' },
            // 政美應用 (7853)
            { id: 801, date: '2027/01/02', code: '7853', name: '政美應用', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 802, date: '2027/01/05', code: '7853', name: '政美應用', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 803, date: '2027/01/06', code: '7853', name: '政美應用', type: 'Buy', price: 128, qty: 1000, note: '' },
            { id: 804, date: '2027/01/12', code: '7853', name: '政美應用', type: 'Sell', price: 113.5, qty: 3000, note: '賣出全數' },
            // 創新服務 (7828)
            { id: 901, date: '2027/01/05', code: '7828', name: '創新服務', type: 'Buy', price: 540, qty: 1000, note: '' },
            { id: 902, date: '2027/01/08', code: '7828', name: '創新服務', type: 'Sell', price: 530, qty: 1000, note: '賣出全數' },
            // 奇鋐 (3017)
            { id: 1001, date: '2027/01/07', code: '3017', name: '奇鋐', type: 'Buy', price: 1350, qty: 1000, note: '' },
            { id: 1002, date: '2027/01/08', code: '3017', name: '奇鋐', type: 'Buy', price: 1350, qty: 1000, note: '' },
            { id: 1003, date: '2027/01/14', code: '3017', name: '奇鋐', type: 'Buy', price: 1360, qty: 1000, note: '價格取中間值' },
            { id: 1004, date: '2027/01/15', code: '3017', name: '奇鋐', type: 'Sell', price: 1380, qty: 3000, note: '賣出全數' },
            // 雙鴻 (3324)
            { id: 1101, date: '2027/01/07', code: '3324', name: '雙鴻', type: 'Buy', price: 0, qty: 1000, note: '【需補價】' },
            { id: 1102, date: '2027/01/08', code: '3324', name: '雙鴻', type: 'Buy', price: 0, qty: 1000, note: '【需補價】' },
            { id: 1103, date: '2027/01/15', code: '3324', name: '雙鴻', type: 'Sell', price: 0, qty: 2000, note: '【需補價】賣出全數' },
            // IET-KY (4971)
            { id: 1201, date: '2027/01/12', code: '4971', name: 'IET-KY', type: 'Buy', price: 309, qty: 1000, note: '' },
            { id: 1202, date: '2027/01/13', code: '4971', name: 'IET-KY', type: 'Buy', price: 295, qty: 0, note: '【新會員】' },
            { id: 1203, date: '2027/01/13', code: '4971', name: 'IET-KY', type: 'Buy', price: 292.5, qty: 1000, note: '' },
            // 華景電 (6788)
            { id: 1301, date: '2027/01/12', code: '6788', name: '華景電', type: 'Buy', price: 353.5, qty: 1000, note: '' },
            { id: 1302, date: '2027/01/13', code: '6788', name: '華景電', type: 'Buy', price: 340, qty: 0, note: '【新會員】' },
            { id: 1303, date: '2027/01/13', code: '6788', name: '華景電', type: 'Buy', price: 338.5, qty: 1000, note: '' },
            // 竑騰 (7751)
            { id: 1401, date: '2027/01/09', code: '7751', name: '竑騰', type: 'Buy', price: 722, qty: 1000, note: '' },
            { id: 1402, date: '2027/01/15', code: '7751', name: '竑騰', type: 'Buy', price: 838, qty: 1000, note: '' },
            // 景碩 (3189)
            { id: 1501, date: '2027/01/15', code: '3189', name: '景碩', type: 'Buy', price: 175.5, qty: 1000, note: '' },
        ];

        const formatNumber = (val) => new Intl.NumberFormat('zh-TW').format(Math.round(val));
        const formatMoney = (val) => `$${formatNumber(val)}`;
        const formatDecimal = (val) => val ? val.toFixed(2) : '0.00';
        const formatPercent = (val) => `${(val * 100).toFixed(2)}%`;
        const getColor = (val) => val > 0 ? 'text-red-600' : val < 0 ? 'text-green-600' : 'text-slate-900';
        const getPriceColor = (current, ref) => current > ref ? 'text-red-600' : current < ref ? 'text-green-600' : 'text-slate-800';

        // --- Smart Input Modal ---
        const SmartInputModal = ({ onClose, onAnalyze, apiKey, setApiKey }) => {
            const [mode, setMode] = useState('transactions'); 
            const [isAnalyzing, setIsAnalyzing] = useState(false);
            const [textInput, setTextInput] = useState('');

            const handleAnalyze = async () => {
                if (!textInput.trim()) { alert("請貼上文字指令"); return; }
                if (!apiKey) { alert("請先輸入 Gemini API Key"); return; }

                setIsAnalyzing(true);
                try {
                    const genAI = new GoogleGenerativeAI(apiKey);
                    const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                    
                    let prompt = "";
                    
                    if (mode === 'transactions') {
                        prompt = `你是一個股票交易助手。請分析以下[葉宇乘]的文字指令。
                        請提取：
                        1. 交易資訊 (若有): date(YYYY/MM/DD), code, name, type(Buy/Sell), price(數值), qty(數值, 預設1000)。
                        2. 葉宇乘的話 (thoughts): 提取指令中關於該股票的分析、心得、獲利狀況等文字。
                        
                        特殊規則：
                        - 若指令為「心得分享」或「看法」而無明確買賣，建立一筆 qty: 0 的 Buy 交易，並將分析放入 thoughts。
                        - 價格若為區間 (69-70)，取平均。
                        - note 欄位請保留原始指令。
                        - **若指令中含有「新會員」字樣，請將 qty 設為 0，這非常重要！**
                        
                        回傳 JSON Array。範例：[{"date":"2026/01/20", "code":"8150", "name":"南茂", "type":"Buy", "price":69.5, "qty":0, "note":"[葉宇乘] 新會員...", "thoughts":"..."}]。
                        只回傳JSON。
                        
                        文字內容：
                        ${textInput}`;
                    } else {
                        prompt = `請辨識以下文字中的股票清單與價格。
                        提取：代號(code), 收盤價(price), 前日收盤(prev)。
                        若無前日收盤，prev 可設為 null。
                        回傳 JSON Object: {"3189": {"price": 206.0, "prev": 211.5}, "4722": {"price": 169.5, "prev": 162.0}}。
                        只回傳JSON。
                        文字內容：
                        ${textInput}`;
                    }

                    const result = await model.generateContent([prompt]);
                    const response = await result.response;
                    const text = response.text();
                    const data = cleanAndParseJSON(text);
                    
                    if (data) {
                        onAnalyze(data, mode);
                        onClose();
                        alert("✅ AI 分析完成並更新！");
                    } else {
                        alert("❌ AI 無法解析資料。");
                    }
                } catch (error) {
                    console.error("AI Error:", error);
                    alert("❌ 分析失敗：" + error.message);
                } finally {
                    setIsAnalyzing(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-lg shadow-2xl p-6 relative flex flex-col max-h-[90vh]">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                        <h2 className="text-xl font-bold flex items-center gap-2 mb-4 text-slate-800"><Icon name="bot" className="text-orange-600"/> 智慧助理</h2>
                        
                        <div className="space-y-4 overflow-y-auto pr-2">
                            <div className="relative">
                                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Gemini API Key" className="w-full border rounded p-2 text-sm bg-slate-50"/>
                            </div>
                            
                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                <button onClick={() => setMode('transactions')} className={`flex-1 py-2 text-sm font-bold rounded transition-all ${mode==='transactions'?'bg-white shadow text-blue-600':'text-slate-500'}`}>指令/心得 (更新葉宇乘的話)</button>
                                <button onClick={() => setMode('prices')} className={`flex-1 py-2 text-sm font-bold rounded transition-all ${mode==='prices'?'bg-white shadow text-blue-600':'text-slate-500'}`}>更新股價</button>
                            </div>

                            <div className="space-y-3 pt-2">
                                <textarea 
                                    value={textInput}
                                    onChange={(e) => setTextInput(e.target.value)}
                                    placeholder={mode === 'transactions' ? "貼上 [葉宇乘] 指令...\n例如：南茂(8150) 昨天的69-70附近，可以加碼，這獲利很不錯。" : "貼上股價列表..."}
                                    className="w-full h-48 border rounded-lg p-3 text-sm focus:ring-2 focus:ring-orange-500 outline-none resize-none bg-slate-50"
                                ></textarea>
                            </div>

                            <button onClick={handleAnalyze} disabled={isAnalyzing} className="w-full bg-orange-600 hover:bg-orange-700 text-white py-3 rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 mt-4 transition-all">
                                {isAnalyzing ? 'AI 分析中...' : <><Icon name="zap"/> 開始分析</>}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Settings Modal ---
        const CloudSettingsModal = ({ onClose, onConnect, currentRoom, apiKey, setApiKey, data, onRestore }) => {
            const [roomName, setRoomName] = useState(currentRoom || "default");
            const [logs, setLogs] = useState([]);

            useEffect(() => {
                const updateLogs = () => setLogs([...globalLog]);
                window.addEventListener('logUpdated', updateLogs);
                updateLogs();
                return () => window.removeEventListener('logUpdated', updateLogs);
            }, []);

            // 匯出備份
            const handleExport = () => {
                const backupData = {
                    version: "5.4",
                    timestamp: new Date().toISOString(),
                    transactions: data.transactions,
                    prices: data.prices,
                    metaData: data.metaData,
                    settings: {
                        syncRoom: data.syncRoom,
                    }
                };
                const blob = new Blob([JSON.stringify(backupData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `stock_bill_backup_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            };

            // 匯入備份
            const handleImport = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const backup = JSON.parse(event.target.result);
                        if (!backup.transactions || !backup.prices) {
                            alert("無效的備份檔案格式");
                            return;
                        }
                        if (confirm(`確定要從備份回復資料嗎？\n備份時間: ${backup.timestamp}`)) {
                            onRestore(backup);
                            alert("資料回復成功！");
                        }
                    } catch (err) {
                        alert("讀取備份檔案失敗");
                        console.error(err);
                    }
                };
                reader.readAsText(file);
            };

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 max-h-[90vh] flex flex-col">
                        <div className="flex justify-between items-center mb-4 border-b pb-2">
                            <h2 className="text-xl font-bold flex items-center gap-2"><Icon name="settings" className="text-slate-600"/> 系統設定</h2>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        <div className="space-y-4 overflow-y-auto pr-1">
                            <div><label className="block text-sm font-bold mb-1">同步房間名稱</label><input type="text" value={roomName} onChange={(e)=>setRoomName(e.target.value)} className="w-full border rounded p-2"/></div>
                            <div><label className="block text-sm font-bold mb-1">Gemini API Key</label><input type="password" value={apiKey} onChange={(e)=>setApiKey(e.target.value)} className="w-full border rounded p-2"/></div>
                            <button onClick={()=>{onConnect(roomName); onClose();}} className="w-full bg-blue-600 text-white font-bold py-2 rounded">儲存設定 & 連線</button>
                            
                            {/* 備份還原專區 */}
                            <div className="pt-4 border-t border-slate-200">
                                <h3 className="text-sm font-bold text-slate-700 mb-2">資料備份與還原</h3>
                                <div className="flex gap-2">
                                    <button onClick={handleExport} className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded flex items-center justify-center gap-1 border border-slate-300">
                                        <Icon name="download" size={16}/> 匯出備份
                                    </button>
                                    <label className="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-700 font-bold py-2 rounded flex items-center justify-center gap-1 border border-slate-300 cursor-pointer">
                                        <Icon name="upload" size={16}/> 匯入還原
                                        <input type="file" accept=".json" onChange={handleImport} className="hidden"/>
                                    </label>
                                </div>
                            </div>

                            <div className="mt-4 border-t pt-4">
                                <h3 className="text-sm font-bold text-slate-700 mb-2">系統日誌</h3>
                                <div className="bg-slate-900 text-green-400 font-mono text-xs p-3 rounded h-40 overflow-y-auto">
                                    {logs.length === 0 ? "尚無日誌..." : logs.map((log, i) => <div key={i} className="mb-1 border-b border-slate-800 pb-1">{log}</div>)}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Simple Holdings Modal ---
        const SimpleHoldingsModal = ({ holdings, onClose }) => (
            <div className="fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-fade-in">
                <div className="bg-white rounded-2xl w-full max-w-4xl shadow-2xl p-6 relative max-h-[90vh] flex flex-col">
                    <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-slate-600"><Icon name="x"/></button>
                    <h2 className="text-2xl font-bold mb-6 flex items-center gap-2"><Icon name="table" className="text-orange-600"/> 簡易持股表</h2>
                    <div className="overflow-auto flex-1">
                        <table className="w-full text-left border-collapse min-w-[500px]">
                            <thead className="bg-slate-100 text-slate-600 sticky top-0">
                                <tr>
                                    <th className="p-4 rounded-tl-lg font-bold">編號</th>
                                    <th className="p-4 font-bold">股市代號</th>
                                    <th className="p-4 font-bold">股市名稱</th>
                                    <th className="p-4 text-right font-bold">買入均價</th>
                                    <th className="p-4 text-right rounded-tr-lg font-bold">張數及股數</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100 text-slate-800">
                                {holdings.map((stock, index) => {
                                    const marketStyle = getMarketStyle(stock.meta.market);
                                    return (
                                        <tr key={stock.code} className="hover:bg-slate-50 transition-colors">
                                            <td className="p-4 font-bold text-slate-500">{index + 1}</td>
                                            <td className="p-4 font-mono font-bold text-lg">{stock.code}</td>
                                            <td className="p-4 font-bold text-xl">{stock.name}</td>
                                            <td className="p-4 text-right font-mono font-bold text-lg">{formatDecimal(stock.displayAvgCost)}</td>
                                            <td className="p-4 text-right">
                                                <span className="font-bold text-xl">{Math.floor(stock.inventory / 1000)}</span> <span className="text-sm text-slate-500 mr-2">張</span>
                                                {stock.inventory % 1000 > 0 && <span className="text-slate-500 font-mono">({stock.inventory % 1000} 股)</span>}
                                            </td>
                                        </tr>
                                    );
                                })}
                                {holdings.length === 0 && <tr><td colSpan="5" className="p-12 text-center text-slate-400 text-lg font-bold">目前無持股，請建立倉位！</td></tr>}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        );

        // --- Edit Modal ---
        const EditTransactionModal = ({ transaction, onSave, onCancel }) => {
            const [formData, setFormData] = useState(transaction);
            const handleChange = (e) => { const { name, value } = e.target; setFormData(prev => ({...prev, [name]: (name==='price'||name==='qty')?parseFloat(value):value})); };
            return (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                    <div className="bg-white p-6 rounded-xl w-full max-w-md">
                        <h3 className="text-lg font-bold mb-4">編輯交易</h3>
                        <div className="space-y-3">
                            <div><label className="text-xs">日期</label><input name="date" value={formData.date} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">代號</label><input name="code" value={formData.code} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                                <div className="flex-1"><label className="text-xs">名稱</label><input name="name" value={formData.name} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div className="flex gap-2">
                                <div className="flex-1"><label className="text-xs">買賣</label><select name="type" value={formData.type} onChange={handleChange} className="w-full border p-2 rounded"><option value="Buy">Buy</option><option value="Sell">Sell</option></select></div>
                                <div className="flex-1"><label className="text-xs">價格</label><input type="number" name="price" value={formData.price} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            </div>
                            <div><label className="text-xs">股數</label><input type="number" name="qty" value={formData.qty} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                            <div><label className="text-xs">備註</label><input name="note" value={formData.note} onChange={handleChange} className="w-full border p-2 rounded"/></div>
                        </div>
                        <div className="mt-6 flex justify-end gap-2"><button onClick={onCancel} className="px-4 py-2 border rounded">取消</button><button onClick={()=>onSave(formData)} className="px-4 py-2 bg-blue-600 text-white rounded">儲存</button></div>
                    </div>
                </div>
            );
        };

        // --- Main Component ---
        const StockBillStrong = () => {
            const [activeTab, setActiveTab] = useState('holdings'); 
            const [user, setUser] = useState(null);
            const [transactions, setTransactions] = useState(INITIAL_TRANSACTIONS);
            
            // 升級版 Prices State: 支援 { price, prev, date } 或 單純 number (兼容舊資料)
            const [prices, setPrices] = useState(INITIAL_PRICES);
            
            // 升級版 Meta Data: 支援 thoughts
            const [metaData, setMetaData] = useState(INITIAL_META_DATA);

            const [userAvatar, setUserAvatar] = useState(null);
            const [geminiApiKey, setGeminiApiKey] = useState("AIzaSyDVIFDMODO28W2hW3Cfv7egUyO4LApzR50");
            const [syncRoom, setSyncRoom] = useState("default");
            const [isSyncing, setIsSyncing] = useState(false); 
            const [showCloudSettings, setShowCloudSettings] = useState(false);
            const [showAIModal, setShowAIModal] = useState(false);
            const [showSimpleTable, setShowSimpleTable] = useState(false); 
            const [editingId, setEditingId] = useState(null);
            const [selectedStockCode, setSelectedStockCode] = useState(null);
            const [currentTime, setCurrentTime] = useState(new Date());

            // ... (Auth & Sync Effects 保持不變，省略以節省長度，與 v4.8 相同) ...
            useEffect(() => {
                const initAuth = async () => {
                    if (isFirebaseAvailable) {
                        try {
                            const usingManualConfig = activeConfig === MANUAL_FIREBASE_CONFIG;
                            if (!usingManualConfig && window.__initial_auth_token) await signInWithCustomToken(auth, window.__initial_auth_token);
                            else await signInAnonymously(auth);
                            onAuthStateChanged(auth, (u) => { setUser(u); if(u) addLog(`用戶已登入`); });
                        } catch (error) { setUser({ uid: 'local-user' }); }
                    } else { setUser({ uid: 'local-user' }); }
                };
                initAuth();
                const timer = setInterval(() => setCurrentTime(new Date()), 1000);
                return () => clearInterval(timer);
            }, []);

            useEffect(() => {
                const savedKey = localStorage.getItem('stock_bill_gemini_key');
                if (savedKey) setGeminiApiKey(savedKey); 
                const savedRoom = localStorage.getItem('stock_bill_fb_room');
                if (savedRoom) { setSyncRoom(savedRoom); setIsSyncing(true); }
                const savedAvatar = localStorage.getItem('stock_bill_avatar');
                if (savedAvatar) setUserAvatar(savedAvatar); 
                if (!isFirebaseAvailable) {
                    const localTx = localStorage.getItem('stock_bill_transactions');
                    if(localTx) setTransactions(JSON.parse(localTx));
                    const localPrices = localStorage.getItem('stock_bill_prices');
                    if(localPrices) setPrices(JSON.parse(localPrices));
                    const localMeta = localStorage.getItem('stock_bill_meta');
                    if(localMeta) setMetaData(JSON.parse(localMeta));
                }
            }, []);

            // Sync Logic Update: Include metaData
            useEffect(() => {
                if (!user || !syncRoom || !isFirebaseAvailable) return;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                const unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        if (data.transactions) setTransactions(JSON.parse(data.transactions));
                        if (data.prices) setPrices(JSON.parse(data.prices));
                        if (data.metaData) setMetaData(JSON.parse(data.metaData));
                    } else if (isSyncing) {
                        setDoc(docRef, { 
                            transactions: JSON.stringify(transactions), 
                            prices: JSON.stringify(prices), 
                            metaData: JSON.stringify(metaData) 
                        }, { merge: true });
                    }
                });
                return () => unsubscribe();
            }, [user, syncRoom, isSyncing]);

            useEffect(() => {
                if (!user) return;
                if (isFirebaseAvailable && isSyncing) {
                    const saveData = async () => {
                        try {
                            const docRef = doc(db, 'artifacts', appId, 'public', 'data', 'stock_bill_rooms', syncRoom);
                            await setDoc(docRef, { 
                                transactions: JSON.stringify(transactions), 
                                prices: JSON.stringify(prices),
                                metaData: JSON.stringify(metaData)
                            }, { merge: true });
                        } catch(e) { console.error(e); }
                    };
                    const t = setTimeout(saveData, 2000);
                    return () => clearTimeout(t);
                }
                localStorage.setItem('stock_bill_transactions', JSON.stringify(transactions));
                localStorage.setItem('stock_bill_prices', JSON.stringify(prices));
                localStorage.setItem('stock_bill_meta', JSON.stringify(metaData));
            }, [transactions, prices, metaData, user, isSyncing, syncRoom]);

            // Restore Data Function
            const handleRestore = (backup) => {
                if(backup.transactions) setTransactions(backup.transactions);
                if(backup.prices) setPrices(backup.prices);
                if(backup.metaData) setMetaData(backup.metaData);
                if(backup.settings?.syncRoom) setSyncRoom(backup.settings.syncRoom);
            };

            const handleAIResult = (data, mode) => {
                if (mode === 'transactions') {
                    if (Array.isArray(data) && data.length > 0) {
                        // 1. 新增交易
                        const newTx = data.map(t => ({ ...t, id: Date.now() + Math.random() }));
                        setTransactions(prev => [...prev, ...newTx]);
                        
                        // 2. 更新【葉宇乘的話】
                        const newMeta = { ...metaData };
                        data.forEach(t => {
                            if (t.thoughts) {
                                if (!newMeta[t.code]) newMeta[t.code] = { market: '上市', industry: '', highlight: '' }; // 預設
                                newMeta[t.code].thoughts = t.thoughts; // 覆蓋更新
                            }
                        });
                        setMetaData(newMeta);
                        addLog(`更新交易與心得`);
                    }
                } else { // Prices Mode
                    if(typeof data === 'object') {
                        // 支援 { current, prev } 結構
                        const newPrices = { ...prices };
                        Object.keys(data).forEach(code => {
                            const val = data[code];
                            if (typeof val === 'object' && val.price) {
                                newPrices[code] = { price: val.price, prev: val.prev || val.price };
                            } else {
                                // 兼容舊格式：只給價格，前日價設為今日價(0漲跌)
                                newPrices[code] = { price: val, prev: val }; 
                            }
                        });
                        setPrices(newPrices);
                        addLog(`更新股價`);
                    }
                }
            };

            const portfolio = useMemo(() => {
                const holdingsMap = {};
                const realizedMap = {};
                let realizedPL = 0;
                const sortedTrans = [...transactions].sort((a, b) => new Date(a.date) - new Date(b.date));

                sortedTrans.forEach(t => {
                    if (!holdingsMap[t.code]) holdingsMap[t.code] = { 
                        code: t.code, name: t.name, inventory: 0, totalCost: 0, avgCost: 0, history: [], 
                        callSignalCount: 0, newMemberCount: 0, 
                        callSignalBuyCost: 0, callSignalBuyQty: 0
                    };
                    // 初始化已結算: 紀錄買入日期範圍、總成本、總股數、總賣出金額
                    if (!realizedMap[t.code]) realizedMap[t.code] = { 
                        code: t.code, name: t.name, totalPL: 0, trades: [], 
                        buyDates: [], sellDate: null, totalCost: 0, totalQty: 0, totalSellAmt: 0
                    };
                    
                    const stock = holdingsMap[t.code];
                    const realizedStock = realizedMap[t.code];
                    
                    stock.history.push(t);
                    realizedStock.trades.push(t);
                    const qty = t.qty || 1000;
                    
                    // 檢查是否為新會員指令
                    const isNewMember = t.qty === 0 || (t.note && t.note.includes('新會員'));

                    if (t.type === 'Buy') {
                        if (isNewMember) {
                            stock.newMemberCount += 1;
                        } else {
                            stock.callSignalCount += 1;
                            stock.callSignalBuyCost += t.price * qty;
                            stock.callSignalBuyQty += qty;
                            
                            stock.totalCost += t.price * qty;
                            stock.inventory += qty;
                            stock.avgCost = stock.inventory > 0 ? stock.totalCost / stock.inventory : 0;
                            
                            // 記錄到已結算追蹤
                            realizedStock.buyDates.push(t.date);
                            realizedStock.totalCost += t.price * qty;
                            realizedStock.totalQty += qty;
                        }
                    } else { // Sell
                        if (stock.inventory > 0) {
                            const sellQty = Math.min(stock.inventory, qty); 
                            const profit = (t.price - stock.avgCost) * sellQty;
                            realizedPL += profit;
                            realizedStock.totalPL += profit;
                            realizedStock.totalSellAmt += t.price * sellQty;
                            realizedStock.sellDate = t.date; // 更新最後賣出日
                            
                            stock.totalCost -= stock.avgCost * sellQty;
                            stock.inventory -= sellQty;
                        }
                    }
                });

                const holdings = Object.values(holdingsMap).filter(h => h.inventory > 0 || h.newMemberCount > 0 || h.callSignalCount > 0).map(h => {
                    // 處理股價結構兼容性
                    const priceData = prices[h.code];
                    const currentPrice = priceData?.price || priceData || h.avgCost; // 兼容舊格式
                    const prevPrice = priceData?.prev || currentPrice;
                    
                    const marketValue = currentPrice * h.inventory;
                    const unrealizedPL = (currentPrice - h.avgCost) * h.inventory;
                    const displayAvgCost = h.callSignalBuyQty > 0 ? (h.callSignalBuyCost / h.callSignalBuyQty) : 0;
                    const fundPercentage = (marketValue / INITIAL_CAPITAL) * 100;

                    // 漲跌幅 (基於前日收盤)
                    const dailyChange = currentPrice - prevPrice;
                    const dailyChangePct = prevPrice > 0 ? (dailyChange / prevPrice) * 100 : 0;
                    
                    // 修正 ROI 計算：當 avgCost 為 0 時（例如新會員且無庫存），ROI 為 0
                    const roi = h.avgCost > 0 ? ((currentPrice - h.avgCost) / h.avgCost) * 100 : 0;

                    const meta = metaData[h.code] || { market: '上市', industry: '未分類', thoughts: '' };

                    // 自動抓取最新日期 (今天) 與 前日日期
                    const todayDate = new Date();
                    const yesterdayDate = new Date(todayDate);
                    yesterdayDate.setDate(yesterdayDate.getDate() - 1);

                    return { 
                        ...h, 
                        currentPrice, 
                        prevPrice, 
                        dailyChange, 
                        dailyChangePct, 
                        marketValue, 
                        unrealizedPL, 
                        displayAvgCost, 
                        fundPercentage, 
                        meta, 
                        roi,
                        todayDateStr: todayDate.toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'}),
                        yesterdayDateStr: yesterdayDate.toLocaleDateString('zh-TW', {month:'numeric', day:'numeric'})
                    };
                }).filter(h => h.inventory > 0); 

                // 整理已結算卡片資料
                const realizedStocks = Object.values(realizedMap)
                    .filter(r => holdingsMap[r.code].inventory === 0 && r.totalPL !== 0)
                    .map(r => ({
                        ...r,
                        avgSellPrice: r.totalQty > 0 ? r.totalSellAmt / r.totalQty : 0,
                        avgCost: r.totalQty > 0 ? r.totalCost / r.totalQty : 0,
                        buyPeriod: r.buyDates.length > 0 ? `${r.buyDates[0]} ~ ${r.buyDates[r.buyDates.length-1]}` : 'N/A'
                    }));

                const totalMarketValue = holdings.reduce((sum, h) => sum + h.marketValue, 0);
                const totalUnrealizedPL = holdings.reduce((sum, h) => sum + h.unrealizedPL, 0);
                const totalEquity = INITIAL_CAPITAL + realizedPL + totalUnrealizedPL;
                const cash = totalEquity - totalMarketValue;
                const usageRate = totalEquity > 0 ? totalMarketValue / totalEquity : 0;
                return { holdings, realizedStocks, realizedPL, totalUnrealizedPL, totalEquity, totalMarketValue, usageRate, cash };
            }, [transactions, prices, metaData]);

            const handleAvatarUpload = async (e) => {
                const f = e.target.files[0];
                if(f) { const b = await compressImage(f); setUserAvatar(b); localStorage.setItem('stock_bill_avatar', b); }
            };

            return (
                <div className="min-h-screen font-sans text-slate-900 pb-10 relative">
                    {/* ... (Modals 省略，與 v4.8 相同，僅需注意 AIGeminiModal 的 Prompt 已在上面更新) ... */}
                    {editingId && <EditTransactionModal transaction={transactions.find(t => t.id === editingId)} onSave={(updatedTx) => {setTransactions(prev => prev.map(t => t.id === updatedTx.id ? updatedTx : t)); setEditingId(null);}} onCancel={() => setEditingId(null)} />}
                    {showCloudSettings && <CloudSettingsModal onClose={() => setShowCloudSettings(false)} onConnect={(room)=>{setSyncRoom(room);setIsSyncing(true);}} currentRoom={syncRoom} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} data={{transactions, prices, metaData, syncRoom, geminiApiKey}} onRestore={handleRestore} />}
                    {showAIModal && <SmartInputModal onClose={() => setShowAIModal(false)} onAnalyze={handleAIResult} apiKey={geminiApiKey} setApiKey={setGeminiApiKey} />}
                    {showSimpleTable && <SimpleHoldingsModal holdings={portfolio.holdings} onClose={() => setShowSimpleTable(false)} />}

                    <header className="bg-yellow-400 shadow-xl border-b-4 border-orange-500 sticky top-0 z-40 header-fun-pattern">
                        {/* ... (Header 保持不變) ... */}
                        <div className="max-w-7xl mx-auto px-6 py-4 flex flex-col md:flex-row justify-between items-center relative z-10 gap-4">
                            <div className="flex items-center gap-4">
                                <label className="relative cursor-pointer group flex-shrink-0 z-50" title="點擊更換頭貼 (自動儲存)">
                                    <div className="w-16 h-16 rounded-full border-4 border-orange-500 bg-white overflow-hidden shadow-xl flex items-center justify-center">
                                        {userAvatar ? <img src={userAvatar} className="w-full h-full object-cover" /> : <Icon name="user" size={40} className="text-slate-300" />}
                                    </div>
                                    <input type="file" accept="image/*" className="hidden" onChange={handleAvatarUpload} />
                                </label>
                                <div>
                                    <h1 className="text-6xl md:text-7xl font-extrabold text-blue-800 tracking-wide ml-8 drop-shadow-2xl" style={{ textShadow: '4px 4px 0px #fff' }}>股市比爾強</h1>
                                    <p className="text-lg font-bold text-white tracking-widest ml-9 mt-1 drop-shadow-md">產業趨勢挖掘者</p>
                                    <p className="text-sm font-bold bg-orange-600 text-white inline-block px-2 transform -skew-x-12 mt-2 ml-9">v5.4 AI 旗艦版</p>
                                </div>
                            </div>
                            <div className="flex flex-col items-end gap-2">
                                <div className="flex items-center gap-2 cursor-pointer" onClick={() => setShowCloudSettings(true)}>
                                    <div className={`flex items-center gap-1 px-3 py-1 rounded-full text-xs font-bold shadow-sm backdrop-blur ${isFirebaseAvailable ? 'bg-green-100/90 text-green-700 border border-green-300' : 'bg-red-100/90 text-red-700 border border-red-300'}`}>
                                        <div className={`w-2 h-2 rounded-full ${isFirebaseAvailable ? 'bg-green-500 animate-pulse' : 'bg-red-500'}`}></div>
                                        {isFirebaseAvailable ? '雲端同步中' : '單機模式'}
                                    </div>
                                    <div className="text-right text-slate-800 font-bold bg-white/40 backdrop-blur px-3 py-1 rounded-lg border border-slate-800/20 shadow-sm">用500萬從2025/10/28日開始模擬操作</div>
                                </div>
                                <div className="text-right text-orange-900 font-bold font-mono"><div className="text-xl">{currentTime.toLocaleTimeString()}</div><div className="text-xs">{currentTime.toLocaleDateString()}</div></div>
                                <div className="flex gap-2">
                                    <button onClick={() => setShowSimpleTable(true)} className="bg-orange-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white flex items-center gap-1 hover:bg-orange-700 transition-colors"><Icon name="table" size={14}/> 簡易持股表</button>
                                    <button onClick={() => setShowAIModal(true)} className="bg-purple-600 text-white font-bold text-xs px-4 py-2 rounded-full shadow-lg border-2 border-white/50 flex items-center gap-1 hover:bg-purple-700 transition-colors"><Icon name="bot" size={14}/> 智慧助理</button>
                                    <button onClick={() => setShowCloudSettings(true)} className={`font-bold text-xs px-3 py-2 rounded flex items-center gap-1 shadow-md text-white ${isSyncing?'bg-green-600':'bg-slate-400'}`}><Icon name="settings" size={14}/> {isSyncing ? syncRoom : '設定'}</button>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-4 md:p-6 space-y-6">
                        <section className="grid grid-cols-1 md:grid-cols-4 gap-4">
                            {/* 資產卡片 */}
                            <div className="bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl p-5 text-slate-800 shadow-lg border-4 border-yellow-300 relative overflow-hidden">
                                <Icon name="wallet" size={80} className="absolute -right-4 -top-4 opacity-10 text-orange-600"/>
                                <p className="text-slate-500 text-xs font-bold uppercase mb-1">總資產</p>
                                <h2 className="text-3xl font-black text-slate-900 mb-2">{formatMoney(portfolio.totalMarketValue)}</h2>
                                <div className="flex justify-between items-end border-t border-yellow-300 pt-2">
                                    <div><p className="text-slate-500 text-xs font-bold">現金</p><span className="font-mono font-bold text-slate-700">{formatMoney(portfolio.cash)}</span></div>
                                    <div className="text-right"><span className="text-xs text-slate-500 block">水位</span><span className="text-xl font-bold text-orange-600">{formatPercent(portfolio.usageRate)}</span></div>
                                </div>
                            </div>
                            
                            {/* 損益卡片 */}
                            <div className="md:col-span-2 bg-yellow-50 rounded-2xl p-6 shadow-xl flex items-center justify-around border-4 border-slate-200">
                                <div className="text-center w-1/2 border-r-2 border-slate-100 pr-4">
                                    <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wide">未實現損益</p>
                                    <div className={`text-3xl font-black tracking-tight ${getColor(portfolio.totalUnrealizedPL)}`}>
                                        {portfolio.totalUnrealizedPL > 0 ? '+' : ''}{formatMoney(portfolio.totalUnrealizedPL)}
                                    </div>
                                </div>
                                <div className="text-center w-1/2 pl-4">
                                    <p className="text-slate-400 text-xs font-bold mb-1 uppercase tracking-wide">已實現損益</p>
                                    <div className={`text-3xl font-black tracking-tight ${getColor(portfolio.realizedPL)}`}>
                                        {portfolio.realizedPL > 0 ? '+' : ''}{formatMoney(portfolio.realizedPL)}
                                    </div>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl p-4 shadow-lg border-2 border-yellow-200 flex flex-col justify-center gap-2">
                                <div className="text-purple-600 font-bold flex items-center gap-2"><Icon name="bot" size={16}/> 智慧助理</div>
                                <p className="text-xs text-slate-500">貼上指令，AI 自動分析並更新【葉宇乘的話】。</p>
                            </div>
                        </section>

                        <div className="bg-yellow-50/80 backdrop-blur-sm rounded-3xl p-6 shadow-xl border-2 border-yellow-200 min-h-[500px]">
                            <div className="flex gap-4 mb-6 border-b-2 border-yellow-200 pb-2 overflow-x-auto">
                                {[{id:'holdings',label:'持有庫存',icon:'briefcase'},{id:'timeline',label:'交易紀錄',icon:'history'},{id:'realized',label:'已結算',icon:'check'}].map(tab=>(
                                    <button key={tab.id} onClick={()=>setActiveTab(tab.id)} className={`flex items-center gap-2 px-6 py-2 rounded-xl font-bold transition-all whitespace-nowrap ${activeTab===tab.id?'bg-orange-600 text-white shadow-lg':'bg-white text-slate-500 hover:bg-yellow-100'}`}><Icon name={tab.icon} size={18}/> {tab.label}</button>
                                ))}
                            </div>

                            {activeTab === 'holdings' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {portfolio.holdings.map((stock, i) => {
                                        const marketStyle = getMarketStyle(stock.meta.market);
                                        return (
                                        <div key={stock.code} onClick={()=>setSelectedStockCode(selectedStockCode===stock.code?null:stock.code)} className="bg-white rounded-2xl shadow-xl border border-slate-100 hover:shadow-2xl transition-all cursor-pointer overflow-hidden flex flex-col group relative">
                                            
                                            {/* Top Banner (Ticker Style) */}
                                            <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-white relative z-10">
                                                <div>
                                                    <div className="flex items-center gap-2">
                                                        <span className={`text-[10px] font-bold px-2 py-0.5 rounded shadow-sm ${marketStyle.badge}`}>{stock.meta.market}</span>
                                                        <span className="font-mono text-slate-400 text-xs font-bold">{stock.code}</span>
                                                        <a href={`https://www.cmoney.tw/forum/stock/${stock.code}`} target="_blank" onClick={(e)=>e.stopPropagation()} className="text-gray-300 hover:text-blue-500 ml-1"><Icon name="external-link" size={14} /></a>
                                                    </div>
                                                    <div className="font-black text-2xl text-slate-800 tracking-tight mt-1">{stock.name}</div>
                                                </div>
                                                
                                                {/* Price Display */}
                                                <div className="text-right" title="點擊修改收盤價" onClick={(e)=>{e.stopPropagation(); const p=prompt('輸入新收盤價',stock.currentPrice); if(p) setPrices(prev=>({...prev,[stock.code]:{price:parseFloat(p), prev: stock.prevPrice}}));}}>
                                                    <div className="text-[10px] text-slate-400 mb-0.5 flex items-center justify-end gap-1 font-bold">今日({stock.todayDateStr})收盤</div>
                                                    <div className={`text-3xl font-black font-mono leading-none ${getPriceColor(stock.currentPrice, stock.prevPrice)}`}>
                                                        {stock.currentPrice}
                                                    </div>
                                                    <div className={`text-xs font-bold mt-1 flex justify-end gap-1 ${getColor(stock.dailyChange)}`}>
                                                        {stock.dailyChange > 0 ? '▲' : '▼'} {Math.abs(stock.dailyChange)} ({Math.abs(stock.dailyChangePct).toFixed(2)}%)
                                                    </div>
                                                    <div className="text-[10px] text-slate-300 mt-1 flex items-center justify-end gap-1 hover:text-blue-500" onClick={(e)=>{e.stopPropagation(); const p=prompt('修正前日收盤價',stock.prevPrice); if(p) setPrices(prev=>({...prev,[stock.code]:{price: stock.currentPrice, prev:parseFloat(p)}}));}}>
                                                        前日({stock.yesterdayDateStr})收盤: {stock.prevPrice}
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Middle Stats Grid */}
                                            <div className="p-4 bg-slate-50/50">
                                                <div className="grid grid-cols-2 gap-y-3 gap-x-4 text-sm">
                                                    <div>
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">摳訊均價</span>
                                                        <span className="font-bold text-lg text-slate-700 font-mono">{formatDecimal(stock.displayAvgCost)}</span>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">庫存</span>
                                                        <span className="font-bold text-lg text-slate-800">{Math.floor(stock.inventory/1000)}<span className="text-xs text-slate-500">張</span> <span className="text-xs text-slate-400 font-mono">({stock.inventory})</span></span>
                                                    </div>
                                                    <div>
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">資金部位</span>
                                                        <div className="flex items-center gap-2">
                                                            <div className="h-2 w-full bg-slate-200 rounded-full overflow-hidden">
                                                                <div className="h-full bg-blue-500 rounded-full" style={{width: `${Math.min(stock.fundPercentage, 100)}%`}}></div>
                                                            </div>
                                                            <span className="font-bold text-xs text-slate-600 font-mono">{Math.round(stock.fundPercentage)}%</span>
                                                        </div>
                                                    </div>
                                                    <div className="text-right">
                                                        <span className="text-slate-400 text-[10px] uppercase font-bold block mb-0.5">未實現損益</span>
                                                        <span className={`font-black text-lg font-mono ${getColor(stock.unrealizedPL)}`}>{stock.unrealizedPL > 0 ? '+' : ''}{formatNumber(stock.unrealizedPL)}</span>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Bottom Notes - 葉宇乘的話 */}
                                            <div className="p-4 space-y-2 border-t border-slate-100 bg-white">
                                                <div className="bg-slate-50 text-slate-700 text-sm p-3 rounded-xl border border-slate-200 leading-relaxed relative mt-2">
                                                    <div className="absolute -top-2 -left-1 bg-slate-800 text-white text-[10px] px-2 py-0.5 rounded-full font-bold shadow-sm">葉宇乘的話</div>
                                                    <p className="mt-1 text-xs italic">{stock.meta.thoughts || '尚無筆記'}</p>
                                                </div>
                                                <p className="text-[10px] text-slate-400 text-right">產業亮點：{stock.meta.highlight}</p>
                                            </div>
                                        </div>
                                        );
                                    })}
                                </div>
                            )}

                            {/* ... (交易紀錄區塊保持不變) ... */}
                            {activeTab === 'timeline' && (
                                <div className="bg-white rounded-xl shadow-lg border border-slate-200 p-8 relative min-h-[400px]">
                                    <div className="timeline-line"></div>
                                    <div className="space-y-8 pl-12">
                                        {[...transactions]
                                            .filter(t => !t.note.includes('新會員'))
                                            .sort((a,b)=>new Date(b.date)-new Date(a.date))
                                            .map(t => (
                                                <div key={t.id} className="relative group">
                                                    <div className={`timeline-dot ${t.type === 'Buy' ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                                    <div className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all relative">
                                                        <div className="absolute -left-3 top-4 w-3 h-3 bg-white border-b border-l border-slate-100 transform rotate-45"></div>
                                                        <div className="flex justify-between items-start mb-2">
                                                            <div>
                                                                <span className="font-mono text-xs text-slate-400 font-bold">{t.date}</span>
                                                                <h4 className="font-bold text-lg text-slate-800 flex items-center gap-2">
                                                                    {t.name} <span className="text-xs font-normal text-slate-400">({t.code})</span>
                                                                </h4>
                                                            </div>
                                                            <span className={`px-3 py-1 rounded-full text-xs font-bold ${t.type === 'Buy' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`}>
                                                                {t.type === 'Buy' ? '買入' : '賣出'}
                                                            </span>
                                                        </div>
                                                        <div className="flex justify-between text-sm font-mono text-slate-600">
                                                            <span>{formatDecimal(t.price)} x {t.qty}</span>
                                                            <span>{t.note}</span>
                                                        </div>
                                                        <button onClick={()=>setEditingId(t.id)} className="absolute right-4 bottom-4 text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="edit-2" size={14}/></button>
                                                    </div>
                                                </div>
                                            ))}
                                    </div>
                                </div>
                            )}

                            {/* 已結算 明細卡片 */}
                            {activeTab === 'realized' && (
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    {portfolio.realizedStocks.map(stock => (
                                        <div key={stock.code} className="bg-white rounded-xl shadow-lg border border-slate-200 p-0 overflow-hidden flex flex-col">
                                            <div className="bg-slate-100 px-5 py-3 border-b border-slate-200 flex justify-between items-center">
                                                <div>
                                                    <div className="text-xs text-slate-400 font-bold">{stock.code}</div>
                                                    <div className="text-xl font-bold text-slate-700">{stock.name}</div>
                                                </div>
                                                <div className={`text-2xl font-black font-mono ${getColor(stock.totalPL)}`}>
                                                    {stock.totalPL > 0 ? '+' : ''}{formatMoney(stock.totalPL)}
                                                </div>
                                            </div>
                                            <div className="p-5 space-y-3 text-sm">
                                                <div className="flex justify-between border-b border-slate-50 pb-2">
                                                    <span className="text-slate-400">操作期間</span>
                                                    <span className="font-mono font-bold text-slate-600">{stock.buyPeriod}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">總成本</span>
                                                    <span className="font-mono">{formatMoney(stock.totalCost)}</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">總張數</span>
                                                    <span className="font-mono">{stock.totalQty/1000} 張</span>
                                                </div>
                                                <div className="flex justify-between">
                                                    <span className="text-slate-400">平均賣價</span>
                                                    <span className="font-mono font-bold text-blue-600">{formatDecimal(stock.avgSellPrice)}</span>
                                                </div>
                                                <div className="flex justify-between pt-2 border-t border-slate-100">
                                                    <span className="text-slate-400">獲利率</span>
                                                    <span className={`font-bold ${getColor(stock.totalPL)}`}>
                                                        {((stock.totalPL / stock.totalCost) * 100).toFixed(2)}%
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<StockBillStrong />);
    </script>
</body>
</html>
